import{_ as d,r,o,c as t,a as e,b as a,d as i,w as s,e as n}from"./app-9c912ed0.js";const c={},p=n(`<h2 id="调试环境" tabindex="-1"><a class="header-anchor" href="#调试环境" aria-hidden="true">#</a> 调试环境</h2><p>IDA版本：<em>7.0</em></p><ul><li><p>进入IDA软件的数据路径 <em>ida.app/Contents/MacOS/dbgsrv</em><br><strong>注意：</strong> 根据so文件目录判断目标文件位数，v7a - 32位，v8是64位。使用不同的位数的ida进行调试</p></li><li><p>将文件夹内对应位数的android server文件传入手机</p></li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>adb push android_server /data/local/tmp/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>进入手机，运行android server</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 进入手机 - 多台设备使用时使用-s参数设备名</span>
adb shell
<span class="token comment"># 切换管理员 - 才能进入tmp目录</span>
<span class="token function">su</span>
<span class="token comment"># 进入android server所在目录</span>
<span class="token builtin class-name">cd</span> /data/local/tmp/
<span class="token comment"># 给予android server最高权限</span>
<span class="token function">chmod</span> <span class="token number">777</span> android_server
<span class="token comment"># 运行android server 指定端口需要携带参数-p且无空格，例如\`-p23456\`</span>
./android_server
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>将android server端口转发（需要使用新端口）</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 将PC上的23946与手机23946建立转发</span>
<span class="token comment"># 参数中前者为local(PC端口) 后者为remote(手机端口)</span>
adb forward tcp:23946 tcp:23946

<span class="token comment"># 查看已转发端口</span>
adb forward <span class="token parameter variable">--list</span>
<span class="token comment"># 取消转发（填写PC端口）</span>
adb forward <span class="token parameter variable">--remove</span> tcp:11111
adb forward —-remove-all
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上准备工作完成后便可通过IDA进行调试<br> 一般情况下会将android server进行重命名，并自定义端口号运行。防止app进行进程名与默认端口号检测</p><h2 id="动态调试" tabindex="-1"><a class="header-anchor" href="#动态调试" aria-hidden="true">#</a> 动态调试</h2><p>动态调试分为 Debug调试 与 普通调试。其中IDA调试栏选项的attach与run分别对应 附加进程 与 新建进程</p><h3 id="debug调试" tabindex="-1"><a class="header-anchor" href="#debug调试" aria-hidden="true">#</a> Debug调试</h3><p>脱壳或反调试时常用此方法</p><ul><li><p>挂起程序</p><ul><li>手机打开目标程序</li><li>依次打开 <em>IDA -&gt; Go -&gt; Debugger -&gt; Attach -&gt; Remote ARMLinux/Android debugger</em></li><li>填写监听地址。由于端口转发到本机，Host填写<code>127.0.0.1</code>，Port填写转发到主机的端口后点击OK，弹出手机进程列表</li><li>选择目标程序的运行进程，点击OK，完成<strong>进程附加</strong></li></ul></li><li><p>加载目标SO文件</p><ul><li>依次打开 <em>Debugger -&gt; Debugger options...</em></li><li>勾选三项 <ul><li>Suspend on process entry point (进程入口点挂起)</li><li>Suspend on thread start/exit (创建与退出线程时挂起)</li><li>Suspend on library load/unload (加载与卸载库时挂起)</li></ul></li><li>启动程序，图形按钮 或 快捷键F9</li><li>等待目标so库加载请求的弹窗，关闭后在Module窗口中搜索目标so库，在目标so中搜索目标函数或JNI_Onload，双击后下断点。再F9运行</li></ul></li></ul><h3 id="普通调试" tabindex="-1"><a class="header-anchor" href="#普通调试" aria-hidden="true">#</a> 普通调试</h3><ul><li><p>挂起程序</p><ul><li>通过jadx-gui打开app，在 <em>Resources -&gt; AndroidManifest.xml</em>（配置清单）中查找make launch（搜索LAUNCHER），找到activity中的<code>android:name=</code>，得到app的包名+类名</li><li>使用命令挂起程序</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>adb shell am start <span class="token parameter variable">-D</span> <span class="token parameter variable">-n</span> <span class="token operator">&lt;</span>packageName<span class="token operator">&gt;</span>/.<span class="token operator">&lt;</span>className<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>执行完成后手机弹窗 <em>Waiting For Debugger</em></li></ul></li><li><p>得到程序端口：打开DDMS窗口，debug图标(红色的bug)会出现在目标进程前，记录目标程序运行的端口号<code>&lt;port&gt;</code></p></li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>ddms
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><p>依次打开 <em>IDA -&gt; Go -&gt; Debugger -&gt; Attach -&gt; Remote ARMLinux/Android debugger</em>。填写监听地址 <em>127.0.0.1+转发端口</em>。</p></li><li><p>选择目标程序的进行进程。勾选三项后F9让程序进入运行状态，此步骤与Debug调试一致</p></li><li><p>目标程序跳过ddms断点继续运行，此处端口为ddms端口</p></li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>jdb <span class="token parameter variable">-connect</span> com.sun.jdi.SocketAttach:hostname<span class="token operator">=</span><span class="token number">127.0</span>.0.1 <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token operator">&lt;</span>port<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>此时ddms窗口中红色debug图标变为绿色，且ida可正常弹窗即将加载的so库，跳过弹窗使其正常加载。如需调试<code>JNI_OnLoad</code>或静态注册函数<code>Java_*</code>，先在函数中F2下断点后再F9运行<br></p><p><strong>问题：</strong></p><ul><li>打不开DDMS的办法 <ul><li>adb shell ps 得到进程PID<code>&lt;pid&gt;</code></li><li><code>adb forward tcp:xxx jdwp:&lt;pid&gt;</code></li><li>执行jdb</li></ul></li><li>调试时触发反调试或其他原因导致崩溃时重新调试 <ul><li>从挂起程序开始</li><li><code>adb shell am start -D -n ...</code></li><li>重新启动IDA并附加</li><li>勾选三项后F9</li><li>查看ddms中app端口是否变化</li><li>进行放手操作<code>jdb -connect ...</code></li></ul></li></ul><h2 id="调试jni-onload" tabindex="-1"><a class="header-anchor" href="#调试jni-onload" aria-hidden="true">#</a> 调试JNI_OnLoad</h2><ul><li>在右侧Modules窗口中搜索目标so文件</li><li>双击查看so中的函数，找到JNI_OnLoad。在汇编指令区F2下断点</li><li>取消三项勾选，使so正常运行不被非断点打断</li><li>F9运行</li></ul><h2 id="动态调试时修改寄存器" tabindex="-1"><a class="header-anchor" href="#动态调试时修改寄存器" aria-hidden="true">#</a> 动态调试时修改寄存器</h2><p>在条件判断时，常需要手动修改寄存器的值。例如 反调试检测、会员检测 等，不符合条件会触发分支逻辑</p><div class="language-assembly line-numbers-mode" data-ext="assembly"><pre class="language-assembly"><code>CMP RO 0
BNE sub_xxx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>通过在 寄存器窗口双击 或 快捷键<code>E</code> 进行修改</p><h2 id="动态调试时修改指令" tabindex="-1"><a class="header-anchor" href="#动态调试时修改指令" aria-hidden="true">#</a> 动态调试时修改指令</h2>`,29),u=e("strong",null,"需在程序执行到前三条处指令前就完成对目标指令的修改",-1),m=e("ul",null,[e("li",null,"hex窗口中找到目标指令: 在执行到前三条时通过PC定位目标指令(选中目标指令 -> hex窗口右键 -> Synchronize with -> IDA View-PC)"),e("li",null,[a("修改指令: 在hex窗口中快捷键F2进行编辑。编辑完成后使用快捷键F2进行保存。常改为全0使其变成"),e("code",null,"NOP")]),e("li",null,"指令机器码计算: 查询《ARM指令》进行计算 或 使用https://armconverter.com/ ，输入目标指令和目标指令地址")],-1),b=e("p",null,[a("ARM指令共32位（4字节）从高位到低位依次查询ARM指令。以跳转指令"),e("code",null,"B"),a("为例说明计算方式")],-1),h=e("li",null,[a("4位(32-28): 条件。指令是否含有条件，如"),e("code",null,"BNE"),a("中的"),e("code",null,"NE")],-1),v=e("li",null,[a("3位(27-25): 固定为"),e("code",null,"101")],-1),g=e("li",null,[a("1位(24): 是否带链接，如"),e("code",null,"BL"),a("中的"),e("code",null,"L")],-1),_=e("code",null,"( <目标地址> - PC ) / 4(单条指令4字节) ",-1),x=n(`<div class="language-assembly line-numbers-mode" data-ext="assembly"><pre class="language-assembly"><code>00001BD0  0B 00 00 0A  BEQ loc_1c04
; 偏移量为(0x1c04 - (0x1BD0+8)) / 4 = 11条 = 1011
; 0000 101 0 000000000000000000001011 -&gt; 0A00000B -&gt; 0B 00 00 0A (小端存放)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="关于ida调试时的几点" tabindex="-1"><a class="header-anchor" href="#关于ida调试时的几点" aria-hidden="true">#</a> 关于IDA调试时的几点</h2><ul><li><p>断点的实现：在断点处设置一个异常，调试器对其进行捕获，从而使程序暂停到断点处</p></li><li><p>勾选三项后的弹窗：找不到so的map文件（找不到so的调试符号信息，详情搜索调试符号），点击取消即可，不影响后期调试</p></li><li><p>寄存器或CPSR中的值若为黑色，则说明指令执行后对应空间内存储的值未发生改变。否则为蓝色</p></li><li><p>调试快捷键</p><ul><li>F2: 下断点</li><li>F4: 执行至光标处</li><li>F7: 单步执行</li><li>F9: 继续运行</li><li>寄存器快捷键E - 修改寄存器值</li><li>Ctrl + N: 设置PC</li></ul></li><li><p>关于汇编代码区颜色：</p><ul><li>黑色：可识别（可Tab得到C语言伪代码）</li><li>红色：不可识别</li></ul></li><li><p>代码区常用快捷键</p><ul><li>Tab：得到伪代码</li><li>D：选中代码识别成数据</li><li>U：选中代码识别成未识别数据</li><li>P：选中代码识别成函数（代码块）</li><li>C：选中代码识别成指令（行代码）因此经常先转化成代码（C）再将多条代码转化成函数（P）</li></ul></li></ul><h2 id="动态调试时的cpsr窗口" tabindex="-1"><a class="header-anchor" href="#动态调试时的cpsr窗口" aria-hidden="true">#</a> 动态调试时的CPSR窗口</h2><p>对IDA动态调试时常用CPSR标识位的说明</p><ul><li>N : 计算结果是否为负数</li><li>Z : 计算结果是否为0</li><li>C : 数值运算时是否出现进位或错位</li><li>T : 当前是否为Thumb指令集</li></ul><h2 id="调试可执行程序" tabindex="-1"><a class="header-anchor" href="#调试可执行程序" aria-hidden="true">#</a> 调试可执行程序</h2><p>初始流程与调试apk一致，运行android_server，启动端口转发</p><ul><li><p>点击菜单栏 <em>Debugger -&gt; Run -&gt; Remote ARMLinux/Android debugger</em></p></li><li><p><em>Application</em> 填写可执行文件的路径绝对路径</p></li><li><p><em>Directory</em> 填写可执行文件所在文件夹的绝对路径</p></li><li><p><em>Parameters</em> 填写可执行文件的运行参数。没有参数留空</p></li><li><p><em>Hostname</em> 127.0.0.1</p></li><li><p><em>Post</em> android_server转发端口</p></li><li><p>依次打开 <em>Debugger -&gt; Debugger options...</em> ，勾选三项</p></li></ul><p>更多内容查看后续IDA相关的文章</p>`,10);function k(A,D){const l=r("RouterLink");return o(),t("div",null,[p,e("p",null,[a("由于"),i(l,{to:"/detail/011.html#%E4%B8%89%E7%BA%A7%E6%B5%81%E6%B0%B4%E7%BA%BF"},{default:s(()=>[a("# 三级流水线")]),_:1}),a("的存在， "),u]),m,b,e("ul",null,[h,v,g,e("li",null,[a("余下24位(23-0): 目标地址与该指令的相对偏移量（相差多少条指令），即 "),_,a("。由于"),i(l,{to:"/detail/011.html#%E4%B8%89%E7%BA%A7%E6%B5%81%E6%B0%B4%E7%BA%BF"},{default:s(()=>[a("# 三级流水线")]),_:1}),a("，PC值比当前执行的指令多两条指令(即指令地址+8)")])]),x])}const B=d(c,[["render",k],["__file","010.html.vue"]]);export{B as default};
