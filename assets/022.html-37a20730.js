import{_ as c,r as i,o as e,c as o,a as n,b as s,d as p,e as a}from"./app-b4e62751.js";const l={},u={href:"https://juejin.cn/post/7019155025666506788",target:"_blank",rel:"noopener noreferrer"},k=a(`<h2 id="常量混淆" tabindex="-1"><a class="header-anchor" href="#常量混淆" aria-hidden="true">#</a> 常量混淆</h2><p>对代码中的常量进行混淆，如字符串，布尔值，数字等，是 js 中最基本的混淆。可配合一些手段，增加常量的出现，从而使常量混淆的生效范围变大</p><h3 id="字符串常量混淆" tabindex="-1"><a class="header-anchor" href="#字符串常量混淆" aria-hidden="true">#</a> 字符串常量混淆</h3><p>使用编码或加密函数对字符串常量进行混淆。<strong>注意，尽量少使用系统内置函数，如 <code>atob</code> 等，推荐尽量自己实现。内置函数容易被 jsHook，从而定位到关键内容</strong></p><h4 id="ascii-码混淆" tabindex="-1"><a class="header-anchor" href="#ascii-码混淆" aria-hidden="true">#</a> ascii 码混淆</h4><ul><li><p>ascii 码相关 api</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 字符转ascii码</span>
<span class="token operator">&lt;</span>字符串<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>索引<span class="token operator">&gt;</span><span class="token punctuation">)</span>  <span class="token comment">// 获取字符串中指定索引字符对应的ascii码。10进制整形</span>

<span class="token comment">// ascii整形转字符串</span>
String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>int<span class="token punctuation">,</span> int<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span>  <span class="token comment">// 将传入的多个ascii码数字转为字符串</span>
String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 使用apply以数组方式调用。无调用对象，参数可使用数组形式</span>
                              
<span class="token comment">// 使用构造函数进一步混淆</span>
<span class="token string">&quot;a&quot;</span><span class="token punctuation">[</span><span class="token string">&quot;constructor&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;fromCharCode&quot;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 使用字符串对象的构造函数引用 function String</span>
window<span class="token punctuation">[</span><span class="token string">&quot;String&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;fromCharCode&quot;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 使用 window 引用 function String</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>字符串常量转 ascii 码字符串以降低代码可读性。如 <code>\\x27</code> 表示字符 <code>&#39;</code>。转换代码如下，注意此处的转义问题</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">str2ascii</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
  <span class="token comment">// 字符串不能直接调用forEach，使用 call 方法让字符串调用  forEach</span>
  <span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>  <span class="token comment">// \`[\` 开头，需要分号</span>
    str<span class="token punctuation">,</span> <span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>res <span class="token operator">+=</span> <span class="token string">&quot;\\\\x&quot;</span> <span class="token operator">+</span> str<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h4 id="unicode-编码混淆" tabindex="-1"><a class="header-anchor" href="#unicode-编码混淆" aria-hidden="true">#</a> unicode 编码混淆</h4><p>如字符串 <code>aaa</code> 转为unicode字符串 <code>&#39;\\u0061\\u0061\\u0061&#39;</code>。相比ascii码的转换内容范围大（支持中文）</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">str2unicode</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> str<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res <span class="token operator">+=</span> <span class="token string">&quot;\\\\u&quot;</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">&#39;0&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 补齐4位</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>标识符可以使用unicode。在之前介绍过，类形式获取对象属性支持中文。同样，类形式获取属性可使用unicode，不论是否为中文。此时为标识符混淆。例如</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>a <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">aaa</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span>
a<span class="token punctuation">.</span>aaa  <span class="token comment">// 输出 1</span>
a<span class="token punctuation">.</span>\\u0061\\u0061\\u0061  <span class="token comment">// 输出 1</span>
\\u0061<span class="token punctuation">.</span>\\u0061\\u0061\\u0061  <span class="token comment">// 输出 1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ascii-unicode-编码去混淆" tabindex="-1"><a class="header-anchor" href="#ascii-unicode-编码去混淆" aria-hidden="true">#</a> ascii / unicode 编码去混淆</h4><p>此处还包含数字常量编码的解混淆。遍历数字与字符串字面量，进行特征判断，对满足特征的字面量进行处理</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> simplifyLiteral <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 访问所有数字字面量节点 {node} 参数是对象时，取对象中的node属性</span>
    <span class="token function">NumericLiteral</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>node<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// node.extra.raw 保存了代码中字面量的原始字符串形式，例如 &quot;0xff&quot;</span>
        <span class="token comment">// node.value 则是它实际的数值，例如 255</span>
        <span class="token comment">// 这行代码检查原始字符串是否以 &quot;0o&quot; (八进制), &quot;0b&quot; (二进制), 或 &quot;0x&quot; (十六进制) 开头</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>extra <span class="token operator">&amp;&amp;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^0[obx]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>extra <span class="token operator">=</span> <span class="token keyword">undefined</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 访问所有字符串字面量节点</span>
    <span class="token function">StringLiteral</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>node<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 同样，检查字符串的原始形式是否包含转义序列，如 \\uXXXX (unicode) 或 \\xXX (ascii)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>extra <span class="token operator">&amp;&amp;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\\\[ux]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gi</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>extra<span class="token punctuation">.</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 将 extra 设置为 undefined，Babel 在生成代码时会</span>
            <span class="token comment">// 将 &quot;\\x48\\x65\\x6c\\x6c\\x6f&quot; 转换成它所代表的实际字符串 &quot;Hello&quot;</span>
            node<span class="token punctuation">.</span>extra <span class="token operator">=</span> <span class="token keyword">undefined</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> simplifyLiteral<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="对象属性访问方式" tabindex="-1"><a class="header-anchor" href="#对象属性访问方式" aria-hidden="true">#</a> 对象属性访问方式</h4><p>通过修改对象属性访问方式，可增加代码中的字符串常量，利于字符串混淆</p>`,16),r=a(`<li><p>访问方式介绍：在 js 中，对象属性访问方式有两种</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">People</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
<span class="token punctuation">}</span>
<span class="token class-name">People</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">introduce</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">Hi, I&#39;m </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">People</span><span class="token punctuation">(</span><span class="token string">&#39;Otto&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// 以类形式获取属性</span>
<span class="token comment">// 支持中文属性 例如 a = {&#39;我&#39;: 1}  a.我 // 输出1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Otto</span>
p<span class="token punctuation">.</span><span class="token function">introduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Hi, I&#39;m Otto.</span>
<span class="token comment">// 节点结构</span>
Node <span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;MemberExpression&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">object</span><span class="token operator">:</span> Node <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">// 拥有属性的对象</span>
  <span class="token literal-property property">computed</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// 类形式时，该为 false</span>
  <span class="token literal-property property">property</span><span class="token operator">:</span> Node <span class="token punctuation">{</span>  <span class="token comment">// 属性为标识符节点</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;Identifier&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;prop1&#39;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 通过 hash 表方式访问对象的属性</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Otto</span>
p<span class="token punctuation">[</span><span class="token string">&#39;introduce&#39;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hi, I&#39;m Otto.</span>
<span class="token comment">// 节点结构</span>
Node <span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;MemberExpression&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">object</span><span class="token operator">:</span> Node <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">computed</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// hash表形式时，该为 true</span>
  <span class="token literal-property property">property</span><span class="token operator">:</span> Node <span class="token punctuation">{</span>  <span class="token comment">// 属性为字符串字面量节点</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;StringLiteral&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">extra</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&#39;prop2&#39;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>修改对象属性访问方式。hash 表方式访问对象属性明显增加代码中字符串出现频率</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 通过节点结构可知，共两处修改点</span>
<span class="token comment">// 修改点1: computed - 将 a.b 修改为 a[b]</span>
<span class="token comment">// 修改点2: Identifier 节点修改为 StringLiteral  将 a[b] 修改为 a[&#39;b&#39;]</span>

<span class="token comment">// 遍历成员表达式</span>
<span class="token function">MemberExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 定位 property 是标识符的节点</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>property<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 修改为 StringLiteral 节点。用属性名构造字符串</span>
    path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>property <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>preperty<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>computed <span class="token operator">=</span> <span class="token boolean">true</span>  <span class="token comment">// computed 改为 true</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>`,2),d={href:"https://lzc6244.github.io/2021/08/02/Babel%E5%B0%86a-'bb'-%E8%BD%AC%E6%8D%A2%E4%B8%BAa.bb.html",target:"_blank",rel:"noopener noreferrer"},v=a(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">MemberExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> computed <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">.</span>node
  <span class="token comment">// 获取 path property 子路径</span>
  <span class="token keyword">const</span> property <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;property&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>computed <span class="token operator">&amp;&amp;</span> types<span class="token punctuation">.</span><span class="token function">isStringLiteral</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    property<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span>node<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
    path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>computed<span class="token operator">=</span><span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),m=a(`<h4 id="标准内置对象" tabindex="-1"><a class="header-anchor" href="#标准内置对象" aria-hidden="true">#</a> 标准内置对象</h4><p>将标准内置对象如 <code>Date</code>/<code>Math</code> 等, 通过 <code>window</code> 进行访问（ <code>window[&#39;Date&#39;]</code> ），增加了字符串出现频率，利于字符串混淆，且进行了 <code>window</code> 对象检测</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&#39;|eval|paresInt|encodeURIComponent|Object|Function|Boolean|Number|Math|Date|String|RegExp|Array|&#39;</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">|</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">|</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 两边加上 \`|\` ， 放置变量名 &#39;a&#39; 等子字符串判断异常异常</span>
    path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>  <span class="token comment">// 替换为成员表达式</span>
      t<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>  <span class="token comment">// 构建成员表达式 传入对象，属性（字符串或标识符等），computed</span>
        t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&#39;window&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token boolean">true</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="数字常量混淆" tabindex="-1"><a class="header-anchor" href="#数字常量混淆" aria-hidden="true">#</a> 数字常量混淆</h3><p>一些数字具有一定的特征，例如：</p><ul><li><p>MD5中的常量 4个幻数</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>A: 0x67452301
B: 0xefcdab89
C: 0x98badcfe
D: 0x10325476

A: 1732584193
B: 4023233417
C: 2562383102
D: 271733878
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>SHA1中的幻数</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token class-name">uint32_t</span> H0 <span class="token operator">=</span> <span class="token number">0x67452301</span><span class="token punctuation">;</span>   <span class="token comment">// 0x01, 0x23, 0x45, 0x67</span>
<span class="token class-name">uint32_t</span> H1 <span class="token operator">=</span> <span class="token number">0xEFCDAB89</span><span class="token punctuation">;</span>   <span class="token comment">// 0x89, 0xAB, 0xCD, 0xEF</span>
<span class="token class-name">uint32_t</span> H2 <span class="token operator">=</span> <span class="token number">0x98BADCFE</span><span class="token punctuation">;</span>   <span class="token comment">// 0xFE, 0xDC, 0xBA, 0x98</span>
<span class="token class-name">uint32_t</span> H3 <span class="token operator">=</span> <span class="token number">0x10325476</span><span class="token punctuation">;</span>   <span class="token comment">// 0x76, 0x54, 0x32, 0x10</span>
<span class="token class-name">uint32_t</span> H4 <span class="token operator">=</span> <span class="token number">0xC3D2E1F0</span><span class="token punctuation">;</span>   <span class="token comment">// 0xF0, 0xE1, 0xD2, 0xC3</span>

<span class="token comment">/* 前4个数字与MD5幻数一致
A: 1732584193
B: 4023233417
C: 2562383102
D: 271733878
E: 3285377520
*/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>通过这些特征，可以迅速确定关键逻辑</p><p>因此需要对数字常量进行混淆。常用的混淆手段如下</p>`,8),b=n("li",null,[n("p",null,[s("对数字进行进制转换。进制转换的去混淆代码见 "),n("a",{href:"#ascii-unicode-%E7%BC%96%E7%A0%81%E5%8E%BB%E6%B7%B7%E6%B7%86"},"# ascii / unicode 编码去混淆")])],-1),f={class:"MathJax",jax:"SVG",style:{direction:"ltr",position:"relative"}},g={style:{overflow:"visible","min-height":"1px","min-width":"1px","vertical-align":"-0.188ex"},xmlns:"http://www.w3.org/2000/svg",width:"8.93ex",height:"1.758ex",role:"img",focusable:"false",viewBox:"0 -694 3947 777","aria-hidden":"true"},h=a('<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z" style="stroke-width:3;"></path></g><g data-mml-node="mo" transform="translate(651.2,0)"><path data-c="2295" d="M56 250Q56 394 156 488T384 583Q530 583 626 485T722 250Q722 110 625 14T390 -83Q249 -83 153 14T56 250ZM364 542Q308 539 251 509T148 418T96 278V270H369V542H364ZM681 278Q675 338 650 386T592 462T522 509T458 535T412 542H409V270H681V278ZM96 222Q104 150 139 95T219 12T302 -29T366 -42H369V230H96V222ZM681 222V230H409V-42H412Q429 -42 456 -36T521 -10T590 37T649 113T681 222Z" style="stroke-width:3;"></path></g><g data-mml-node="mi" transform="translate(1651.4,0)"><path data-c="1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z" style="stroke-width:3;"></path></g><g data-mml-node="mo" transform="translate(2362.2,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z" style="stroke-width:3;"></path></g><g data-mml-node="mi" transform="translate(3418,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z" style="stroke-width:3;"></path></g></g></g>',1),y=[h],w=n("mjx-assistive-mml",{unselectable:"on",display:"inline",style:{top:"0px",left:"0px",clip:"rect(1px, 1px, 1px, 1px)","-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",position:"absolute",padding:"1px 0px 0px 0px",border:"0px",display:"block",width:"auto",overflow:"hidden"}},[n("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[n("mi",null,"b"),n("mo",null,"⊕"),n("mi",null,"c"),n("mo",null,"="),n("mi",null,"a")])],-1),x=n("code",null,"0xC3D2E1F0 ^ 0x12345678 = 0xD1E6B788",-1),j=n("code",null,"0xD1E6B788 ^ 0x12345678",-1),E=n("code",null,"0xC3D2E1F0",-1),_=n("code",null,"0x12345678",-1),S=a(`<ul><li><p>混淆算法：遍历 <code>NumericLiteral</code> ，其 <code>value</code> 为对应数字常量的值。将一随机数作为 sercet，所有常量与其异或得到值记为 payload。此时可将 <code>NumericLiteral</code> 替换为 payload 异或 secret 的 <code>binaryExpress</code></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">NumericLiteral</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> value <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">999999</span><span class="token operator">-</span><span class="token number">100000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 生成 [100000, 999998] 的整数</span>
  <span class="token keyword">const</span> payload <span class="token operator">=</span> value <span class="token operator">^</span> secret<span class="token punctuation">;</span>
  path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>  <span class="token comment">// 替换为二项式</span>
    t<span class="token punctuation">.</span><span class="token function">binaryExpression</span><span class="token punctuation">(</span>  <span class="token comment">// 构建二项式，传入 操作符、左节点（加密数字）、右节点（密钥）</span>
      <span class="token string">&#39;^&#39;</span><span class="token punctuation">,</span>
      t<span class="token punctuation">.</span><span class="token function">numericLiteral</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
      t<span class="token punctuation">.</span><span class="token function">numericLiteral</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// 替换后会生成新的 NumericLiteral 因此跳过防止死循环 - 新节点内子节点类型与遍历类型相同</span>
  path<span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Tips:</strong> 关于是否使用 <code>path.skip()</code></p><ul><li><strong>当一个节点被替换后，遍历器认为这是一个全新的子树，需要从头开始访问</strong></li><li>当<strong>替换后的新节点（或其子节点中）包含</strong>了会被当前访问者（Visitor）再次捕获的<strong>节点类型</strong>时，就需要使用 <code>path.skip()</code></li></ul></li></ul>`,1),B=a(`<h3 id="数组混淆" tabindex="-1"><a class="header-anchor" href="#数组混淆" aria-hidden="true">#</a> 数组混淆</h3><p>使用数组方式，将代码中的常量放入数组，代码原本的常量位置，使用索引从数组中获取常量的值</p><ul><li><p>代码示例</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;atob&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;RGF0ZQ==&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 数组中可以包含各种类型</span>
<span class="token keyword">var</span> self <span class="token operator">=</span> window<span class="token punctuation">;</span>
<span class="token keyword">var</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">self</span><span class="token punctuation">[</span> self<span class="token punctuation">[</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// self[ self[&#39;atob&#39;](&#39;RGF0ZQ==&#39;) ]()</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>数组位移：为了使解密时，索引不能直接进行使用，通常会配合位移函数</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 右移</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> <span class="token function-variable function">shuffer</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">nums</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">--</span>nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      arr<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">shuffer</span><span class="token punctuation">(</span><span class="token operator">++</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">0x2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 左移</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> <span class="token function-variable function">shuffer</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">nums</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">--</span>nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">shuffer</span><span class="token punctuation">(</span><span class="token operator">++</span>num<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">0x2</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>混淆代码：将常量抽离到数组中。通过索引进行引用。额外生成一个数组，将字符串字面量 push 进数组，并获取当前 push 的索引，将原处进行替换</p><ul><li>字符串常量转换为 <code>atob(arr[0])</code> ( <code>callExpression</code> 内为 <code>memberExpress</code>)<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 数组</span>
<span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment">// 常量替换</span>
<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">StringLiteral</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> b64str <span class="token operator">=</span> <span class="token function">btoa</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>value<span class="token punctuation">)</span>  <span class="token comment">// btoa 得到base64字符串</span>
    <span class="token keyword">let</span> index
    <span class="token comment">// 判断当前值是否已经存在于数组中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>b64str<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 不存在，添加</span>
      <span class="token keyword">const</span> len <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>b64str<span class="token punctuation">)</span>  <span class="token comment">// push 函数返回添加完成后的数组长度</span>
      index <span class="token operator">=</span> len <span class="token operator">-</span> <span class="token number">1</span>  <span class="token comment">// 新元素是数组最后一个</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 已存在，获取当前的索引</span>
      index <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>b64str<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>  <span class="token comment">// 替换为 \`callExpression\`，内层为 \`memberExpress\`</span>
      t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>  <span class="token comment">// 构建调用表达式，传入 callee(函数名)，arguments(参数数组)</span>
        t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&#39;atob&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>  <span class="token comment">// 构建成员表达式</span>
          t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&#39;arr&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          t<span class="token punctuation">.</span><span class="token function">numericLiteral</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token boolean">true</span>
        <span class="token punctuation">)</span><span class="token punctuation">]</span>  
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 数组放入代码</span>
arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">i</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 构造数组内的字符串常量节点</span>
arr <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">variableDeclarator</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&#39;arr&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">arrayExpression</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 数组初始化节点</span>
arr <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">variableDeclaration</span><span class="token punctuation">(</span><span class="token string">&#39;var&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>arr<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">// 数组声明节点</span>
ast<span class="token punctuation">.</span>program<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>  <span class="token comment">// 放入代码最开始</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>数组位移。使用 <code>pop</code> + <code>unshift</code> 或 <code>shift</code> + <code>push</code> 对数组进行位移。使逆向者还原时，不能直接使用下标得到对应值替换<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">i</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 数组内容左移进行混淆 - 此处注意函数形参的变量名不要与外部数组一致</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ar<span class="token punctuation">,</span> num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> <span class="token function-variable function">shuffer</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">nums</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">--</span>nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ar<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>ar<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">shuffer</span><span class="token punctuation">(</span><span class="token operator">++</span>num<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">0x1</span><span class="token punctuation">)</span>

<span class="token comment">// 代码内通过右移还原数组 - 此处注意函数形参变量名不要与外部数组一致</span>
<span class="token keyword">const</span> arrShiftCode <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">
(function(ar, num) {
  var shuffer = function(nums) {
    while(--nums) {
      ar.unshift(ar.pop())
    }
  }
  shuffer(++num)
})(arr, 0x1)
</span><span class="token template-punctuation string">\`</span></span>
<span class="token keyword">const</span> shiftAst <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>arrShiftCode<span class="token punctuation">)</span>  <span class="token comment">// 数组位移代码解析为ast</span>
ast<span class="token punctuation">.</span>program<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>shiftAst<span class="token punctuation">)</span>   <span class="token comment">// 将代码放入最开始</span>
<span class="token comment">// 在位移代码上方再放入位移后的数组代码</span>
arr <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">variableDeclarator</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&#39;arr&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">arrayExpression</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span>
arr <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">variableDeclaration</span><span class="token punctuation">(</span><span class="token string">&#39;var&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>arr<span class="token punctuation">]</span><span class="token punctuation">)</span>
ast<span class="token punctuation">.</span>program<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>数组位移代码混淆：由于不能使用数组混淆的方式混淆数组位移代码自己（为了保证数组位移顺利执行）。对该位移源码使用字符编码进行混淆<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 只对数组位移的代码进行混淆</span>
<span class="token keyword">const</span> shiftAst <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>arrShiftCode<span class="token punctuation">)</span>  <span class="token comment">// 数组位移代码解析为ast</span>
<span class="token function">traverse</span><span class="token punctuation">(</span>shiftAst<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">MemberExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>property<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> name <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>property<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>property <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token function">str2ascii</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 改为hash表方式形式，并使用ascii混淆，unicode混淆同理</span>
    <span class="token punctuation">}</span>
    path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>computed <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 此时代码字符串中的 \`\\\\\` 变更为可转义的 ascii 码</span>
code <span class="token operator">=</span> code<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\\\\\\\x</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&#39;\\\\x&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p>OB混淆：常用数组混淆配合解密函数，使用解密函数传入指定参数获取数组中的常量值。以下是一个示例</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 数组封装为一个函数</span>
<span class="token keyword">function</span> <span class="token function">o</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> <span class="token constant">I8</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;UjVkF&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;fromCharCode&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;uKuSb&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;kClGo&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;lCntN&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;3|5|4|2|1|0&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;oEyoT&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;yZwGd&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;c&#39;</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function-variable function">o</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">I8</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">o</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 解密函数</span>
<span class="token keyword">function</span> <span class="token constant">B</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">A</span><span class="token punctuation">,</span> s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> m <span class="token operator">=</span> <span class="token function">o</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这里的 m 接收了 o() 函数返回的初始字符串数组</span>
    <span class="token function-variable function">B</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">Q</span><span class="token punctuation">,</span> <span class="token constant">G</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 关键：B 函数在这里被重新定义了 - 混淆常用技巧</span>
        <span class="token constant">Q</span> <span class="token operator">=</span> <span class="token constant">Q</span> <span class="token operator">-</span> <span class="token number">0x18a</span><span class="token punctuation">;</span> <span class="token comment">// 对传入的索引进行偏移</span>
        <span class="token keyword">var</span> c <span class="token operator">=</span> m<span class="token punctuation">[</span><span class="token constant">Q</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 从 m 数组中取出对应索引的值</span>
        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">B</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 递归调用自身，但这次是调用重新定义后的 B</span>
<span class="token punctuation">}</span>
<span class="token comment">// 左移</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">A</span><span class="token punctuation">,</span> s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// 数组函数 与 循环停止条件</span>
    <span class="token keyword">var</span> mb <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token constant">A</span><span class="token operator">:</span> <span class="token number">0x22c</span><span class="token punctuation">,</span>
        <span class="token literal-property property">s</span><span class="token operator">:</span> <span class="token number">0x337</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> ox <span class="token operator">=</span> <span class="token constant">B</span><span class="token punctuation">;</span>  <span class="token comment">// 获取指定索引偏移元素的函数</span>
    <span class="token keyword">var</span> m <span class="token operator">=</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 原始数组</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> <span class="token constant">Q</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">ox</span><span class="token punctuation">(</span><span class="token number">0x1b2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0x1</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">ox</span><span class="token punctuation">(</span>mb<span class="token punctuation">.</span><span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0x2</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">ox</span><span class="token punctuation">(</span><span class="token number">0x27b</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0x3</span> <span class="token operator">+</span> <span class="token operator">-</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">ox</span><span class="token punctuation">(</span><span class="token number">0x1db</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0x4</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">ox</span><span class="token punctuation">(</span>mb<span class="token punctuation">.</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0x5</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">ox</span><span class="token punctuation">(</span><span class="token number">0x268</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0x6</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">ox</span><span class="token punctuation">(</span><span class="token number">0x32d</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0x7</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">ox</span><span class="token punctuation">(</span><span class="token number">0x2d0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">Q</span> <span class="token operator">===</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 判断是否到达目标的第一个元素</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token comment">// 停止左移</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                m<span class="token punctuation">[</span><span class="token string">&#39;push&#39;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>m<span class="token punctuation">[</span><span class="token string">&#39;shift&#39;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token constant">G</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m<span class="token punctuation">[</span><span class="token string">&#39;push&#39;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>m<span class="token punctuation">[</span><span class="token string">&#39;shift&#39;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 执行条件时出现异常（即 parseInt ），依然进行位移</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> <span class="token number">0x7fdfa</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 数组函数 与 循环停止条件</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>去OB混淆：本例为全局解密函数的情况（只有一个数组解密函数），代码中前三部分是：数组声明，数组位移，解密函数。思路：通过eval执行解密函数及其涉及内容，使还原脚本可调用解密函数获取原文，进行替换</p><ul><li><p>加载解密函数</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 本例中解密函数为 _0x53b5 ，代码中大量出现 _0x53b5[0xXXX]</span>
<span class="token keyword">const</span> stringDecryptFuncAst <span class="token operator">=</span> ast<span class="token punctuation">.</span>program<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> stringDecryptFunName <span class="token operator">=</span> stringDecryptFuncAst<span class="token punctuation">.</span>declarations<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>name
<span class="token comment">// 创建一个 AST，将原代码中的三部分，加入到 body节点(数组声明，数组位移，解密函数)</span>
<span class="token keyword">const</span> newAst <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
newAst<span class="token punctuation">.</span>program<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>program<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
newAst<span class="token punctuation">.</span>program<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>program<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
newAst<span class="token punctuation">.</span>program<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>stringDecryptFuncAst<span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span><span class="token literal-property property">code</span><span class="token operator">:</span> stringDecryptFunc<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span>newAst<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">compact</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">// 压缩代码避免格式化检测</span>
<span class="token comment">// 通过eval使该环境做了数组声明，数组位移，字符串解密函数声明等操作</span>
<span class="token comment">// 执行后，此时该环境已拥有解密函数 _0x53b5</span>
<span class="token function">eval</span><span class="token punctuation">(</span>stringDecryptFunc<span class="token punctuation">)</span>
<span class="token comment">// 测试能否正常解密</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">_0x53b5</span><span class="token punctuation">(</span><span class="token string">&#39;0x15&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>替换字符串解密。通过解密函数的 <code>binding.referencePaths</code> 定位解密函数的全部调用处（避免同名函数的错误替换）</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 遍历变量定义处 - 解密函数为 VariableDeclarator</span>
  <span class="token function">VariableDeclarator</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name <span class="token operator">==</span> stringDecryptFunName<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 定位到解密函数的定义</span>
      <span class="token keyword">const</span> binding <span class="token operator">=</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">getBinding</span><span class="token punctuation">(</span>stringDecryptFunName<span class="token punctuation">)</span>  <span class="token comment">// 解密函数binding</span>
      <span class="token comment">// 引用解密函数标识符的地方 - Identifier 的 path 对象</span>
      binding <span class="token operator">&amp;&amp;</span> binding<span class="token punctuation">.</span>referencePaths<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 该解密函数标识符作为函数被调用了，则说明此处使用解密函数进行解密，需要进行替换</span>
        item<span class="token punctuation">.</span>parentPath<span class="token punctuation">.</span><span class="token function">isCallExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span>parentPath<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>
          t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>
            <span class="token comment">// 执行该解密函数调用，得到解密结果</span>
            <span class="token function">eval</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>parentPath <span class="token operator">+</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>  <span class="token comment">// 隐式转换为代码字符串后执行得到解密结果</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>已完成数组混淆处理，移除代码开头的 数组声明，数组位移，字符串解密 代码</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>ast<span class="token punctuation">.</span>program<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ast<span class="token punctuation">.</span>program<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ast<span class="token punctuation">.</span>program<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 本例使用的加密 js ，相关代码在代码头部</span>
<span class="token comment">// 根据情况移除。可手动移除代码，而不通过修改 ast 方式移除</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li></ul><h2 id="eval-混淆字符串常量与代码" tabindex="-1"><a class="header-anchor" href="#eval-混淆字符串常量与代码" aria-hidden="true">#</a> eval 混淆字符串常量与代码</h2><p>通过 <code>eval</code> 的常用混淆手段有如下两种</p><h3 id="eval-混淆字符串常量" tabindex="-1"><a class="header-anchor" href="#eval-混淆字符串常量" aria-hidden="true">#</a> eval 混淆字符串常量</h3><p>使用 <code>eval</code> 可执行解密函数，将编码或加密后的字符串常量还原。以下为混淆代码</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">StringLiteral</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>
    t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>  <span class="token comment">// 构建调用表达式，传入 callee(函数名)，arguments(参数数组)</span>
      t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&#39;atob&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token function">btoa</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment">// btoa 得到base64字符串</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 替换后会生成新的 StringLiteral 因此跳过防止死循环 - 新节点类型与遍历类型相同</span>
  path<span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="eval-混淆-js-代码" tabindex="-1"><a class="header-anchor" href="#eval-混淆-js-代码" aria-hidden="true">#</a> eval 混淆 js 代码</h3><p>eval 执行源码字符串，可增加代码中字符串出现频率，进而使用字符串常量混淆手段，对关键代码进行混淆。由于特征过于明显，一般只加密关键行，使逆向者无法通过在控制台内关键词搜索定位核心代码位置</p><ul><li><p>使用 <code>eval</code> 执行编码后的源码字符串</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">eval</span><span class="token punctuation">(</span><span class="token function">atob</span><span class="token punctuation">(</span><span class="token string">&#39;bmV3IHdpbmRvdy5EYXRlKCk=&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// btoa(&#39;new window.Date()&#39;)</span>

<span class="token comment">// res = [];</span>
<span class="token comment">//for (i = 0; i&lt; &#39;new window.Date()&#39;.length; i++) {</span>
<span class="token comment">//  res.push(&#39;new window.Date()&#39;.charCodeAt(i))}</span>
<span class="token function">eval</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">110</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">119</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">119</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">119</span><span class="token punctuation">,</span> <span class="token number">46</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">,</span> <span class="token number">116</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>通过其他一些函数，对代码字符串进行拼接，格式化后，得到原始代码，再通过 <code>eval</code> 执行（该示例的逻辑类似于vmp中的指令）</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">eval</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span>a<span class="token punctuation">,</span>c<span class="token punctuation">,</span>k<span class="token punctuation">,</span>e<span class="token punctuation">,</span>r</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    e<span class="token operator">=</span>String<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&#39;&#39;</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>String<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">while</span><span class="token punctuation">(</span>c<span class="token operator">--</span><span class="token punctuation">)</span>r<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token operator">=</span>k<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token operator">||</span>c<span class="token punctuation">;</span>k<span class="token operator">=</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> r<span class="token punctuation">[</span>e<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function-variable function">e</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span><span class="token string">&#39;\\\\w+&#39;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>c<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>c<span class="token operator">--</span><span class="token punctuation">)</span><span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span>p<span class="token operator">=</span>p<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">&#39;\\\\b&#39;</span><span class="token operator">+</span><span class="token function">e</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&#39;\\\\b&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;g&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>k<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> p
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">&#39;0.1(&quot;2&quot;);&#39;</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&#39;console|log|CC11001100&#39;</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;|&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 通过自执行函数，返回一个代码的明文字符串。加密逻辑通过自执行函数还原</span>
<span class="token punctuation">)</span>
<span class="token comment">// 此处使用的加密工具 https://jsrei.github.io/eval-decoder/</span>
<span class="token comment">// 此代码的原文 console.log(&quot;CC11001100&quot;);</span>
<span class="token comment">// 0.1(&quot;2&quot;); 按照 console|log|CC11001100 的索引进行替换</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>eval混淆代码：<strong>eval 混淆 js 代码时，需要在标识符混淆之后</strong>，保证被编码的代码字符串中涉及的标识符已存在</p><ul><li><p>eval-base64 混淆函数体：eval执行的base64编码的字符串</p><ul><li><p>全部代码行混淆</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 函数体混淆 FunctionExpression FunctionDeclaration</span>
<span class="token function">FunctionExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> blockStatement <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>body
  <span class="token comment">// 构造 eval 混淆的函数体</span>
  <span class="token keyword">const</span> statements <span class="token operator">=</span> blockStatement<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">line</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  <span class="token comment">// 遍历函数体中的每一行</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isReturnStatement</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// return 不能进行混淆</span>
      <span class="token keyword">return</span> line
    <span class="token keyword">const</span> <span class="token punctuation">{</span>code<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>
    <span class="token keyword">const</span> decrypt <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>  <span class="token comment">// 构建解混的调用表达式，传入调用函数与参数数组</span>
      t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&#39;atob&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token function">btoa</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment">// 参数为源码字符串混淆后的字符串</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">expressionStatement</span><span class="token punctuation">(</span>  <span class="token comment">// 构造新的行用于替换</span>
      t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>  <span class="token comment">// eval的调用表达式</span>
        t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&#39;eval&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>decrypt<span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">// 除了return，每一行都进行了eval混淆</span>
  path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;body&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span>statements<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 将整个函数体替换为混淆后的</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>部分代码行混淆：在目标行后增加注释 <code>eval-atob</code> 用于标记需要混淆的代码行</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 在目标行末添加指定注释</span>
<span class="token comment">// Node.trailingComments = [</span>
<span class="token comment">//   type: &#39;CommentLine&#39;,</span>
<span class="token comment">//   value: &#39;&#39; // 注释内容</span>
<span class="token comment">// ]</span>

<span class="token comment">// 遍历存在 ‘eval-atob’ 注释的行</span>
<span class="token function">FunctionExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> blockStatement <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">const</span> Statements <span class="token operator">=</span> blockStatement<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">line</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isReturnStatement</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> line
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>trailingComments <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">.</span>trailingComments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token string">&#39;eval-atob&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> line  <span class="token comment">// 过滤无指定注释的行</span>
    <span class="token keyword">delete</span> line<span class="token punctuation">.</span>trailingComments  <span class="token comment">// 移除base64字符串内注释信息</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>code<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>
    <span class="token keyword">const</span> decrypt <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>
      t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&#39;atob&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token function">btoa</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">expressionStatement</span><span class="token punctuation">(</span>
      t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>
        t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&#39;eval&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>decrypt<span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;body&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span>Statements<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 行末依然含有注释，需要设置 generator 的参数移除注释</span>
<span class="token comment">// const {code} = generator(ast, {comments: false})  </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p>eval-ascii 混淆函数体：同理，构造出 <code>eval(String.fromCharCode(xx, xx, xx, xx....))</code></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">FunctionExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> blockStatement <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">const</span> Statements <span class="token operator">=</span> blockStatement<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">line</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isReturnStatement</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> line
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>trailingComments <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">.</span>trailingComments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token string">&#39;eval-ascii&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> line  <span class="token comment">// 过滤无指定注释的行</span>
    <span class="token keyword">delete</span> line<span class="token punctuation">.</span>trailingComments  <span class="token comment">// 移除ascii字符串内注释信息</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>code<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>  <span class="token comment">// 代码字符串</span>
    <span class="token keyword">const</span> asciiArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>  <span class="token comment">// // 构造ascii码数组</span>
      code<span class="token punctuation">,</span> 
      <span class="token parameter">c</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span><span class="token function">numericLiteral</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 每个 char 转换成 10 进制 ascii 码</span>
    <span class="token punctuation">)</span>  <span class="token comment">// 字符串不能直接调用 map，使用 call 让字符串调用 map 方法</span>
    <span class="token keyword">const</span> decriptFuncName <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span> <span class="token comment">// 构造 \`String.fromCharCode\` 成员访问</span>
      t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&#39;String&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// 对象</span>
      t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&#39;fromCharCode&#39;</span><span class="token punctuation">)</span>  <span class="token comment">// 属性</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">const</span> decrypt <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>  <span class="token comment">// 构造 String.fromCharCode 的调用</span>
      decriptFuncName<span class="token punctuation">,</span>  <span class="token comment">// 目标函数</span>
      asciiArray  <span class="token comment">// 参数列表（n个参数） String.fromCharCode(xx,xx,xx,...)</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">expressionStatement</span><span class="token punctuation">(</span>
      t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>
        t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&#39;eval&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>decrypt<span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;body&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span>Statements<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 同理，需要设置 generator 的参数移除注释</span>
<span class="token comment">// const {code} = generator(ast, {comments: false}) </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li></ul><h2 id="花指令" tabindex="-1"><a class="header-anchor" href="#花指令" aria-hidden="true">#</a> 花指令</h2><p>将代码复杂化，增加代码量。增加函数调用，如 加减法，位移，异或，函数调用 等简单逻辑，通过函数封装，增加函数调用，降低代码可读性</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 原始代码</span>
c <span class="token operator">=</span> a <span class="token operator">+</span> b

<span class="token comment">// 混淆后</span>
<span class="token keyword">function</span> <span class="token function">_0x2b02af</span> <span class="token punctuation">(</span><span class="token parameter">_0x83e2f1<span class="token punctuation">,</span> _0x6a9e53</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  retutn _0x83e2f1 <span class="token operator">+</span> _0x6a9e53
<span class="token punctuation">}</span>
c <span class="token operator">=</span> <span class="token function">_0x2b02af</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>


<span class="token comment">// 调用花指令</span>
<span class="token keyword">function</span> <span class="token function">_0xeca66f</span> <span class="token punctuation">(</span><span class="token parameter">_0x701735<span class="token punctuation">,</span> _0x22f4b0<span class="token punctuation">,</span> _0x512ba8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">_0x701735</span><span class="token punctuation">(</span>_0x22f4b0<span class="token punctuation">,</span> _0x512ba8<span class="token punctuation">)</span>  <span class="token comment">// 第一个参数作为函数，进行调用</span>
<span class="token punctuation">}</span>


<span class="token comment">// 多层花指令</span>
<span class="token keyword">function</span> <span class="token function">_0x8e90a3</span> <span class="token punctuation">(</span><span class="token parameter">_0x934a5f<span class="token punctuation">,</span> _0x3287ae</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">_0x2b02af</span><span class="token punctuation">(</span>_0x934a5f<span class="token punctuation">,</span> _0x3287ae<span class="token punctuation">)</span>  <span class="token comment">// 调用其他花指令</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">_0x2b02af</span> <span class="token punctuation">(</span><span class="token parameter">_0x83e2f1<span class="token punctuation">,</span> _0x6a9e53</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  retutn _0x83e2f1 <span class="token operator">+</span> _0x6a9e53
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="花指令混淆二项式" tabindex="-1"><a class="header-anchor" href="#花指令混淆二项式" aria-hidden="true">#</a> 花指令混淆二项式</h3><p>混淆逻辑：将代码中的二项式，都构造为花指令。将花指令放在二项式所在函数的开始处</p>`,16),N={href:"https://astexplorer.net/",target:"_blank",rel:"noopener noreferrer"},Q=a(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span>

<span class="token keyword">var</span> <span class="token function-variable function">func</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 花指令函数的声明，放置于原本二项式所在函数体的开始位置</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">x</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>  <span class="token comment">// 将原本的二项式替换为花指令函数的调用</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">origin_func</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),C=a(`<li><p>混淆代码：遍历所有二项式，在二项式所在函数体的开始位置（BlockStatement 初始位置），声明花指令函数。再将二项式替换为花指令的调用（BinaryExpression -&gt; CallExpression）</p><p>由于花指令的作用是膨胀代码量，无需考虑该二项式是否已生成该种类的花指令（每遍历到一个加法二项式，都可以生成一个加法的花指令函数）</p><p>Tips：花指令产生了新的标识符，该混淆手段建议处于标识符混淆之前</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> operator <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>operator<span class="token punctuation">;</span>
  <span class="token keyword">const</span> left <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
  <span class="token keyword">const</span> right <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
  <span class="token keyword">const</span> a <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&#39;a&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> b <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&#39;b&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> funcNameIdentifier <span class="token operator">=</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">generateUidIdentifier</span><span class="token punctuation">(</span><span class="token string">&#39;_0x251b&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> func <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">functionDeclaration</span><span class="token punctuation">(</span>  <span class="token comment">// 创建函数节点</span>
    funcNameIdentifier<span class="token punctuation">,</span>  <span class="token comment">// 函数名</span>
    <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 参数列表</span>
    t<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span><span class="token punctuation">[</span>  <span class="token comment">// 函数体</span>
      t<span class="token punctuation">.</span><span class="token function">returnStatement</span><span class="token punctuation">(</span>
        t<span class="token punctuation">.</span><span class="token function">binaryExpression</span><span class="token punctuation">(</span>operator<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> BlockStatement <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">findParent</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span><span class="token function">isBlockStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 定位二项式所在函数体</span>
  BlockStatement<span class="token punctuation">.</span>node<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 花指令放入函数体起始位置</span>
  path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>funcNameIdentifier<span class="token punctuation">,</span> <span class="token punctuation">[</span>left<span class="token punctuation">,</span> right<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 替换花指令</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>`,1),T=a(`<h3 id="去花指令混淆" tabindex="-1"><a class="header-anchor" href="#去花指令混淆" aria-hidden="true">#</a> 去花指令混淆</h3><p>以对象形式的花指令为例，根据具体情况进行一些调整</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>    <span class="token keyword">var</span> $n <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">OTbSq</span><span class="token operator">:</span> <span class="token function">Gn</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> o<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;|0&quot;</span><span class="token punctuation">,</span>  <span class="token comment">// Gn为 Ob 混淆的解密函数，去 Ob 混淆后为字符串常量</span>
        <span class="token function-variable function">PFQbW</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> e <span class="token operator">===</span> t  <span class="token comment">// 判断相等</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">IfwWq</span><span class="token operator">:</span> $n<span class="token punctuation">[</span><span class="token function">Gn</span><span class="token punctuation">(</span><span class="token number">1312</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 调用了其他花指令 - 说明出现了多层花指令</span>
        <span class="token function-variable function">KPTzH</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">e</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>  <span class="token comment">// 函数调用</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了处理多层指令，需要访问花指令，使用递归进行处理，当内部为成员表达式时，则说明嵌套了其他花指令，继续深层访问</p><h4 id="字符串常量花指令" tabindex="-1"><a class="header-anchor" href="#字符串常量花指令" aria-hidden="true">#</a> 字符串常量花指令</h4><ul><li><p>生成 dict： 获取代码中的全部 ObjectExpression，放入一个对象中（花指令存放在多个函数而不是一个对象时，遍历 FunctionDeclaration ，根据花指令函数标识符特征，将花指令放入该全局对象）</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment">// 用于存储对象，便于解密时查询</span>
<span class="token keyword">function</span> <span class="token function">generatorDict</span><span class="token punctuation">(</span><span class="token parameter">ast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">VariableDeclarator</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isObjectExpression</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 定位到对象定义</span>
        <span class="token comment">// 获取对象的标识符名</span>
        <span class="token keyword">const</span> objName <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name
        <span class="token comment">// 在 dict 中创建该对象，此处做了去重处理，判断是否已存在</span>
        objName <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>dict<span class="token punctuation">[</span>objName<span class="token punctuation">]</span> <span class="token operator">=</span> dict<span class="token punctuation">[</span>objName<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 将该对象的属性节点写入 - 如果出现了重名对象内存在重名属性，则会覆盖</span>
        dict<span class="token punctuation">[</span>objName<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>init<span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>  <span class="token comment">// 遍历属性节点键值对 item.key&amp;value</span>
          <span class="token comment">// 判断 key 为字符串还是标识符 {&#39;a&#39;: 1}  {a: 1}</span>
          <span class="token parameter">item</span> <span class="token operator">=&gt;</span> dict<span class="token punctuation">[</span>objName<span class="token punctuation">]</span><span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">isStringLiteral</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">?</span> item<span class="token punctuation">.</span>key<span class="token punctuation">.</span>value <span class="token operator">:</span> item<span class="token punctuation">.</span>key<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">.</span>value
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">generatorDict</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>代码中的多层花指令替换为单层花指令：所给示例中多层花指令特征，花指令对应内容为访问对象属性 <code>MemberExpression</code> ，且对象也是花指令对象</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">findRealValue</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 该键值对中的值对访问对象属性</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isMemberExpression</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> objName <span class="token operator">=</span> node<span class="token punctuation">.</span>object<span class="token punctuation">.</span>name
    <span class="token comment">// 此处是简单的多层花指令，即 var a = {xxx: &#39;xxx&#39;}  var b = {xxx: a[&#39;xxx&#39;]}</span>
    <span class="token comment">// 在处理完数组混淆后，b 中访问没有额外混淆</span>
    <span class="token keyword">const</span> propName <span class="token operator">=</span> node<span class="token punctuation">.</span>property<span class="token punctuation">.</span>value
    <span class="token comment">// 该值在字典中有出现</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dict<span class="token punctuation">[</span>objName<span class="token punctuation">]</span><span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 递归查询该值 - 直到不是访问对象属性</span>
      <span class="token keyword">return</span> <span class="token function">findRealValue</span><span class="token punctuation">(</span>dict<span class="token punctuation">[</span>objName<span class="token punctuation">]</span><span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 递归结束的条件</span>
    <span class="token comment">// 不是访问对象属性，返回该值的真实内容</span>
    <span class="token keyword">return</span> node
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">VariableDeclarator</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isObjectExpression</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 遍历对象中的键值对</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>init<span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 传入值，如果为多层，则此处返回真实内容</span>
        <span class="token keyword">const</span> realNode <span class="token operator">=</span> <span class="token function">findRealValue</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        <span class="token comment">// 将多层替换为单层</span>
        realNode <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>value <span class="token operator">=</span> realNode<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
ast <span class="token operator">=</span> <span class="token function">generatorDict</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span>  <span class="token comment">// 再次解析出字典，将其中的多层花指令重新生成，此时变更为单层</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>通过字典，将花指令进行替换</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">MemberExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> objNmae <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>object<span class="token punctuation">.</span>name
  <span class="token keyword">const</span> propName <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>property<span class="token punctuation">.</span>value
  <span class="token comment">// 进行特征判断，比如此处的是否为字符串属性</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dict<span class="token punctuation">[</span>objName<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> t<span class="token punctuation">.</span><span class="token function">isStringLiteral</span><span class="token punctuation">(</span>dict<span class="token punctuation">[</span>objName<span class="token punctuation">]</span><span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 进行替换</span>
    path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span><span class="token punctuation">[</span>objName<span class="token punctuation">]</span><span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h4 id="处理函数内容的花指令" tabindex="-1"><a class="header-anchor" href="#处理函数内容的花指令" aria-hidden="true">#</a> 处理函数内容的花指令</h4>`,7),A={href:"https://astexplorer.net/",target:"_blank",rel:"noopener noreferrer"},D=a(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token function-variable function">xxx</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> e <span class="token operator">+</span> t<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token function-variable function">yyy</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> t</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> a<span class="token punctuation">[</span><span class="token string">&#39;xxx&#39;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span><span class="token string">&#39;yyy&#39;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token string">&#39;xxx&#39;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>生成全局对象 <code>dict</code>，代码同 <a href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%B8%B8%E9%87%8F%E8%8A%B1%E6%8C%87%E4%BB%A4">#字符串生成的花指令</a></p></li><li><p>多层花指令替换为单层花指令</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">findRealFunc</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当传入节点为函数，且函数体内只有一条语句</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isFunctionExpression</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>body<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 取出该唯一一条 return 语句的内容</span>
    <span class="token keyword">const</span> exp <span class="token operator">=</span> node<span class="token punctuation">.</span>body<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>argument<span class="token punctuation">.</span>callee
    <span class="token comment">// 判断该语句是否为成员表达式 - 是，则说明是多层花指令</span>
    <span class="token comment">// </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isMemberExpression</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 取出内层花指令对象 - 此处例子中为 &#39;a&#39;</span>
      <span class="token keyword">const</span> objName <span class="token operator">=</span> node<span class="token punctuation">.</span>object<span class="token punctuation">.</span>name
      <span class="token comment">// 取出内层花指令的key - 此处例子中为 &#39;xxx&#39;</span>
      <span class="token keyword">const</span> propName <span class="token operator">=</span> node<span class="token punctuation">.</span>property<span class="token punctuation">.</span>value
      <span class="token comment">// 该值在字典中有出现</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>dict<span class="token punctuation">[</span>objName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 递归查询该值 - 直到函数体内return语句后不是访问对象属性</span>
        <span class="token keyword">return</span> <span class="token function">findRealFunc</span><span class="token punctuation">(</span>dict<span class="token punctuation">[</span>objName<span class="token punctuation">]</span><span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 此处返回递归后的 FunctionExpression</span>
    <span class="token keyword">return</span> node
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> node
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 遍历声明对象的部分</span>
  <span class="token function">VariableDeclarator</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isObjectExpression</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 遍历对象 中的键值对</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>init<span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 传入值，如果为多层，则此处返回最内层的函数表达式</span>
        <span class="token keyword">const</span> realNode <span class="token operator">=</span> <span class="token function">findRealFunc</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        <span class="token comment">// 将多层替换为单层（多层函数调用替换为最内层函数表达式）</span>
        realNode <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>value <span class="token operator">=</span> realNode<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
    
ast <span class="token operator">=</span> <span class="token function">generatorDict</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span>  <span class="token comment">// 再次解析出字典，将其中的多层花指令重新生成，此时变更为单层</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>通过查字典，将函数花指令还原为 二项式（<code>function(e,t){return e+t}</code>）或 函数调用（<code>function(e,t){return e(t)}</code>），二项式或函数调用的标识符替换为花指令实参的标识符</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 遍历调用处</span>
  <span class="token function">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过调用处的函数是否为成员表达式来确定是否为花指令</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">isMemberExpression</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token comment">// 取出花指令对象名 &#39;a&#39; 与花指令key &#39;xxx&#39;</span>
    <span class="token keyword">const</span> objName <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>object<span class="token punctuation">.</span>name
    <span class="token keyword">const</span> propertyName <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>property<span class="token punctuation">.</span>value
    <span class="token comment">// 查字典</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dict<span class="token punctuation">[</span>objName<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> dict<span class="token punctuation">[</span>objName<span class="token punctuation">]</span><span class="token punctuation">[</span>propertyName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取该花指令函数</span>
      <span class="token keyword">const</span> func <span class="token operator">=</span> dict<span class="token punctuation">[</span>objName<span class="token punctuation">]</span><span class="token punctuation">[</span>propertyName<span class="token punctuation">]</span>
      <span class="token comment">// 取出花指令内容，return 后的内容 - 由于已经处理了字符串，此时花指令必然是函数</span>
      <span class="token keyword">const</span> returnExp <span class="token operator">=</span> func<span class="token punctuation">.</span>body<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>argument
      
      <span class="token comment">// 判断是二项式</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isBinaryExpression</span><span class="token punctuation">(</span>returnExp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用实参构造真实的二项式</span>
        <span class="token keyword">const</span> binExp <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">binaryExpression</span><span class="token punctuation">(</span>returnExp<span class="token punctuation">.</span>operator<span class="token punctuation">,</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment">// 花指令替换为真实的二项式</span>
        path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>binExp<span class="token punctuation">)</span>
      
      <span class="token comment">// 判断是函数调用</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isCallExpression</span><span class="token punctuation">(</span>returnExp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将花指令第一个参数后的参数构造为一个新的参数数组（第一个参数是目标函数）</span>
        <span class="token keyword">const</span> paramsArray <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment">// 构造调用表达式，函数为花指令的第一个参数</span>
        <span class="token keyword">const</span> callExp <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">callExpresion</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> paramsArray<span class="token punctuation">)</span>
        <span class="token comment">// 花指令替换为真实的函数调用</span>
        path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>callExp<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>移除对象声明表达式。可手动移除，防止其他非花指令对象被误删</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">VariableDeclarator</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isObjectExpression</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h2 id="控制流混淆" tabindex="-1"><a class="header-anchor" href="#控制流混淆" aria-hidden="true">#</a> 控制流混淆</h2><h3 id="流程平坦化" tabindex="-1"><a class="header-anchor" href="#流程平坦化" aria-hidden="true">#</a> 流程平坦化</h3><blockquote><p>通过 <code>switch</code> 对代码流程进行处理，打乱代码中的显示顺序，通过数组作为分发器，配合循环实现按照数组顺序执行指定 case</p></blockquote><p>这种混淆方式可以进行嵌套，即流程平坦化的某个 case 中，也是一个流程平坦化代码（数组声明，循环，switch-case）。也可配合花指令，即生成很多不会执行的 <code>case</code></p><p>循环遍历数组可以使用 <code>for</code> 或 <code>while</code>，<code>switch</code> 中可能存在 <code>default</code> 作为最后一个步骤，也可以不存在。以下是使用 <code>for</code> 循环，无 <code>default</code> 的例子</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>s <span class="token operator">=</span> <span class="token string">&#39;6|3|5|4|2|1&#39;</span>
l <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;|&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 此处该写法未设置循环结束条件</span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>l<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&#39;1&#39;</span><span class="token operator">:</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;step 6&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span>  <span class="token comment">// 不使用break，防止执行到 switch 后的 break，从而跳出循环</span>
    <span class="token keyword">case</span> <span class="token string">&#39;2&#39;</span><span class="token operator">:</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;step 5&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span>
    <span class="token keyword">case</span> <span class="token string">&#39;3&#39;</span><span class="token operator">:</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;step 2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span>
    <span class="token keyword">case</span> <span class="token string">&#39;4&#39;</span><span class="token operator">:</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;step 4&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span>
    <span class="token keyword">case</span> <span class="token string">&#39;5&#39;</span><span class="token operator">:</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;step 3&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span>
    <span class="token keyword">case</span> <span class="token string">&#39;6&#39;</span><span class="token operator">:</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;step 1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 索引超出后，swith 条件为 undefined，无 case 满足条件，从而执行至此</span>
  <span class="token keyword">break</span>  <span class="token comment">// 跳出循环</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="流程平坦化混淆" tabindex="-1"><a class="header-anchor" href="#流程平坦化混淆" aria-hidden="true">#</a> 流程平坦化混淆</h4><p>代码流程转换为如下内容，达到打乱代码显示顺序的目的</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>array <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;|&#39;</span><span class="token punctuation">)</span>  <span class="token comment">// 真实顺序数组</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// jsf*ck - [] 隐式转换为 true</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token operator">+</span>array<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">// + 用于隐式转换为数字类型</span>
    <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>  <span class="token comment">// case 顺序默认 0，1，2，3，4</span>
      <span class="token operator">...</span> 
      <span class="token keyword">continue</span>
    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
      <span class="token operator">...</span>
      <span class="token keyword">continue</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">break</span>  <span class="token comment">// 没有指定 case 时跳出循环</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>遍历函数体的每一行语句，并打乱顺序，混淆代码如下</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">FunctionExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> blockStatement <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>body
  <span class="token keyword">const</span> statements <span class="token operator">=</span> blockStatement<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token literal-property property">index</span><span class="token operator">:</span> index<span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> item<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">// 记录语句的真实顺序</span>
  <span class="token comment">// 洗牌，打乱语句顺序</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> statements<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// i 为从最后一个元素开始的索引</span>
    <span class="token keyword">const</span> j <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// [0, i] 的一个索引值，随机交换或不交换</span>
    <span class="token comment">// 交换语句内容，此时 statements 的每一项包含 index 真实顺序，value 对应的语句</span>
    <span class="token punctuation">;</span><span class="token punctuation">[</span>statements<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> statements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>statements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> statements<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment">// 变量值交换，类似 py。\`[\` 开头，需要分号</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 构建分发器，创建 switch 中的 Case 数组</span>
  <span class="token keyword">const</span> dispenserArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment">// 真实顺序数组</span>
  <span class="token keyword">const</span> cases <span class="token operator">=</span> statements<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">line<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  <span class="token comment">// 将乱序后的语句构建为 case</span>
    dispenserArr<span class="token punctuation">[</span>line<span class="token punctuation">.</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> index  <span class="token comment">// 使当前语句出现在其真实顺序</span>
    <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">switchCase</span><span class="token punctuation">(</span>  <span class="token comment">// 构建 case 语句  </span>
      t<span class="token punctuation">.</span><span class="token function">numericLiteral</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// SwitchCase.test: case 条件，默认从 0 开始</span>
      <span class="token punctuation">[</span>line<span class="token punctuation">.</span>value<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">continueStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment">// SwitchCase.consequent: case 内容</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 初始化</span>
  <span class="token keyword">const</span> dispenserStr <span class="token operator">=</span> dispenserArr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;|&#39;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> array <span class="token operator">=</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">generateDeclaredUidIdentifier</span><span class="token punctuation">(</span><span class="token string">&#39;array&#39;</span><span class="token punctuation">)</span>  <span class="token comment">// 数组变量名</span>
  <span class="token keyword">const</span> index <span class="token operator">=</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">generateDeclaredUidIdentifier</span><span class="token punctuation">(</span><span class="token string">&#39;index&#39;</span><span class="token punctuation">)</span>  <span class="token comment">// 索引变量名</span>
  <span class="token keyword">const</span> callee <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>dispenserStr<span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&#39;split&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> arrayInit <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>callee<span class="token punctuation">,</span> <span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token string">&#39;|&#39;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">// split语句</span>
  <span class="token keyword">const</span> varArray <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">variableDeclarator</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> arrayInit<span class="token punctuation">)</span>  <span class="token comment">// 数组初始化</span>
  <span class="token keyword">const</span> varIndex <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">variableDeclarator</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">numericLiteral</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 索引初始化</span>
  <span class="token keyword">const</span> dispenser <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">variableDeclaration</span><span class="token punctuation">(</span><span class="token string">&#39;let&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>varArray<span class="token punctuation">,</span> varIndex<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">// 数组与索引的声明</span>
  <span class="token comment">// 循环</span>
  <span class="token keyword">const</span> updExp <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">updateExpression</span><span class="token punctuation">(</span><span class="token string">&#39;++&#39;</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span>  <span class="token comment">// 更新索引</span>
  <span class="token keyword">const</span> memExp <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> updExp<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>  <span class="token comment">// 数组中取当前的 case</span>
  <span class="token keyword">const</span> discriminant <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">unaryExpression</span><span class="token punctuation">(</span><span class="token string">&#39;+&#39;</span><span class="token punctuation">,</span> memExp<span class="token punctuation">)</span>  <span class="token comment">// 隐式转换语句 +array(index++)</span>
  <span class="token keyword">const</span> switchSta <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">switchStatement</span><span class="token punctuation">(</span>discriminant<span class="token punctuation">,</span> cases<span class="token punctuation">)</span>  <span class="token comment">// 构建 switch， 传入 待判断变量 与 case 数组</span>
  <span class="token keyword">const</span> unaExp <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">unaryExpression</span><span class="token punctuation">(</span><span class="token string">&#39;!&#39;</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">unaryExpression</span><span class="token punctuation">(</span><span class="token string">&#39;!&#39;</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">arrayExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// !![]</span>
  <span class="token keyword">const</span> whileSta <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">whileStatement</span><span class="token punctuation">(</span>unaExp<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span><span class="token punctuation">[</span>switchSta<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">breakStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// while 循环</span>

  path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;body&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span><span class="token punctuation">[</span>dispenser<span class="token punctuation">,</span> whileSta<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 替换成初始化与循环</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="去平坦化" tabindex="-1"><a class="header-anchor" href="#去平坦化" aria-hidden="true">#</a> 去平坦化</h4>`,14),O=a(`<li>所给混淆代码的去混淆（ <code>while</code> 循环，无 <code>default</code>，每个 <code>case</code> 仅一个逻辑 ） <ul><li><p>获取执行顺序。成员表达式中，对象为字符串且调用 <code>split</code> 则为分发器。（由于访问方式是方括号字符串，不能使用 <code>path.evaluate()</code> 判断其返回对象的 <code>confident</code> 是否为真）</p><p>解析switch-case。将 case 按照编号进行存储，方便后续按照顺序取出实际的指令</p><p>按照执行顺序组装 blockStatement</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">MemberExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 过滤：对象为字符串且调用 \`split\` </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">isStringLiteral</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>object<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> types<span class="token punctuation">.</span><span class="token function">isStringLiteral</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>property<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&#39;split&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定位声明语句</span>
    <span class="token keyword">const</span> varPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">findParent</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> types<span class="token punctuation">.</span><span class="token function">isVariableDeclaration</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 获取 while 语句，声明语句同级节点的下一条语句</span>
    <span class="token keyword">const</span> whilePath <span class="token operator">=</span> varPath<span class="token punctuation">.</span><span class="token function">getSibling</span><span class="token punctuation">(</span>varPath<span class="token punctuation">.</span>key <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// 过滤：声明语句后第一条是否为 while 语句</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>types<span class="token punctuation">.</span><span class="token function">isWhileStatement</span><span class="token punctuation">(</span>whilePath<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token comment">// 获取 while 内的 switch 语句</span>
    <span class="token keyword">const</span> switchPath <span class="token operator">=</span> whilePath<span class="token punctuation">.</span>node<span class="token punctuation">.</span>body<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment">// 过滤：while内第一条是否为 switch</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>types<span class="token punctuation">.</span><span class="token function">isSwitchStatement</span><span class="token punctuation">(</span>switchPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

    <span class="token comment">// 构建 caseMap - 此处使用数组方式，不支持 default 存在，不支持 case 内多条语句 !!!</span>
    <span class="token keyword">const</span> StaArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 将 case 语句中的内容按照 case test 执行顺序赋值到数组中</span>
    switchPath<span class="token punctuation">.</span>cases<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>
      <span class="token comment">// 每个 case 只有第一句为执行逻辑 !!! </span>
      <span class="token parameter">c</span> <span class="token operator">=&gt;</span> StaArr<span class="token punctuation">[</span>c<span class="token punctuation">.</span>test<span class="token punctuation">.</span>value<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">.</span>consequent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    <span class="token comment">// 以上代码等效为按顺序将每个 case 中的第一条语句放入数组 (case 一般默认为 &#39;0&#39; &#39;1&#39; &#39;2&#39; ...)</span>

    <span class="token comment">// 获取真实执行顺序</span>
    <span class="token keyword">const</span> shufferArr <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>object<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;|&#39;</span><span class="token punctuation">)</span>

    <span class="token comment">// 根据实际执行顺序将代码放入语句块</span>
    <span class="token keyword">const</span> parentPath <span class="token operator">=</span> whilePath<span class="token punctuation">.</span>parent
    varPath<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 移除 执行顺序声明</span>
    whilePath<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 移除 while</span>
    shufferArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">line</span> <span class="token operator">=&gt;</span> parentPath<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>StaArr<span class="token punctuation">[</span>line<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 每次处理一个后停止，防止内层嵌套方式的问题</span>
    path<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>多次循环的方式来对代码内的流程平坦化逐个进行处理。流程平坦化嵌套情况下（ case 内出现流程平坦化）traverse全部处理可能存在问题</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li>`,1),q=n("code",null,"while",-1),I=n("code",null,"default",-1),L=n("code",null,"case",-1),M={href:"https://lzc6244.github.io/2021/07/30/Babel%E5%8E%BB%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96%E4%B9%8Bwhile-switch.html",target:"_blank",rel:"noopener noreferrer"},F=a(`<li>目标代码<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> array <span class="token operator">=</span> <span class="token string">&#39;1|0|2|3&#39;</span><span class="token punctuation">[</span><span class="token string">&#39;split&#39;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&#39;|&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 索引超出时为 undefine 执行至 default</span>
        <span class="token keyword">case</span> <span class="token string">&#39;0&#39;</span><span class="token operator">:</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;This is case 0&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">&#39;1&#39;</span><span class="token operator">:</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;This is case 1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">&#39;2&#39;</span><span class="token operator">:</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;This is case 2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">&#39;3&#39;</span><span class="token operator">:</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;This is case 3&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;This is case [default], exit loop.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>`,1),P=n("code",null,"'1|0|2|3'['split']('|')",-1),H=n("code",null,"'1|0|2|3'.split('|')",-1),V=n("code",null,"path.evaluate()",-1),W=n("code",null,"confident",-1),R=n("code",null,"value",-1),Z={href:"https://lzc6244.github.io/2021/08/02/Babel%E5%B0%86a-'bb'-%E8%BD%AC%E6%8D%A2%E4%B8%BAa.bb.html",target:"_blank",rel:"noopener noreferrer"},G=a(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">MemberExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> computed <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">.</span>node
  <span class="token keyword">const</span> property <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;property&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">// 如果是方括号形式，则修改为点形式</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>computed <span class="token operator">&amp;&amp;</span> types<span class="token punctuation">.</span><span class="token function">isStringLiteral</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    property<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span>node<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>computed<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),X=n("code",null,"while",-1),z=n("code",null,"path.evaluate()",-1),U=n("code",null,"while",-1),$={href:"https://lzc6244.github.io/2021/07/30/Babel%E5%8E%BB%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96%E4%B9%8Bwhile-switch.html",target:"_blank",rel:"noopener noreferrer"},K=a(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">WhileStatement</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> body <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">.</span>node
  <span class="token comment">// while内的第一条语句</span>
  <span class="token keyword">const</span> switchStatement <span class="token operator">=</span> body<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token comment">// 过滤：第一条语句是否为switch</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>types<span class="token punctuation">.</span><span class="token function">isSwitchStatement</span><span class="token punctuation">(</span>switchStatement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> discriminant<span class="token punctuation">,</span> cases <span class="token punctuation">}</span> <span class="token operator">=</span> switchStatement
  <span class="token comment">// 过滤：switch 判断内容是否为 array[index++] 成员表达式，该成员表达式属性为自增表达式</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>types<span class="token punctuation">.</span><span class="token function">isMemberExpression</span><span class="token punctuation">(</span>discriminant<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>types<span class="token punctuation">.</span><span class="token function">isUpdateExpression</span><span class="token punctuation">(</span>discriminant<span class="token punctuation">.</span>property<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

  <span class="token comment">// 找到 array 是哪定义的，并且使用 path.evaluate() 方法获取其最终值</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> confident<span class="token punctuation">,</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">getBinding</span><span class="token punctuation">(</span>discriminant<span class="token punctuation">.</span>object<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;init&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// 过滤：switch 的对象是否为常量</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>confident<span class="token punctuation">)</span> <span class="token keyword">return</span>

  <span class="token comment">// array - 真实执行顺序的数组  caseMap - 不同 case 值对应代码块的映射</span>
  <span class="token keyword">const</span> array <span class="token operator">=</span> value<span class="token punctuation">,</span> caseMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token comment">// 构建 caseMap</span>
  cases<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  <span class="token comment">// 遍历每个 case</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> consequent<span class="token punctuation">,</span> test <span class="token punctuation">}</span> <span class="token operator">=</span> c  <span class="token comment">// 取出 case 的条件与语句块</span>
    <span class="token keyword">const</span> test_value <span class="token operator">=</span> test <span class="token operator">?</span> test<span class="token punctuation">.</span>value <span class="token operator">:</span> <span class="token string">&#39;default_case&#39;</span>
    <span class="token keyword">const</span> statementArray <span class="token operator">=</span> consequent<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">line</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>types<span class="token punctuation">.</span><span class="token function">isContinueStatement</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span>
    caseMap<span class="token punctuation">[</span>test_value<span class="token punctuation">]</span> <span class="token operator">=</span> statementArray
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 根据实际执行顺序拼接出语句块</span>
  array<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">i</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>caseMap<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 添加默认 case</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>caseMap<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">&#39;default_case&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>caseMap<span class="token punctuation">[</span><span class="token string">&#39;default_case&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  path<span class="token punctuation">.</span><span class="token function">replaceWithMultiple</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
  <span class="token comment">// 手动更新 scope ，防止影响下个插件使用</span>
  path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">crawl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),J=a(`<h3 id="逗号表达式与返回语句" tabindex="-1"><a class="header-anchor" href="#逗号表达式与返回语句" aria-hidden="true">#</a> 逗号表达式与返回语句</h3><p>将多行内容使用逗号在单行内执行</p><ul><li><p>代码块转复合语句。通过逗号省略花括号</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
  i<span class="token operator">++</span><span class="token punctuation">,</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>return</code> 内使用逗号表达式。此时的代码效果看起来与python的多返回值类似，但 js 不支持多返回，前面的表达式都是赋值或计算，最后一项才是真实返回值</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">create</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token operator">||</span> r <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r  <span class="token comment">// 通过 \`&amp;&amp;\` 与 \`||\`，配合 \`,\` 执行多个表达式</span>
  <span class="token keyword">return</span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>create<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r  <span class="token comment">// 内部返回为函数后，再调用函数</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 此时，返回部分前只声明变量，所有赋值、计算逻辑在返回部分进行</span>
  <span class="token keyword">var</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">;</span>
  <span class="token comment">// 赋值方式的多种写法</span>
  <span class="token keyword">return</span> v2 <span class="token operator">=</span> <span class="token punctuation">(</span>v1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> v1 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v2  <span class="token comment">// 内层返回 v1 + 2</span>
  <span class="token keyword">return</span> v2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> v1<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v2  <span class="token comment">// 最内层返回 v1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>添加花指令，增加无意义的赋值与计算，增大返回值内容</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">,</span> v3<span class="token punctuation">;</span>
  <span class="token keyword">return</span> v2 <span class="token operator">=</span> <span class="token punctuation">(</span>v1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> v1 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v3 <span class="token operator">=</span> v1 <span class="token operator">+</span> v2<span class="token punctuation">,</span> v3<span class="token operator">++</span><span class="token punctuation">,</span> v2  <span class="token comment">// 此处所有v3相关的计算都是无意义的</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token parameter">v1<span class="token punctuation">,</span> v2<span class="token punctuation">,</span> v3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 将函数声明部分放入参数中</span>
  <span class="token keyword">return</span> v2 <span class="token operator">=</span> <span class="token punctuation">(</span>v1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> v1 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v3 <span class="token operator">=</span> v1 <span class="token operator">+</span> v2<span class="token punctuation">,</span> v3<span class="token operator">++</span><span class="token punctuation">,</span> v2
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a<span class="token operator">+</span>b
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token parameter">v1<span class="token punctuation">,</span> v2<span class="token punctuation">,</span> v3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> v2 <span class="token operator">=</span> <span class="token punctuation">(</span>v1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>v1<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> add<span class="token punctuation">)</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v3 <span class="token operator">=</span> <span class="token punctuation">(</span>v2<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> add<span class="token punctuation">)</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">,</span> v3<span class="token operator">++</span><span class="token punctuation">,</span> v2  <span class="token comment">// 花指令函数调用时，通过逗号返回，函数名前的内容都是无意义的代码</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>Tips：js中所有未被调用的参数，值均为<code>undefined</code>，可等效为函数内部通过 <code>var</code> 声明的变量</strong></p></li></ul><p>还原：一般来说，处理逗号表达式需要<strong>明确括号层级。最内层为最先执行的逻辑，上一层的返回内容是内层中表达式的最后一项</strong></p><h4 id="逗号表达式混淆" tabindex="-1"><a class="header-anchor" href="#逗号表达式混淆" aria-hidden="true">#</a> 逗号表达式混淆</h4><ul><li>混淆逻辑：将函数内多个表达式使用逗号进行连接，注意以下几种表达式不可直接连接 <ul><li><p>变量声明语句</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment">// 直接连接会出错</span>
<span class="token comment">// var a = 1, var b = 2</span>
<span class="token comment">// 正常写法</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>操作方法：提取作用域内的全部声明，统一放置在一个 <code>VariableDeclaration</code> 数组内。可提取到参数中，用函数参数进行深明，再将函数内初始化语句变更为赋值语句</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 变量声明提取为参数。变更为</span>
<span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>return</code> 与 其他语句连接时。<code>return</code> 会返回最后一个逗号表达式的结果，因此要将返回语句拆分为两部分，<code>return</code> 放到开头，返回值使用逗号表达式拼接到后方</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  a <span class="token operator">=</span> a <span class="token operator">+</span> b
  <span class="token keyword">return</span> a
<span class="token punctuation">}</span>

<span class="token comment">// 直接连接会出错</span>
<span class="token comment">// a = a + b, return a</span>
<span class="token comment">// 正常写法</span>
<span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">,</span> a
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li>混淆代码<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">FunctionExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> blockStatement <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>body
  <span class="token keyword">const</span> blockStatementLength <span class="token operator">=</span> blockStatement<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length
  <span class="token keyword">if</span> <span class="token punctuation">(</span>blockStatementLength <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  
  <span class="token comment">// 1.变量处理 - 提取变量声明到函数参数</span>
  path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">VariableDeclaration</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 变量函数内的声明语句</span>
      declarations <span class="token operator">=</span> p<span class="token punctuation">.</span>node<span class="token punctuation">.</span>declarations
      <span class="token keyword">const</span> statements <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      declarations<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>id<span class="token punctuation">)</span>  <span class="token comment">// 将声明变量的 Identifier 放入函数参数中</span>
        item<span class="token punctuation">.</span>init <span class="token operator">&amp;&amp;</span> statements<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>  <span class="token comment">// 若该变量有初始化</span>
          t<span class="token punctuation">.</span><span class="token function">assignmentExpression</span><span class="token punctuation">(</span><span class="token string">&#39;=&#39;</span><span class="token punctuation">,</span> item<span class="token punctuation">.</span>id<span class="token punctuation">,</span> item<span class="token punctuation">.</span>init<span class="token punctuation">)</span>  <span class="token comment">// 构建变量赋值语句</span>
        <span class="token punctuation">)</span>
        p<span class="token punctuation">.</span><span class="token function">replaceInline</span><span class="token punctuation">(</span>statements<span class="token punctuation">)</span>  <span class="token comment">// 将初始化替换为赋值语句</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 2. 函数中部分语句会包裹在 \`ExpressionStatement\` 中（外边套了一层 \`ExpressionStatement\`）。在遍历函数内每条语句的类型时，会影响该语句的类型判断，需将该语句的内容从 \`ExpressionStatement\` 中提取出来</span>
  <span class="token comment">// 拼接 return &lt;逗号表达式&gt;</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> blockStatement<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment">// 取出首条语句，作为 return 的初始值</span>
  <span class="token comment">// 遍历后续语句，去除 ExpressionStatement 包裹</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> blockStatementLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> statement <span class="token operator">=</span> blockStatement<span class="token punctuation">.</span>body<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">const</span> nextSta <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">isExpressionStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span> <span class="token operator">?</span> statement<span class="token punctuation">.</span>expression <span class="token operator">:</span> statement

    <span class="token comment">// 3. 处理 return 语句</span>
    <span class="token comment">// 遍历到原函数中的返回语句时，生成拼接后的返回语句</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isReturnStatement</span><span class="token punctuation">(</span>nextSta<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">returnStatement</span><span class="token punctuation">(</span> <span class="token comment">// 构造 return 语句</span>
        <span class="token comment">// 逗号语句拼接之前的结果与当前语句</span>
        t<span class="token punctuation">.</span><span class="token function">toSequenceExpression</span><span class="token punctuation">(</span><span class="token punctuation">[</span>result<span class="token punctuation">,</span> nextSta<span class="token punctuation">.</span>argument<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">// 返回内容 ReturnStatement.argument</span>
      <span class="token punctuation">)</span>

    <span class="token comment">// 4. 处理 赋值 语句</span>
    <span class="token comment">// 遍历到赋值语句时</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isAssignmentExpression</span><span class="token punctuation">(</span>nextSta<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 判断该赋值的右侧是否为函数调用</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isCallExpression</span><span class="token punctuation">(</span>nextSta<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> callee <span class="token operator">=</span> nextSta<span class="token punctuation">.</span>right<span class="token punctuation">.</span>callee
        callee<span class="token punctuation">.</span>object <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">toSequenceExpression</span><span class="token punctuation">(</span><span class="token punctuation">[</span>result<span class="token punctuation">,</span> callee<span class="token punctuation">.</span>object<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">// 将调用者替换为逗号表达式</span>
        result <span class="token operator">=</span> nextSta  <span class="token comment">// 将最终的赋值设置为result</span>
  
      <span class="token comment">// 5. 其他普通语句</span>
      <span class="token comment">// 常规处理：由于逗号表达式默认返回最后一项，直接将值拼接到后方，将 result 重构为赋值语句</span>
      <span class="token comment">// Eg: \`a = 1; b = 2;\`  处理后得到   \`b = (a = 1, 2);\` 即 \`v = (xxx, value)\`</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        nextSta<span class="token punctuation">.</span>right <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">toSequenceExpression</span><span class="token punctuation">(</span><span class="token punctuation">[</span>result<span class="token punctuation">,</span> nextSta<span class="token punctuation">.</span>right<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">// next为赋值 a=xxx,1</span>
        result <span class="token operator">=</span> nextSta  <span class="token comment">// 将最终的赋值设置为result</span>
      <span class="token punctuation">}</span>    

    <span class="token comment">// 普通语句，直接逗号拼接到后方 (xxx,xxx), xxx; !*** 函数内出现函数声明时，此处拼接返回undefined ***</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      result <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">toSequenceExpression</span><span class="token punctuation">(</span><span class="token punctuation">[</span>result<span class="token punctuation">,</span> nextSta<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 函数体替换为拼接后的单行 return 语句</span>
  path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;body&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span><span class="token punctuation">[</span>result<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><strong>Tips：</strong></p><ul><li>逗号表达式的混淆需注意减少与其他表达式混淆的混用，容易引发异常</li><li>若函数内出现了函数声明或定义，不能直接逗号拼接到 return 内，需做额外处理。此处代码不适用 <ul><li>数组还原代码中出现了自执行函数内定义了函数，此时不适用此混淆插件</li><li>编写不出现函数嵌套，可先尝试使用此混淆插件。测试混淆结果是否正常，再使用其他混淆手段</li></ul></li></ul><h2 id="标识符混淆" tabindex="-1"><a class="header-anchor" href="#标识符混淆" aria-hidden="true">#</a> 标识符混淆</h2><p>隐藏标识符的语义，增大逆向难度</p><ul><li><p>简单的标识符混淆。所有的标识符命名都不相同</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">Statement</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token punctuation">{</span>
  <span class="token comment">// 作用域重命名（作用域中指定的标识符名称，修改为目标标识符名称）</span>
  path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name<span class="token punctuation">,</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">generateUidIdentifier</span><span class="token punctuation">(</span><span class="token string">&#39;_0x18b2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>不同作用域的局部变量采用相同标识符名。使用 <code>scope.getOwnBinding</code> 获取函数( <code>FunctionDeclaration|FunctionExpression</code> ) 或全局( <code>Program</code> )的所有绑定，对函数作用域或全局作用域内的变量标识符进行重命名</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">renameOwnBinding</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> OwnBindingObj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> globalBindingObj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 遍历当前作用域下的全部标识符</span>
      <span class="token keyword">const</span> name <span class="token operator">=</span> p<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      <span class="token keyword">const</span> binding <span class="token operator">=</span> p<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">getOwnBinding</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 不是自己作用域内时，值为 undefined</span>
      <span class="token comment">// 对当前作用域下的标识符进行区分</span>
      <span class="token comment">// 不是自己作用域的放入 globalBindingObj 中</span>
      <span class="token comment">// globalBindingObj 中不是全局，是非自己binding的变量，可能仅仅是上层函数，可能是全局</span>
      <span class="token comment">// 不是全部的全局，因为仅遍历当前作用域的变量。如果定义了全局变量但当前作用域内未引用，则不会遍历到</span>
      binding <span class="token operator">?</span> <span class="token punctuation">(</span>OwnBindingObj<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> binding<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>globalBindingObj<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析，区分是否为 OwnBinding</span>
  
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> oldName <span class="token keyword">in</span> OwnBindingObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> newName<span class="token punctuation">;</span>
    <span class="token comment">// OwnBinding 不能与 globalBinding 重名。构建一个不重名的名称</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      newName <span class="token operator">=</span> <span class="token string">&#39;_0x18b2&#39;</span> <span class="token operator">+</span> i<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token comment">// 在不同作用域中都以 _0x18b2 开头定义变量</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>globalBindingObj<span class="token punctuation">[</span>newName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 该名称为全局，且作用域内有引用，需要更换名称</span>
    
    OwnBindingObj<span class="token punctuation">[</span>oldName<span class="token punctuation">]</span><span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span>oldName<span class="token punctuation">,</span> newName<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 通过 Binding.scope.rename 改名</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token string">&#39;Program|FunctionExpression|FunctionDeclaration&#39;</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 全局和普通函数的作用域内标识符，都独立进行重命名</span>
    <span class="token comment">// 已相同的起始命名，实现不同作用域的局部变量采用相同标识符名</span>
    <span class="token function">renameOwnBinding</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>会存在部分变量无法重命名，需要再转换一次 AST。例如 数组混淆 或 花指令 时，一些标识符由 types 组件生成。types 生成的为 Node 节点，不存在 Path，因此无法使用 Path.scope.rename。转换成代码后再次转为 AST，此时才拥有 Path</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">let</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>jscode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 其他加密手段</span>
<span class="token comment">// ...</span>

<span class="token keyword">let</span> <span class="token punctuation">{</span>code<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>
ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 不存储而是再解析成 ast</span>

<span class="token comment">// 标识符重命名</span>
<span class="token comment">// function renameOwnBinding(path)  ...</span>

code <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">.</span>code
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>生成相似标识符名。用 <code>O</code>, <code>o</code>, <code>0</code> 三个字符生成标识符名</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>newName <span class="token operator">=</span> <span class="token function">generatorIdentifier</span><span class="token punctuation">(</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">generatorIdentifier</span><span class="token punctuation">(</span><span class="token parameter">decNum</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> flag <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;O&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;o&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;0&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> retval <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>decNum <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 三进制数组</span>
    retval<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>decNum <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 低位在前，高位在后</span>
    decNum <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>decNum <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> Identifier <span class="token operator">=</span> retval<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> flag<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 0，1，2 对应 0 o O</span>
  Identifier<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">6</span> <span class="token operator">?</span> <span class="token punctuation">(</span>Identifier <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">&#39;OOOOOO&#39;</span> <span class="token operator">+</span> Identifier<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span>  <span class="token comment">// 长度6</span>
  	Identifier<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&#39;0&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>Identifier <span class="token operator">=</span> <span class="token string">&#39;O&#39;</span> <span class="token operator">+</span> Identifier<span class="token punctuation">)</span>  <span class="token comment">// js标识符不能数字开头</span>
  <span class="token keyword">return</span> Identifier
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Tips:</strong> 注意 <code>flag</code> 的顺序，需要保证传入不同值，得到不同值。例如，如果字母 <code>O</code> 出现在索引1处，会出现以下问题</p><ul><li>传入 <code>0</code> ，不执行 <code>while</code> ，输出 <code>OOOOOO</code></li><li>传入 <code>1</code> ，得到字母 <code>O</code>，切分后依然为 <code>OOOOOO</code></li></ul><p>此时，同一作用域下的前两个变量必定重名！</p></li></ul><h2 id="jsf-ck" tabindex="-1"><a class="header-anchor" href="#jsf-ck" aria-hidden="true">#</a> jsf*ck</h2><p>使用 <code>(</code> <code>) </code> <code>! </code> <code>+</code> <code>[</code> <code>]</code> 共6个字符对待加密代码进行编码</p><p>原理：在目标前使用 <code>+</code> （作为一元运算符使用）对目标强转为数字，如</p>`,14),Y=a("<li><p><code>+&#39;9&#39;</code> 得到 <code>9</code></p></li><li><p><code>+[]</code> 得到 <code>0</code></p></li><li><p><code>+[3]</code> 得到 <code>3</code></p></li><li><p><code>+[1,3,5]</code> 得到 <code>NaN</code></p></li><li><p><code>+undefined</code> 得到 <code>NaN</code></p></li><li><p><code>+{}</code> 得到 <code>NaN</code></p></li><li><p><code>!+[]</code> 得到 <code>true</code> 。由于 <code>+[]</code> 为 <code>0</code>，<code>!</code>表示当前bool取反，即现将 <code>0</code> 转为bool <code>false</code>，再取反得到 <code>true</code></p></li><li><p><code>!+undefined</code> 得到 <code>true</code> 。同理，<code>NaN</code> 转bool为 <code>false</code>，再取反得到 <code>true</code></p></li><li><p><code>!![] + !![]</code> 得到 <code>2</code>。由于 <code>[]</code> 转bool为真，因此 <code>!![]</code> 为真，两个 <code>true</code> 相加会先转为数字1，最后得到 <code>2</code></p></li><li><p><code>[] == ![]</code>。首先 <code>![]</code> 为假。</p><ul><li><code>[]==false</code> 此时，两边类型不同且其中一边是布尔值，会把布尔值转换为数false转换为数字<code>0</code></li><li><code>[]==0</code> 当一个对象（这里是 <code>[]</code>）与数字比较时，对象会先转换为原始值，调用 <code>toString()</code> → <code>&quot;&quot;</code></li><li><code>&quot;&quot;==0</code> 此时 <code>&quot;&quot; </code>转为数字 → <code>0</code>，即<code>0==0</code> ，此时为真</li></ul></li>",10),nn=n("code",null,"(!![]+[])[+[]]",-1),sn=n("code",null,"'t'",-1),an={href:"https://www.resourch.com/archives/90.html",target:"_blank",rel:"noopener noreferrer"},tn=n("ul",null,[n("li",null,[n("code",null,"!![]"),s(" // bool值 true 变形为 (true+[])[+[]]")]),n("li",null,[n("code",null,"!![]+[]"),s(' // 字符串 "true" 变形为 ("true")[+[]]')]),n("li",null,[n("code",null,"+[]"),s(' // 0 最终变形为 ("true")[0]')])],-1),pn=a(`<p><strong>Tips: js 中 <code>false</code>, <code>undefined</code>, <code>null</code>, <code>0</code>, <code>-0</code>, <code>NaN</code>, <code>&quot;&quot;</code> 共7个值在条件逻辑中均表示&quot;假&quot;</strong></p><p>还原：由于括号需要成对出现，通过括号明确代码结构，分段执行</p><h2 id="内存爆破" tabindex="-1"><a class="header-anchor" href="#内存爆破" aria-hidden="true">#</a> 内存爆破</h2><p>通过检测非浏览器环境、代码格式化等，执行到正常情况下不会进入的分支，在分支内通过死循环等方式，使内存溢出</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 检测格式化部分的伪代码</span>
<span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">&#39;dev&#39;</span>
<span class="token punctuation">}</span>
reg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span>  <span class="token comment">// 正则</span>
res <span class="token operator">=</span> reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span>  <span class="token comment">// 是否匹配 &quot;function a(){return &#39;dev&#39;}&quot;</span>
<span class="token comment">// 格式化后的输出为 &quot;function a() {\\n    return &#39;dev&#39;;\\n  }&quot;</span>
<span class="token comment">// js内定义的函数调用toString()。通过正则匹配判断该函数是否被格式化</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 检测不通过</span>
  a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> a<span class="token punctuation">.</span>lengh<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    a<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    l <span class="token operator">=</span> a<span class="token punctuation">.</span>length  <span class="token comment">// 修改结束条件，使其成为死循环，数组长度不断增加</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,5);function en(on,cn){const t=i("ExternalLinkIcon");return e(),o("div",null,[n("p",null,[s("本文参考文章 "),n("a",u,[s("https://juejin.cn/post/7019155025666506788"),p(t)])]),k,n("ul",null,[r,n("li",null,[n("p",null,[s("去混淆代码。代码来源文章 "),n("a",d,[s("https://lzc6244.github.io/2021/08/02/Babel%E5%B0%86a-'bb'-%E8%BD%AC%E6%8D%A2%E4%B8%BAa.bb.html"),p(t)])]),v])]),m,n("ul",null,[b,n("li",null,[n("p",null,[s("常用位异或对数字进行处理。当 $ a \\oplus b = c$ 时， "),n("mjx-container",f,[(e(),o("svg",g,y)),w]),s(" 。因此在加密算法中，可使用 异或方式 处理初始值，例如 "),x,s(" ，使用 "),j,s(" 代替 SHA1 算法的幻数H5值 "),E,s(" 。此时"),_,s(" 通常是作为密钥的身份，此时的思路其实与DES类似，向量，明文，密钥在CBC等模式需要在加密前或后相互进行异或。因此DES等算法可在异或位置进行插桩")]),S])]),B,n("ul",null,[n("li",null,[n("p",null,[s("构建目标。可使用 "),n("a",N,[s("ast explorer"),p(t)]),s(" 解析此代码，理解节点结构")]),Q]),C]),T,n("p",null,[s("此处是简单的函数生成的多层花指令，"),n("a",A,[s("ast explorer"),p(t)]),s(" 解析此代码，便于理解节点结构")]),D,n("ul",null,[O,n("li",null,[q,s(" 循环，有 "),I,s("，每个 "),L,s(" 可能多条语句。代码"),n("a",M,[s("来源"),p(t)]),n("ul",null,[F,n("li",null,[s("将访问方式修改为点，使 "),P,s(" 变更为 "),H,s("，从而可以使用"),V,s("，获取返回对象中的 "),W,s(" 与 "),R,s("。代码"),n("a",Z,[s("来源"),p(t)]),G]),n("li",null,[s("遍历 "),X,s("语句，此时可使用 "),z,s(" ，可在 "),U,s(" 内获取到实际执行顺序。代码"),n("a",$,[s("来源"),p(t)]),K])])])]),J,n("ul",null,[Y,n("li",null,[n("p",null,[nn,s(" 得到 "),sn,s(),n("a",an,[s("参考文章"),p(t)])]),tn])]),pn])}const un=c(l,[["render",en],["__file","022.html.vue"]]);export{un as default};
