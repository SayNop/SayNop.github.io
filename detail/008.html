<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kong与SSO | Leopold&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.8">
    <link rel="icon" href="favicon.ico">
    <meta name="description" content="Blog powerd by vuepress">
    
    <link rel="preload" href="/assets/css/0.styles.86f44b01.css" as="style"><link rel="preload" href="/assets/js/app.61ba6b8b.js" as="script"><link rel="preload" href="/assets/js/3.3ec197e6.js" as="script"><link rel="preload" href="/assets/js/12.89673e4a.js" as="script"><link rel="prefetch" href="/assets/js/10.8437fd11.js"><link rel="prefetch" href="/assets/js/11.8d3d6b6c.js"><link rel="prefetch" href="/assets/js/4.a63a37c2.js"><link rel="prefetch" href="/assets/js/5.e33382bd.js"><link rel="prefetch" href="/assets/js/6.0aed96bc.js"><link rel="prefetch" href="/assets/js/7.46cd1001.js"><link rel="prefetch" href="/assets/js/8.b7d0bd64.js"><link rel="prefetch" href="/assets/js/9.cf264790.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.18d8e194.js">
    <link rel="stylesheet" href="/assets/css/0.styles.86f44b01.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="home"><header class="header" style="opacity:0;" data-v-64814c34><div class="header_container" data-v-64814c34><div data-v-64814c34><a href="/" class="header_title" data-v-64814c34>Leopold's Blog</a></div> <div class="appearance" data-v-64814c34><button type="button" class="switch" data-v-64814c34><span class="check" data-v-64814c34><span class="icon" style="display: block;" data-v-64814c34><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewBox="0 0 24 24" class="sun" style="display:none;" data-v-64814c34><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z" data-v-64814c34></path> <path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z" data-v-64814c34></path> <path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z" data-v-64814c34></path> <path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z" data-v-64814c34></path> <path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z" data-v-64814c34></path> <path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z" data-v-64814c34></path> <path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z" data-v-64814c34></path> <path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z" data-v-64814c34></path> <path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z" data-v-64814c34></path></svg> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewBox="0 0 24 24" class="moon" style="display:;" data-v-64814c34><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z" data-v-64814c34></path></svg></span></span></button> <button type="button" class="switch mobile_list_btn" data-v-64814c34><span class="btn_top" data-v-64814c34></span> <span class="btn_middle" data-v-64814c34></span> <span class="btn_bottom" data-v-64814c34></span></button></div></div></header> <div id="background"><svg viewBox="0 0 1026 1024" xmlns="http://www.w3.org/2000/svg" class="pull_down"><path d="M857.088 224.256q28.672-28.672 69.12-28.672t69.12 28.672q29.696 28.672 29.696 68.608t-29.696 68.608l-382.976 380.928q-12.288 14.336-30.72 19.968t-38.912 4.608-40.448-8.704-34.304-22.016l-376.832-374.784q-29.696-28.672-29.696-68.608t29.696-68.608q14.336-14.336 32.256-21.504t36.864-7.168 37.376 7.168 32.768 21.504l313.344 309.248z"></path></svg></div> <div id="content_container"><div id="content"><!----> <div id="info" data-v-b2f70082><div id="sidebar" data-v-b2f70082><div class="sidebar_top card_border" style="min-height:1rem;" data-v-b2f70082><div class="tags_brand" data-v-b2f70082>本文大纲</div> <section class="article_sidebar" data-v-990ea420 data-v-b2f70082><ul data-v-990ea420><li class="level2" data-v-990ea420><a href="#kong的部署与基本配置" class="sidebar-link" data-v-990ea420>kong的部署与基本配置</a></li><li class="level3" data-v-990ea420><a href="#服务器建立两个无需认证的服务" class="sidebar-link" data-v-990ea420>服务器建立两个无需认证的服务</a></li><li class="level3" data-v-990ea420><a href="#安装postgresql" class="sidebar-link" data-v-990ea420>安装Postgresql</a></li><li class="level3" data-v-990ea420><a href="#安装kong" class="sidebar-link" data-v-990ea420>安装Kong</a></li><li class="level3" data-v-990ea420><a href="#配置与启动" class="sidebar-link" data-v-990ea420>配置与启动</a></li><li class="level3" data-v-990ea420><a href="#kong代理后端服务" class="sidebar-link" data-v-990ea420>kong代理后端服务</a></li><li class="level2" data-v-990ea420><a href="#jwt微服务认证的分析" class="sidebar-link" data-v-990ea420>jwt微服务认证的分析</a></li><li class="level3" data-v-990ea420><a href="#建立需要不同用户权限的服务" class="sidebar-link" data-v-990ea420>建立需要不同用户权限的服务</a></li><li class="level3" data-v-990ea420><a href="#部署插件" class="sidebar-link" data-v-990ea420>部署插件</a></li><li class="level2" data-v-990ea420><a href="#插件开发" class="sidebar-link" data-v-990ea420>插件开发</a></li><li class="level3" data-v-990ea420><a href="#框架搭建" class="sidebar-link" data-v-990ea420>框架搭建</a></li><li class="level3" data-v-990ea420><a href="#权限认证" class="sidebar-link" data-v-990ea420>权限认证</a></li><li class="level3" data-v-990ea420><a href="#数据库查询" class="sidebar-link" data-v-990ea420>数据库查询</a></li><li class="level3" data-v-990ea420><a href="#账号多登录的判断" class="sidebar-link" data-v-990ea420>账号多登录的判断</a></li><li class="level2" data-v-990ea420><a href="#服务端适配" class="sidebar-link" data-v-990ea420>服务端适配</a></li><li class="level3" data-v-990ea420><a href="#服务端生成token" class="sidebar-link" data-v-990ea420>服务端生成token</a></li><li class="level3" data-v-990ea420><a href="#服务端对postgresql的支持" class="sidebar-link" data-v-990ea420>服务端对Postgresql的支持</a></li><li class="level3" data-v-990ea420><a href="#服务端完整代码" class="sidebar-link" data-v-990ea420>服务端完整代码</a></li><li class="level2" data-v-990ea420><a href="#部署至生产服务器" class="sidebar-link" data-v-990ea420>部署至生产服务器</a></li><li class="level2" data-v-990ea420><a href="#插件开发中遇到的问题" class="sidebar-link" data-v-990ea420>插件开发中遇到的问题</a></li></ul></section></div> <div class="sidebar_bottom card_border" data-v-b2f70082><div class="avatar" style="background-image:url(/assets/imgs/avatar.jpg);" data-v-b2f70082></div> <div class="author" data-v-b2f70082>Leopold</div> <div class="summary" data-v-b2f70082><div data-v-b2f70082><p data-v-b2f70082>文章</p></div><div data-v-b2f70082><p data-v-b2f70082>分类</p></div><div data-v-b2f70082><p data-v-b2f70082>标签</p></div> <div data-v-b2f70082><p data-v-b2f70082>8</p></div><div data-v-b2f70082><p data-v-b2f70082>7</p></div><div data-v-b2f70082><p data-v-b2f70082>13</p></div></div> <div class="connection" data-v-b2f70082><div class="grid_icon" data-v-b2f70082><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon" data-v-b2f70082><path d="M1023.560892 524.587752c0 114.331752-32.549236 217.148443-97.647709 308.450075-65.047295 91.301632-149.132822 154.455339-252.205404 189.512299-11.975662 2.303012-20.778286 0.716493-26.305515-4.759558a27.584966 27.584966 0 0 1-8.342021-20.471218V853.150798c0-44.166653-11.566238-76.511177-34.647536-96.982394a446.272549 446.272549 0 0 0 68.32269-12.282731c20.16415-5.476051 41.044792-14.329852 62.590748-26.612583a187.311643 187.311643 0 0 0 53.992837-45.446104c14.432209-18.014672 26.203159-41.914819 35.312851-71.751618 9.109692-29.8368 13.664538-64.074912 13.664538-102.765514 0-55.118754-17.554069-102.049021-52.61103-140.739623 16.376974-41.454216 14.636921-87.872703-5.373695-139.357815-12.436265-4.094244-30.399759-1.535341-53.941659 7.523172a355.17563 355.17563 0 0 0-61.311297 30.041513l-25.333132 16.376974a462.137743 462.137743 0 0 0-127.945112-17.707604 462.137743 462.137743 0 0 0-127.945111 17.758782 589.571074 589.571074 0 0 0-28.301459-18.424096c-11.77095-7.31846-30.34858-16.069906-55.681713-26.305515-25.281954-10.235609-44.422543-13.306292-57.31941-9.212048-19.498835 51.433935-21.085354 97.852421-4.606024 139.306637-35.108139 38.690602-52.713386 85.620869-52.713386 140.739623 0 38.690602 4.606024 72.826357 13.715716 102.458445 9.109692 29.58091 20.778286 53.481057 34.954605 71.700441a180.658498 180.658498 0 0 0 53.634591 45.753172c21.545957 12.282731 42.477777 21.18771 62.641926 26.612583 20.215328 5.527229 42.989557 9.621472 68.32269 12.333909-17.758781 16.376974-28.659705 39.867697-32.651593 70.369811a129.941055 129.941055 0 0 1-29.990334 10.235609 184.087426 184.087426 0 0 1-37.974109 3.428929c-14.688099 0-29.171485-4.913092-43.654872-14.688099-14.432209-9.826185-26.766117-24.053681-37.001726-42.682489a109.162769 109.162769 0 0 0-32.293346-35.517563c-13.101579-9.109692-24.104859-14.585743-33.009839-16.376974l-13.306292-2.047122c-9.314404 0-15.762838 1.023561-19.345301 3.070683-3.582463 2.047122-4.606024 4.606024-3.326572 7.83024a37.769397 37.769397 0 0 0 5.987831 9.570295 49.182101 49.182101 0 0 0 8.700267 8.188487l4.606024 3.377751c9.826185 4.606024 19.447657 13.255114 29.017952 25.998447 9.570294 12.743333 16.581686 24.360749 20.982998 34.80107l6.653146 15.71166c5.783119 17.298179 15.558126 31.320963 29.376197 42.017174 13.766894 10.747389 28.659705 17.554069 44.627255 20.471218 15.96755 2.968327 31.423319 4.606024 46.316131 4.810736 14.841633 0.204712 27.22672-0.562958 37.001726-2.405368l15.302235-2.712436c0 17.298179 0.102356 37.564685 0.358247 60.799517l0.307068 36.848192c0 8.188487-2.86597 15.046345-8.700268 20.471218-5.731941 5.527229-14.636921 7.113748-26.612583 4.810736-103.072582-35.056961-187.158109-98.261846-252.205404-189.512299C32.549236 741.736195 0 638.919504 0 524.587752c0-95.191163 22.876586-182.910331 68.629758-263.31104a516.028224 516.028224 0 0 1 186.288082-190.894106A491.309228 491.309228 0 0 1 511.780446 0.012795a491.309228 491.309228 0 0 1 256.913784 70.369811 516.028224 516.028224 0 0 1 186.236905 190.894106C1000.684306 341.626242 1023.560892 429.447767 1023.560892 524.587752z" data-v-b2f70082></path></svg></div><div data-v-b2f70082><span data-v-b2f70082>github.com/SayNop</span></div> <div class="grid_icon" data-v-b2f70082><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon" data-v-b2f70082><path d="M512 1024C229.222 1024 0 794.778 0 512S229.222 0 512 0s512 229.222 512 512-229.222 512-512 512z m259.149-568.883h-290.74a25.293 25.293 0 0 0-25.292 25.293l-0.026 63.206c0 13.952 11.315 25.293 25.267 25.293h177.024c13.978 0 25.293 11.315 25.293 25.267v12.646a75.853 75.853 0 0 1-75.853 75.853h-240.23a25.293 25.293 0 0 1-25.267-25.293V417.203a75.853 75.853 0 0 1 75.827-75.853h353.946a25.293 25.293 0 0 0 25.267-25.292l0.077-63.207a25.293 25.293 0 0 0-25.268-25.293H417.152a189.62 189.62 0 0 0-189.62 189.645V771.15c0 13.977 11.316 25.293 25.294 25.293h372.94a170.65 170.65 0 0 0 170.65-170.65V480.384a25.293 25.293 0 0 0-25.293-25.267z" data-v-b2f70082></path></svg></div><div data-v-b2f70082><span data-v-b2f70082>gitee.com/WhenTimeGoesBy</span></div> <div class="grid_icon" data-v-b2f70082><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon" data-v-b2f70082><path d="M874.666667 181.333333H149.333333c-40.533333 0-74.666667 34.133333-74.666666 74.666667v512c0 40.533333 34.133333 74.666667 74.666666 74.666667h725.333334c40.533333 0 74.666667-34.133333 74.666666-74.666667V256c0-40.533333-34.133333-74.666667-74.666666-74.666667z m-725.333334 64h725.333334c6.4 0 10.666667 4.266667 10.666666 10.666667v25.6L512 516.266667l-373.333333-234.666667V256c0-6.4 4.266667-10.666667 10.666666-10.666667z m725.333334 533.333334H149.333333c-6.4 0-10.666667-4.266667-10.666666-10.666667V356.266667l356.266666 224c4.266667 4.266667 10.666667 4.266667 17.066667 4.266666s12.8-2.133333 17.066667-4.266666l356.266666-224V768c0 6.4-4.266667 10.666667-10.666666 10.666667z" data-v-b2f70082></path></svg></div><div data-v-b2f70082><span data-v-b2f70082>fur999immer@gmail.com</span></div></div></div></div></div> <div id="article_container"><div class="card_border content_container" data-v-3a7e974a><div class="frontmatter_info" data-v-3a7e974a><h1 class="frontmatter-title" data-v-3a7e974a>Kong与SSO</h1> <div class="frontmatter-date" data-v-3a7e974a>2023-06-23</div> <div class="card_tag frontmatter_tags" data-v-3a7e974a><span class="icon" data-v-3a7e974a><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" data-v-3a7e974a><path d="M896 682.666667a42.666667 42.666667 0 0 0-42.666667-42.666667h-85.333333v-85.333333a85.333333 85.333333 0 0 0-85.333333-85.333334h-128V384h85.333333a42.666667 42.666667 0 0 0 42.666667-42.666667V170.666667a42.666667 42.666667 0 0 0-42.666667-42.666667H384a42.666667 42.666667 0 0 0-42.666667 42.666667v170.666666a42.666667 42.666667 0 0 0 42.666667 42.666667h85.333333v85.333333H341.333333a85.333333 85.333333 0 0 0-85.333333 85.333334v85.333333H170.666667a42.666667 42.666667 0 0 0-42.666667 42.666667v170.666666a42.666667 42.666667 0 0 0 42.666667 42.666667h256a42.666667 42.666667 0 0 0 42.666666-42.666667v-170.666666a42.666667 42.666667 0 0 0-42.666666-42.666667H341.333333v-85.333333h341.333334v85.333333h-85.333334a42.666667 42.666667 0 0 0-42.666666 42.666667v170.666666a42.666667 42.666667 0 0 0 42.666666 42.666667h256a42.666667 42.666667 0 0 0 42.666667-42.666667z"></path></svg></span> <span class="article_category" data-v-3a7e974a>Kong</span> <span class="icon" style="margin-right: 5px" data-v-3a7e974a><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" data-v-3a7e974a><path d="M985.6 473.6 985.6 473.6l-256 256-256 256 0 0C454.4 1011.2 422.4 1024 384 1024c-38.4 0-70.4-12.8-89.6-38.4l0 0-256-256 0 0C12.8 710.4 0 678.4 0 640c0-38.4 12.8-70.4 38.4-89.6l0 0 256-256 256-256 0 0C569.6 12.8 601.6 0 640 0l256 0c70.4 0 128 57.6 128 128l0 256C1024 422.4 1011.2 454.4 985.6 473.6zM768 128c-70.4 0-128 57.6-128 128 0 70.4 57.6 128 128 128 70.4 0 128-57.6 128-128C896 185.6 838.4 128 768 128z"></path></svg></span> <span class="article_tag" data-v-3a7e974a>Kong</span><span class="article_tag" data-v-3a7e974a>SSO</span></div></div> <div class="content__default" data-v-3a7e974a><h2 id="kong的部署与基本配置"><a href="#kong的部署与基本配置" class="header-anchor">#</a> kong的部署与基本配置</h2> <h3 id="服务器建立两个无需认证的服务"><a href="#服务器建立两个无需认证的服务" class="header-anchor">#</a> 服务器建立两个无需认证的服务</h3> <ul><li>安装服务运行环境</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code>yum <span class="token function">install</span> python3
<span class="token function">sudo</span> pip3 <span class="token function">install</span> <span class="token assign-left variable">Flask</span><span class="token operator">==</span><span class="token number">1.1</span>.4
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>编写服务</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 服务A</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> jsonify

app_a <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_a<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token string">&quot;server A&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment"># # flask --app a run</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app_a<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span>

    
<span class="token comment"># 服务B</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> jsonify

app_b <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_b<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token string">&quot;server B&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment"># # flask --app b run</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app_b<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5001</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><ul><li>开启端口</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> firewall-cmd --add-port<span class="token operator">=</span><span class="token number">5000</span>/tcp <span class="token parameter variable">--permanent</span>
<span class="token function">sudo</span> firewall-cmd --add-port<span class="token operator">=</span><span class="token number">5001</span>/tcp <span class="token parameter variable">--permanent</span>
<span class="token function">sudo</span> firewall-cmd <span class="token parameter variable">--reload</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="安装postgresql"><a href="#安装postgresql" class="header-anchor">#</a> 安装Postgresql</h3> <p>kong需要数据版本大于9.5，yum直接安装的版本为9.2.24<a href="https://blog.csdn.net/feinifi/article/details/96474115" target="_blank" rel="noopener noreferrer">参考文章1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://ken.io/note/centos7-postgresql12-install-and-configuration" target="_blank" rel="noopener noreferrer">参考文章2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>补充：</strong></p> <p>Below is an example to install PostgreSQL 9.6 on RHEL/CentOS 7:</p> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/yum.repos.d/pgdg-96.repo</span>
[pgdg90]
name=PostgreSQL 9.6 RPMs for RHEL/CentOS 7
baseurl=https://yum-archive.postgresql.org/9.6/redhat/rhel-7-x86_64
enabled=1
gpgcheck=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-PGDG
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Now, you can install PostgreSQL 9.6 on RHEL/CentOS 7:<code>yum install postgresql96-server</code>. <br>
通过<code>yum install postgresql96-devel</code>方便后续python安装包的处理</p> <ul><li>查看安装源</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code>yum search postgresql
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>通过yum安装</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 安装老版本 yum install postgresql-server (不可用)</span>

<span class="token comment"># 添加安装包</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
<span class="token comment"># 上述步骤不成功时使用下面的步骤</span>
<span class="token function">curl</span> <span class="token parameter variable">-Lo</span> pgdg-redhat-repo-latest.noarch.rpm <span class="token variable"><span class="token variable">$(</span> https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm&quot;<span class="token variable">)</span></span> <span class="token operator">||</span> <span class="token function">rpm</span> <span class="token parameter variable">-i</span> pgdg-redhat-repo-latest.noarch.rpm

<span class="token comment"># 安装</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> postgresql12 postgresql12-server
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>检查安装版本 - 等初始化完成后在登录数据库</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code>psql <span class="token parameter variable">--version</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>初始化数据库 - 完成后会生成目录 <em>/var/lib/pgsql/12/</em> （老版本*/var/lib/pgsql/data*），配置文件在其中</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 老版本 postgresql-setup initdb</span>
<span class="token function">sudo</span> /usr/pgsql-12/bin/postgresql-12-setup
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>启动服务</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#启动PostgreSQL12服务</span>
<span class="token function">sudo</span> systemctl start postgresql-12
<span class="token comment">#设置PostgreSQL12服务为开机启动</span>
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> postgresql-12

<span class="token comment"># 9.2版本 service postgresql start</span>
<span class="token comment"># 9.6版本 sudo systemctl start postgresql-9.6</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>通过<code>netstat -nat</code>可看到运行端口 <em>5432</em></li> <li><code>psql postgres</code>通过root用户登录，第一次会失败。使用<code>psql -U postgres</code>以切换到postgres用户登录，会提示认证失败</li> <li>通过<code>su - postgres</code>切换到postgres用户后，执行<code>psql</code>进行登录</li> <li>通过<code>vim /var/lib/pgsql/data/pg_hba.conf</code>修改配置</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 不切换用户登录 peer改为trust</span>
<span class="token builtin class-name">local</span>		all		all							peer
<span class="token comment"># kong的迁移</span>
<span class="token function">host</span>		all		all		<span class="token number">127.0</span>.0.1/32		trust
<span class="token comment"># 远程登录 - 增加如下行</span>
<span class="token function">host</span>		all		all		<span class="token number">0.0</span>.0.0/0			md5
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>修改监听地址 - 非宿主机访问 <code>vim /var/lib/pgsql/data/postgresql.conf</code></li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 修改为 '*'</span>
listen_addresses <span class="token operator">=</span> <span class="token string">'localhost'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>更新完配置后重启服务。可使用<code>psql -U postgres</code>直接登录，<code>\q</code>退出</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> systemctl restart postgresql-12
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>在postgresql内修改登录密码.</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 方法一</span>
<span class="token punctuation">\</span>password
<span class="token comment"># 方法二</span>
alter user postgres with password <span class="token string">'target_password'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>开启端口</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> firewall-cmd --add-port<span class="token operator">=</span><span class="token number">5432</span>/tcp <span class="token parameter variable">--permanent</span>
<span class="token function">sudo</span> firewall-cmd <span class="token parameter variable">--reload</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>补充：</strong></p> <ul><li><code>\l</code> 查看数据库</li> <li><code>\c</code>选择数据库</li> <li><code>\d</code>查看所有表格</li> <li><code>\d 表格名</code>查看指定表格</li> <li>创建表格</li></ul> <div class="language-sql macos line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> login_user<span class="token punctuation">(</span>
   phone <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
   username <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
   password <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
   <span class="token keyword">level</span> <span class="token keyword">smallint</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="安装kong"><a href="#安装kong" class="header-anchor">#</a> 安装Kong</h3> <p>参考<a href="https://docs.konghq.com/gateway/latest/install/linux/rhel/" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>安装nignx</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code>yum <span class="token function">install</span> epel-release
yum update
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>下载安装包</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-Lo</span> kong-enterprise-edition-3.3.0.0.rpm <span class="token variable"><span class="token variable">$(</span> <span class="token function">rpm</span> <span class="token parameter variable">--eval</span> <span class="token string">&quot;https://download.konghq.com/gateway-3.x-rhel-%{rhel}/Packages/k/kong-enterprise-edition-3.3.0.0.rhel%{rhel}.amd64.rpm&quot;</span><span class="token variable">)</span></span> <span class="token operator">||</span> <span class="token function">rpm</span> <span class="token parameter variable">-i</span> 

<span class="token comment"># 老版本</span>
<span class="token function">curl</span> <span class="token parameter variable">-Lo</span> kong-1.1.3.el7.noarch.rpm <span class="token variable"><span class="token variable">$(</span> <span class="token function">rpm</span> <span class="token parameter variable">--eval</span> <span class="token string">&quot;https://download.konghq.com/gateway-1.x-centos-7/Packages/k/kong-1.1.3.el7.noarch.rpm&quot;</span><span class="token variable">)</span></span> <span class="token operator">||</span> <span class="token function">rpm</span> <span class="token parameter variable">-i</span> kong-1.1.3.el7.noarch.rpm
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>使用yum安装</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> yum <span class="token function">install</span> kong-enterprise-edition-3.3.0.0.rpm
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>配置文件 <em>/etc/kong/kong.conf.default</em></p> <h3 id="配置与启动"><a href="#配置与启动" class="header-anchor">#</a> 配置与启动</h3> <ul><li>复制并修改 <em>/etc/kong/kong.config.default</em> 。</li> <li>建立kong在postgresql内的数据库</li></ul> <div class="language-sql macos line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> kong <span class="token keyword">WITH</span> PASSWORD <span class="token string">'super_secret'</span><span class="token punctuation">;</span> 
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> kong OWNER kong<span class="token punctuation">;</span>
<span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">privileges</span> <span class="token keyword">on</span> <span class="token keyword">database</span> kong <span class="token keyword">to</span> kong<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>配置数据库的账号与密码</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code>pg_user <span class="token operator">=</span> kong
pg_password <span class="token operator">=</span> password
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>迁移</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">KONG_PASSWORD</span><span class="token operator">=</span><span class="token string">&quot;pwd&quot;</span> kong migrations bootstrap <span class="token parameter variable">-c</span> <span class="token string">&quot;PATH_TO_KONG.CONF_FILE&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>启动</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code>kong start <span class="token parameter variable">-c</span> <span class="token string">&quot;PATH_TO_KONG.CONF_FILE&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>开放端口 - 8000服务api转发端口，8001kong管理端口</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> firewall-cmd --add-port<span class="token operator">=</span><span class="token number">8000</span>/tcp <span class="token parameter variable">--permanent</span>
<span class="token function">sudo</span> firewall-cmd <span class="token parameter variable">--reload</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="kong代理后端服务"><a href="#kong代理后端服务" class="header-anchor">#</a> kong代理后端服务</h3> <ul><li>声明一个需要kong接管的后端服务（记录标识名，服务名使用0.0.0.0）</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> POST <span class="token punctuation">\</span>
  <span class="token parameter variable">--url</span> http://localhost:8001/services/ <span class="token punctuation">\</span>
  <span class="token parameter variable">--data</span> <span class="token string">'name=服务标识符'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--data</span> <span class="token string">'url=http://服务地址'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>指明服务转发的host（为声明的服务添加路由，注意字段需为客户端请求的host，详见补充）</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> POST <span class="token punctuation">\</span>
	<span class="token comment"># 管理地址/services/服务标识符/routers</span>
  <span class="token parameter variable">--url</span> http://localhost:8001/services/服务标识符/routes <span class="token punctuation">\</span>
  <span class="token comment"># 指明转发host规则：即后续请求头中携带指定host值字段将转发到对应的服务</span>
  <span class="token parameter variable">--data</span> <span class="token string">'hosts[]=example.com'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>让kong转发到指定的服务</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> GET <span class="token punctuation">\</span>
<span class="token comment"># 请求kong的api服务端口，让kong根据路由配置的host转发到对应的服务</span>
  <span class="token parameter variable">--url</span> http://localhost:8000/ <span class="token punctuation">\</span>
  <span class="token parameter variable">--header</span> <span class="token string">'Host: example.com'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如配置测试服务A和B，以A为例</p> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 服务标识符命名为service_a，服务a的ip必须为0.0.0.0</span>
<span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">--url</span> http://localhost:8001/services/ <span class="token parameter variable">--data</span> <span class="token string">'name=service_a'</span> <span class="token parameter variable">--data</span> <span class="token string">'url=http://0.0.0.0:5000'</span>

<span class="token comment"># 添加kong的转发路由</span>
<span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">--url</span> http://localhost:8001/services/service_a/routes <span class="token parameter variable">--data</span> <span class="token string">'hosts[]=service_a.com'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>补充：</strong></p> <ul><li><p>路由host字段的说明</p> <ul><li>根据浏览器安全策略，浏览器发出的请求头中的Host字段根据为实际请求地址<code>http://{host}:{port|80}</code>中的<code>host</code>值，且不可自定义。</li> <li>在生产环境中，在一台服务器上部署kong网关在8000端口。如需转发多个后端请求，需全部请求到该服务器的8000端口，才可进入kong网关。</li> <li>由于host值不可指定，而kong网关需要host值进行路由区分，因此需为每个服务准备不同的域名，所有域名皆指向kong网关所在ip。</li></ul></li> <li><p>路由的查看，修改，删除</p></li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 查看</span>
<span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> GET <span class="token parameter variable">--url</span>  http://localhost:8001/services/服务标识符

<span class="token comment"># 修改</span>
<span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> PATCH <span class="token parameter variable">--url</span>  http://localhost:8001/services/服务标识符 <span class="token punctuation">\</span> 
<span class="token parameter variable">--data</span> 	<span class="token string">'name=服务的新标识符'</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--data</span> <span class="token string">'retries=6'</span> <span class="token comment"># 其他选项</span>

<span class="token comment"># 删除</span>
<span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> DELETE <span class="token parameter variable">--url</span>  http://localhost:8001/services/服务标识符 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>代理完成后移除原服务端口，只对外暴漏kong端口通过代理请求对应服务</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> firewall-cmd --remove-port<span class="token operator">=</span><span class="token number">5000</span>/tcp <span class="token parameter variable">--permanent</span>
<span class="token function">sudo</span> firewall-cmd --remove-port<span class="token operator">=</span><span class="token number">5001</span>/tcp <span class="token parameter variable">--permanent</span>
<span class="token function">sudo</span> firewall-cmd <span class="token parameter variable">--reload</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="jwt微服务认证的分析"><a href="#jwt微服务认证的分析" class="header-anchor">#</a> jwt微服务认证的分析</h2> <p>通过kong的jwt插件可实现对用户的认证。有两个设计方向可供选择：</p> <ul><li>jwt认证可以对服务或路由生效。由于服务中一些接口需要无权限也可访问，可将一个服务的接口设置两个kong服务。将需要认证的接口放置一个服务，并设置特殊路径，如<code>/auth/*</code>。将无需认证接口放置另一个服务，并设置特殊路径<code>/free/*</code>。这样对kong来说，配置不同的服务，即可避免配置两个路由指向同一服务，需认证接口通过免认证路由请求而引起的安全性问题。(不同权限等级需不同前缀，较为复杂)</li> <li>将全部数据接口与权限等级记入数据表中，根据路径与token中的用户权限查表鉴权，判断是否需要jwt认证，不需要直接放行后端，需要jwt认证的接口验证token得到用户权限，判断权限等级是否匹配。对token验证不通过的返回401，对权限不足的返回403。</li></ul> <h3 id="建立需要不同用户权限的服务"><a href="#建立需要不同用户权限的服务" class="header-anchor">#</a> 建立需要不同用户权限的服务</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 服务A</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> jsonify

app_a <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_a<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token string">'server A - level 0'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_a<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/auth'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token string">'server A - level 1'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_a<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&quot;/admin&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token string">'server A - level 2'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment"># # flask --app a run</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app_a<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span>


    
<span class="token comment"># 服务B</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> jsonify

app_b <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_b<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token string">'server B - level 0'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_b<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/auth'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token string">'server B - level 1'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_b<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token string">'server B - level 2'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment"># # flask --app b run</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app_b<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5001</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h3 id="部署插件"><a href="#部署插件" class="header-anchor">#</a> 部署插件</h3> <p><a href="https://blog.csdn.net/zz18435842675/article/details/120648334" target="_blank" rel="noopener noreferrer">参考文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>kong的插件默认路径为 <em>/usr/local/share/lua/5.1/kong/plugins</em></p> <ul><li><em>/etc/kong/kong.conf</em> 中配置插件路径<code>lua_package_path = /&lt;path-to-plugin-location&gt;/kong/plugins/?.lua;;</code>。其中：<code>;;</code>代表默认路径；需确保最后两个路径为 <em>/kong/plugins/</em></li> <li>将插件文件夹放入指定目录（不生效时放入默认目录）</li> <li>修改 <em>/etc/kong/kong.conf</em> 中的<code>plugins = bundled</code>，用逗号分隔在后方补充自定义插件</li> <li>修改 <em>/usr/local/share/lua/5.1/kong/constants.lua</em> ，添加自定义插件</li> <li>通过<code>kong reload -c &quot;PATH_TO_KONG.CONF_FILE&quot;</code>重启kong</li> <li>通过命令将插件绑定到服务</li></ul> <div class="language-bash macos line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST http://kong_ip:8001/services/<span class="token operator">&lt;</span>service-name-or-id<span class="token operator">&gt;</span>/plugins <span class="token parameter variable">-d</span> <span class="token string">&quot;name=my-custom-plugin&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="插件开发"><a href="#插件开发" class="header-anchor">#</a> 插件开发</h2> <p>kong插件的文件结构<a href="https://github.com/qianyugang/kong-docs-cn/blob/master/GUIDES%26REFERENCES/plugin-development/file-structure.md" target="_blank" rel="noopener noreferrer">文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>handler.lua : 插件的主逻辑</li> <li>schema.lua : 配置信息。</li> <li>daos.lua : 数据库模型类。可自行建表后通过daos实例连接。如需迁移建表需要编写迁移文件。</li></ul> <p>下面将用jwt token的认证为例，说明一个接口认证插件的开发流程，源码<a href="https://github.com/SayNop/kong_jwt_url_auth" target="_blank" rel="noopener noreferrer">在此<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h3 id="框架搭建"><a href="#框架搭建" class="header-anchor">#</a> 框架搭建</h3> <p>一个最基本的kong插件需包含两个文件 <em>handler.lua</em> 与<em>schema.lua</em></p> <ul><li>handler的开发需按照以下格式进行</li></ul> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token comment">-- 必要的导包</span>
<span class="token keyword">local</span> kong <span class="token operator">=</span> kong
<span class="token keyword">local</span> BasePlugin <span class="token operator">=</span> require <span class="token string">&quot;kong.plugins.base_plugin&quot;</span>

<span class="token comment">-- 声明自定义handler类</span>
<span class="token keyword">local</span> RequestAuthHandler <span class="token operator">=</span> BasePlugin<span class="token punctuation">:</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">-- 定义优先级与版本号</span>
RequestAuthHandler<span class="token punctuation">.</span>PRIORITY <span class="token operator">=</span> <span class="token number">800</span>
RequestAuthHandler<span class="token punctuation">.</span>VERSION <span class="token operator">=</span> <span class="token string">&quot;1.0.0&quot;</span>

<span class="token comment">-- 自定义handler的new方法</span>
<span class="token keyword">function</span> RequestAuthHandler<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">-- 传入插件名</span>
    RequestAuthHandler<span class="token punctuation">.</span>super<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">&quot;kong_jwt_url_auth&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>


<span class="token comment">-- 主逻辑，access方法处理请求到来时的逻辑</span>
<span class="token keyword">function</span> RequestAuthHandler<span class="token punctuation">:</span><span class="token function">access</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
    RequestAuthHandler<span class="token punctuation">.</span>super<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span>
  	<span class="token comment">-- 以下是主逻辑</span>
    <span class="token comment">-- 例如：pass options request</span>
    <span class="token keyword">if</span> kong<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">get_method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;OPTIONS&quot;</span> <span class="token keyword">then</span>
      <span class="token keyword">return</span>
    <span class="token keyword">end</span>
  
<span class="token keyword">end</span>

<span class="token comment">-- 返回自定义handler</span>
<span class="token keyword">return</span> RequestAuthHandler

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><ul><li>schema中的配置信息作为handler实例的传入参数。可通过传入参数调用配置信息<code>fields</code>中的预定义变量。配置项在绑定服务时传入了数据库，如后续更新，需要 <strong>删除plugins表中对应的项后重新进行绑定</strong> (<code>delete from plugins where name = '&lt;plugin_name&gt;' ;</code>)。</li></ul> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token keyword">local</span> typedefs <span class="token operator">=</span> require <span class="token string">&quot;kong.db.schema.typedefs&quot;</span>

<span class="token keyword">return</span> <span class="token punctuation">{</span>
    name <span class="token operator">=</span> <span class="token string">&quot;xxx&quot;</span><span class="token punctuation">,</span>  <span class="token comment">-- 插件名</span>
    fields <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">{</span> consumer <span class="token operator">=</span> typedefs<span class="token punctuation">.</span>no_consumer <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">-- 插件的消费者</span>
        <span class="token punctuation">{</span> protocols <span class="token operator">=</span> typedefs<span class="token punctuation">.</span>protocols_http <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">-- 插件协议</span>
        <span class="token punctuation">{</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
            type <span class="token operator">=</span> <span class="token string">&quot;record&quot;</span><span class="token punctuation">,</span>
            <span class="token comment">-- handler的配置信息 或 所需要的预定义变量</span>
            fields <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">-- jwt secret key</span>
                    secret_key <span class="token operator">=</span> <span class="token punctuation">{</span> type <span class="token operator">=</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span> default <span class="token operator">=</span> <span class="token string">&quot;1234567891234567891234567891234567891234567&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span> 
                    <span class="token comment">-- sign deliver, iss, not check</span>
                    key_claim_name <span class="token operator">=</span> <span class="token punctuation">{</span> type <span class="token operator">=</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span> default <span class="token operator">=</span> <span class="token string">&quot;iss&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="权限认证"><a href="#权限认证" class="header-anchor">#</a> 权限认证</h3> <p>使用kong官方插件 <em>jwt</em> 中的jwt认证组件<a href="https://github.com/Kong/kong/blob/master/kong/plugins/jwt/jwt_parser.lua" target="_blank" rel="noopener noreferrer">jwt_parser.lua<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>进行验证</p> <p>在handler调用 <em>jwt</em> 插件内的认证组件并编写token认证逻辑</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token comment">-- 导入所需内容</span>
<span class="token keyword">local</span> get_header <span class="token operator">=</span> kong<span class="token punctuation">.</span>request<span class="token punctuation">.</span>get_header
<span class="token keyword">local</span> set_header <span class="token operator">=</span> kong<span class="token punctuation">.</span>service<span class="token punctuation">.</span>request<span class="token punctuation">.</span>set_header
<span class="token keyword">local</span> jwt_decoder <span class="token operator">=</span> require <span class="token string">&quot;kong.plugins.jwt.jwt_parser&quot;</span>

<span class="token comment">-- 省略</span>

<span class="token keyword">function</span> RequestAuthHandler<span class="token punctuation">:</span><span class="token function">access</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
    RequestAuthHandler<span class="token punctuation">.</span>super<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span>
    <span class="token comment">-- pass options request</span>
    <span class="token keyword">if</span> kong<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">get_method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;OPTIONS&quot;</span> <span class="token keyword">then</span>
      <span class="token keyword">return</span>
    <span class="token keyword">end</span>

    <span class="token comment">-- 0. 获取token</span>
    <span class="token keyword">local</span> bear_token <span class="token operator">=</span> <span class="token function">get_header</span><span class="token punctuation">(</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bear_token <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">or</span> string<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>bear_token<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">~=</span> <span class="token string">&quot;Bearer &quot;</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
        kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span><span class="token string">&quot;miss bearer&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> kong<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">,</span> success <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">&quot;UnAuthorized&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token keyword">local</span> token <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>bear_token<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment">-- 1. 解码token</span>
  	<span class="token comment">-- 1.1 base64解码token</span>
    <span class="token keyword">local</span> jwt<span class="token punctuation">,</span> err <span class="token operator">=</span> jwt_decoder<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token keyword">then</span>
      <span class="token comment">-- 解码失败，token有问题</span>
      kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span><span class="token string">&quot;decode error&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> kong<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">,</span> success <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">&quot;UnAuthorized&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>

  	<span class="token comment">-- 2. 验证</span>
    <span class="token comment">-- 2.1 获取payload</span>
    <span class="token keyword">local</span> claims <span class="token operator">=</span> jwt<span class="token punctuation">.</span>claims
    <span class="token comment">-- 2.2 获取token header</span>
    <span class="token keyword">local</span> header <span class="token operator">=</span> jwt<span class="token punctuation">.</span>header
    <span class="token comment">-- 2.3 获取私钥</span>
    <span class="token comment">-- local secret_key = &quot;1234567891234567891234567891234567891234567&quot;</span>
    kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span>secret_key<span class="token punctuation">)</span>
    <span class="token comment">-- 2.4 ***** 验签 *****</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> jwt<span class="token punctuation">:</span><span class="token function">verify_signature</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span>secret_key<span class="token punctuation">)</span> <span class="token keyword">then</span>
        kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span><span class="token string">&quot;check secret fail&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> kong<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">,</span> success <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">&quot;UnAuthorized&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token comment">-- 2.5 ***** 验证token有效期 *****</span>
    <span class="token keyword">local</span> ok_claims<span class="token punctuation">,</span> errors <span class="token operator">=</span> jwt<span class="token punctuation">:</span><span class="token function">verify_registered_claims</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span>claims_to_verify<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> ok_claims <span class="token keyword">then</span>
        kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span>
        <span class="token keyword">return</span> kong<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">,</span> success <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">&quot;Token Expired&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    <span class="token comment">-- 2.6 获取payload中的用户标识符</span>
    <span class="token keyword">local</span> phone <span class="token operator">=</span> claims<span class="token punctuation">[</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> phone <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">then</span>
        kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span><span class="token string">&quot;miss phone in payload&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> kong<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">,</span> success <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">&quot;UnAuthorized&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span>

  	<span class="token comment">-- 3. 将用户标识符塞入header，方便后端服务查询对应用户信息</span>
    <span class="token function">set_header</span><span class="token punctuation">(</span><span class="token string">&quot;x-auth-phone&quot;</span><span class="token punctuation">,</span> phone<span class="token punctuation">)</span>

<span class="token keyword">end</span>

<span class="token comment">-- 省略</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><p><strong>注意：</strong></p> <p>开发过程中可使用<code>kong.log.inspect()</code>进行关键信息打印，对复杂类型会进行格式化处理（性能开销），在生产环境中需要移除或使用<code>kong.log.notice()</code>。</p> <h3 id="数据库查询"><a href="#数据库查询" class="header-anchor">#</a> 数据库查询</h3> <p>通过 <em>daos.lua</em> 中对目标表的 <em>daos实例（模型类）</em> 声明，以便在 <em>handler.lua</em> 中进行数据库查询。</p> <ul><li><p>关于数据库表生成的两种方式（与后端开发类似）：</p> <ul><li><p>可通过 <em>postgresql ctl</em> 在kong连接的数据库中创建目标table，再根据table的字段定义daos实例</p> <div class="language-sql macos line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> login_user<span class="token punctuation">(</span>
phone <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
username <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
password <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token keyword">level</span> <span class="token keyword">smallint</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> login_user <span class="token punctuation">(</span>phone<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> <span class="token keyword">level</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'13011111111'</span><span class="token punctuation">,</span> <span class="token string">'alice'</span><span class="token punctuation">,</span> <span class="token string">'88888888'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> api_mgr<span class="token punctuation">(</span>
sign <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>  <span class="token comment">-- kong插件只可查询主键，主键需包含查询条件</span>
path <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
service <span class="token keyword">smallint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
auth_level <span class="token keyword">smallint</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> api_mgr <span class="token punctuation">(</span>sign<span class="token punctuation">,</span> path<span class="token punctuation">,</span> service<span class="token punctuation">,</span> auth_level<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'0/'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> api_mgr <span class="token punctuation">(</span>sign<span class="token punctuation">,</span> path<span class="token punctuation">,</span> service<span class="token punctuation">,</span> auth_level<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'0/auth'</span><span class="token punctuation">,</span> <span class="token string">'/auth'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> api_mgr <span class="token punctuation">(</span>sign<span class="token punctuation">,</span> path<span class="token punctuation">,</span> service<span class="token punctuation">,</span> auth_level<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'0/admin'</span><span class="token punctuation">,</span> <span class="token string">'/admin'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> api_mgr <span class="token punctuation">(</span>sign<span class="token punctuation">,</span> path<span class="token punctuation">,</span> service<span class="token punctuation">,</span> auth_level<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'1/'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> api_mgr <span class="token punctuation">(</span>sign<span class="token punctuation">,</span> path<span class="token punctuation">,</span> service<span class="token punctuation">,</span> auth_level<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'1/auth'</span><span class="token punctuation">,</span> <span class="token string">'/auth'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> api_mgr <span class="token punctuation">(</span>sign<span class="token punctuation">,</span> path<span class="token punctuation">,</span> service<span class="token punctuation">,</span> auth_level<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'1/admin'</span><span class="token punctuation">,</span> <span class="token string">'/admin'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div></li> <li><p>在 <em>daos.lua</em> 编写完成后，编写迁移文件 <em>migrations/init.lua</em> 与 <em>migrations/000_base_&lt;plugin_name&gt;.lua</em> 。通过kong的迁移命令在数据库中生成table。</p></li></ul></li> <li><p>daos.lua 实例</p></li></ul> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span>
      primary_key <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;phone&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  
      name <span class="token operator">=</span> <span class="token string">&quot;login_user&quot;</span><span class="token punctuation">,</span>  <span class="token comment">-- 数据表名称</span>
      endpoint_key <span class="token operator">=</span> <span class="token string">&quot;phone&quot;</span><span class="token punctuation">,</span>  <span class="token comment">-- handler中的查询字段</span>
      cache_key <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;phone&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">-- 缓存字段</span>
      fields <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token comment">-- 实例中的type为lua基本类型</span>
            <span class="token punctuation">{</span> phone <span class="token operator">=</span> <span class="token punctuation">{</span> type <span class="token operator">=</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">,</span> unique <span class="token operator">=</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">-- 主键 手机号作为用户唯一标识符</span>
            <span class="token punctuation">{</span> username <span class="token operator">=</span> <span class="token punctuation">{</span> type <span class="token operator">=</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> password <span class="token operator">=</span> <span class="token punctuation">{</span> type <span class="token operator">=</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> level <span class="token operator">=</span> <span class="token punctuation">{</span> type <span class="token operator">=</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">,</span> default <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">-- 用户权限等级</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ul><li>handler中的数据库查询核心代码</li></ul> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token comment">-- payload中获取用户标识符</span>
<span class="token keyword">local</span> phone <span class="token operator">=</span> claims<span class="token punctuation">[</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">]</span>
<span class="token keyword">if</span> phone <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">then</span>
  kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span><span class="token string">&quot;miss phone in payload&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> kong<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">,</span> success <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">&quot;UnAuthorized&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span>

<span class="token comment">-- 通过用户标识符查询用户对象 select用于查询主键</span>
<span class="token keyword">local</span> user<span class="token punctuation">,</span> err <span class="token operator">=</span> kong<span class="token punctuation">.</span>db<span class="token punctuation">.</span>login_user<span class="token punctuation">:</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">{</span> phone <span class="token operator">=</span> phone <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token keyword">then</span>
  <span class="token keyword">return</span> <span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> user <span class="token keyword">then</span>
  kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span><span class="token string">&quot;login user not found&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> kong<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">,</span> success <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">&quot;UnAuthorized&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 通过用户对象获取用户权限等级</span>
<span class="token function">set_header</span><span class="token punctuation">(</span><span class="token string">&quot;x-auth-level&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>level<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="账号多登录的判断"><a href="#账号多登录的判断" class="header-anchor">#</a> 账号多登录的判断</h3> <p>通过redis缓存token，kong插件查询token后进行判断<br>
redis连接代码参考<a href="https://juejin.cn/post/6844904197662441486" target="_blank" rel="noopener noreferrer">文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>服务端</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 服务端redis支持</span>
<span class="token comment"># sudo pip3 install redis==3.5.3</span>

<span class="token comment"># ** 登录接口中的判断 **</span>
<span class="token comment"># 查询该用户之前是否存在有效期内的token</span>
old_token <span class="token operator">=</span> redis_conn<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'login:'</span> <span class="token operator">+</span> phone<span class="token punctuation">)</span>
<span class="token comment"># 该用户存在已登录的token，将旧token标记为失效token</span>
<span class="token keyword">if</span> old_token<span class="token punctuation">:</span>
    <span class="token comment"># 在token的最大过期时间内，该token都将标记为失效token</span>
    redis_conn<span class="token punctuation">.</span>setex<span class="token punctuation">(</span><span class="token string">'conflict:'</span> <span class="token operator">+</span> old_token<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># 记录该用户的最新token，下一次出现重复登录时可获取到旧token</span>
redis_conn<span class="token punctuation">.</span>setex<span class="token punctuation">(</span><span class="token string">'login:'</span> <span class="token operator">+</span> phone<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>网关</li></ul> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token keyword">local</span> redis <span class="token operator">=</span> require <span class="token string">&quot;resty.redis&quot;</span>
<span class="token keyword">local</span> redis_conn <span class="token operator">=</span> redis<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
redis_conn<span class="token punctuation">:</span><span class="token function">set_timeouts</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment">-- 1 sec</span>

<span class="token keyword">local</span> ok<span class="token punctuation">,</span> err <span class="token operator">=</span> redis_conn<span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span>redisHost<span class="token punctuation">,</span> redisPort<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> ok <span class="token keyword">then</span>
    kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;failed to connect redis: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token keyword">else</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>redisPwd <span class="token operator">~=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">then</span>
        <span class="token keyword">local</span> auth<span class="token punctuation">,</span> err <span class="token operator">=</span> redis_conn<span class="token punctuation">:</span><span class="token function">auth</span><span class="token punctuation">(</span>redisPwd<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> auth <span class="token keyword">then</span>
            kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;failed to authenticate: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>

    <span class="token keyword">local</span> conflict_res<span class="token punctuation">,</span> err <span class="token operator">=</span> redis_conn<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'conflict'</span><span class="token operator">..</span>token<span class="token punctuation">)</span>
    <span class="token keyword">if</span> conflict_res <span class="token operator">~=</span> ngx<span class="token punctuation">.</span>null <span class="token keyword">then</span>
        kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">&quot;user &quot;</span><span class="token operator">..</span>phone<span class="token operator">..</span> <span class="token string">&quot;  token conflict&quot;</span><span class="token punctuation">)</span>
        kong<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">,</span> success <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">&quot;Token Conflict&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token keyword">end</span>
    <span class="token comment">-- 使用连接池</span>
    <span class="token keyword">local</span> ok<span class="token punctuation">,</span> err <span class="token operator">=</span> redis_conn<span class="token punctuation">:</span><span class="token function">set_keepalive</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">-- (超时时间 ms, 连接池大小)</span>
<span class="token keyword">end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="服务端适配"><a href="#服务端适配" class="header-anchor">#</a> 服务端适配</h2> <h3 id="服务端生成token"><a href="#服务端生成token" class="header-anchor">#</a> 服务端生成token</h3> <p>通过PyJWT包进行token的生成，需要在payload中添加 <code>exp</code>（过期时间）与<code>nbf</code>（生成时间）</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> jwt

secret_key <span class="token operator">=</span> <span class="token string">'1234567891234567891234567891234567891234567'</span>
now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span>
expiry <span class="token operator">=</span> now <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment"># 传入payload，私钥，加密算法</span>
token <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'phone'</span><span class="token punctuation">:</span> <span class="token string">'13011111111'</span><span class="token punctuation">,</span> <span class="token string">'exp'</span><span class="token punctuation">:</span> expiry<span class="token punctuation">,</span> <span class="token string">'nbf'</span><span class="token punctuation">:</span> now<span class="token punctuation">}</span><span class="token punctuation">,</span> secret_key<span class="token punctuation">,</span> algorithm<span class="token operator">=</span><span class="token string">'HS256'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="服务端对postgresql的支持"><a href="#服务端对postgresql的支持" class="header-anchor">#</a> 服务端对Postgresql的支持</h3> <ul><li><p>通过<code>sudo pip3 install Flask-SQLAlchemy==2.5.1</code>安装Flask-SQLAlchemy。</p> <ul><li>问题1： <em>src/greenlet/greenlet.cpp:16:20: 致命错误：Python.h：没有那个文件或目录</em> 。解决办法：  <code>sudo yum install -y python3-devel</code>安装</li> <li>问题2： <em>inline T borrow() const G_NOEXCEPT</em>  即gcc报错。 解决办法：升级pip <code>python3 -m pip install --upgrade pip</code></li> <li>问题3： 服务端报错<em>ModuleNotFoundError: No module named 'psycopg2'</em> 。 解决办法： 安装psycopg2</li></ul></li> <li><p>通过<code>sudo pip3 install psycopg2-binary</code>安装psycopg2。</p> <ul><li>问题： <em>Error: pg_config executable not found.</em> 。 解决办法： 确保安装 <em>postgresql96-devel</em> 后，在环境变量PATH中指明pg_config的位置 <em>/usr/pgsql-9.6/bin</em></li></ul></li> <li><p>Flask连接Postgresql</p></li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> jwt
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> jsonify<span class="token punctuation">,</span> request
<span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy

<span class="token comment"># 连接数据库</span>
app_a <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app_a<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SQLALCHEMY_DATABASE_URI'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'postgresql://kong:1234@127.0.0.1/kong'</span>
app_a<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SQLALCHEMY_COMMIT_ON_TEARDOWN'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span>app_a<span class="token punctuation">)</span>

<span class="token comment"># 模型类</span>
<span class="token keyword">class</span> <span class="token class-name">LoginUser</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'login_user'</span>
    phone <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">'手机号'</span><span class="token punctuation">)</span>
    username <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">'昵称'</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">'密码'</span><span class="token punctuation">)</span>
    level <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>SMALLINT<span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">'用户权限'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'&lt;User %r&gt;'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>phone


<span class="token decorator annotation punctuation">@app_a<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/auth'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    phone <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>phone<span class="token punctuation">,</span> password<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'success'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'msg'</span><span class="token punctuation">:</span> <span class="token string">'Missing required params!'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment"># 查库进行账号认证</span>
    user <span class="token operator">=</span> LoginUser<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>phone<span class="token operator">=</span>phone<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user<span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'success'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'msg'</span><span class="token punctuation">:</span> <span class="token string">'User not exist!'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> user<span class="token punctuation">.</span>password <span class="token operator">!=</span> password<span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'success'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'msg'</span><span class="token punctuation">:</span> <span class="token string">'Password incorrect!'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'success'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">'msg'</span><span class="token punctuation">:</span> <span class="token string">'server A - level 1'</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'header'</span><span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment"># # flask --app a run</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app_a<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h3 id="服务端完整代码"><a href="#服务端完整代码" class="header-anchor">#</a> 服务端完整代码</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> jwt
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta
<span class="token keyword">from</span> redis <span class="token keyword">import</span> StrictRedis
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> jsonify<span class="token punctuation">,</span> request<span class="token punctuation">,</span> current_app
<span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy

<span class="token comment"># 连接redis与postgresql</span>
app_a <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app_a<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SQLALCHEMY_DATABASE_URI'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'postgresql://kong:1234@127.0.0.1/kong'</span>
app_a<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SQLALCHEMY_COMMIT_ON_TEARDOWN'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span>app_a<span class="token punctuation">)</span>
app_a<span class="token punctuation">.</span>redis_master <span class="token operator">=</span> StrictRedis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span> decode_responses<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Role</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'api_mgr'</span>
    sign <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">'api签名'</span><span class="token punctuation">)</span>
    path <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">'路径'</span><span class="token punctuation">)</span>
    service <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>SMALLINT<span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">'服务ID'</span><span class="token punctuation">)</span>
    auth_level <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>SMALLINT<span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">'api权限'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'&lt;Api %r&gt;'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>sign


<span class="token keyword">class</span> <span class="token class-name">LoginUser</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'login_user'</span>
    phone <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">'手机号'</span><span class="token punctuation">)</span>
    username <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">'昵称'</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">'密码'</span><span class="token punctuation">)</span>
    level <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>SMALLINT<span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">'用户权限'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'&lt;User %r&gt;'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>phone


<span class="token decorator annotation punctuation">@app_a<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># token生成</span>
    secret_key <span class="token operator">=</span> <span class="token string">'1234567891234567891234567891234567891234567'</span>
    now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span>
    expiry <span class="token operator">=</span> now <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
    token <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'phone'</span><span class="token punctuation">:</span> <span class="token string">'13011111111'</span><span class="token punctuation">,</span> <span class="token string">'exp'</span><span class="token punctuation">:</span> expiry<span class="token punctuation">,</span> <span class="token string">'nbf'</span><span class="token punctuation">:</span> now<span class="token punctuation">}</span><span class="token punctuation">,</span> secret_key<span class="token punctuation">,</span> algorithm<span class="token operator">=</span><span class="token string">'HS256'</span><span class="token punctuation">)</span>

    <span class="token comment"># 测试对postgresql的支持</span>
    users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">'phone'</span><span class="token punctuation">:</span> user<span class="token punctuation">.</span>phone<span class="token punctuation">,</span> <span class="token string">'username'</span><span class="token punctuation">:</span> user<span class="token punctuation">.</span>username<span class="token punctuation">}</span> <span class="token keyword">for</span> user <span class="token keyword">in</span> LoginUser<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token comment"># 账号多登录的处理</span>
    old_token <span class="token operator">=</span> current_app<span class="token punctuation">.</span>redis_master<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'login:13011111111'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> old_token<span class="token punctuation">:</span>
        current_app<span class="token punctuation">.</span>redis_master<span class="token punctuation">.</span>setex<span class="token punctuation">(</span><span class="token string">'conflict:'</span> <span class="token operator">+</span> old_token<span class="token punctuation">,</span> <span class="token number">3600</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    current_app<span class="token punctuation">.</span>redis_master<span class="token punctuation">.</span>setex<span class="token punctuation">(</span><span class="token string">'login:13011111111'</span><span class="token punctuation">,</span> <span class="token number">3600</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">,</span> token1<span class="token punctuation">)</span>

    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">'success'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token string">'msg'</span><span class="token punctuation">:</span> <span class="token string">'server A - level 0'</span><span class="token punctuation">,</span>
        <span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'header'</span><span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'token'</span><span class="token punctuation">:</span> token<span class="token punctuation">,</span>
            <span class="token string">'users'</span><span class="token punctuation">:</span> users
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_a<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/auth'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    phone <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>phone<span class="token punctuation">,</span> password<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'success'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'msg'</span><span class="token punctuation">:</span> <span class="token string">'Missing required params!'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment"># 测试对postgresql的支持</span>
    user <span class="token operator">=</span> LoginUser<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>phone<span class="token operator">=</span>phone<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user<span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'success'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'msg'</span><span class="token punctuation">:</span> <span class="token string">'User not exist!'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> user<span class="token punctuation">.</span>password <span class="token operator">!=</span> password<span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'success'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'msg'</span><span class="token punctuation">:</span> <span class="token string">'Password incorrect!'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'success'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">'msg'</span><span class="token punctuation">:</span> <span class="token string">'server A - level 1'</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'header'</span><span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_a<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&quot;/admin&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 接口权限与用户权限不匹配的测试</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'success'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">'msg'</span><span class="token punctuation">:</span> <span class="token string">'server A - level 2'</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'header'</span><span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment"># # flask --app a run</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app_a<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br></div></div><h2 id="部署至生产服务器"><a href="#部署至生产服务器" class="header-anchor">#</a> 部署至生产服务器</h2> <ul><li><p>客户端请求服务通过 <code>api.*.*.com</code> ，nginx监听80端口后转发到服务端8000端口来传入网关</p></li> <li><p>由于此时option请求无法到达后端，需在nginx统一配置跨域。此时后端无需再配置跨域信息</p></li></ul> <div class="language-systemd line-numbers-mode"><pre class="language-systemd"><code>    server {
        listen       80;
        server_name  api.service_sign.*.com;

        location / {

            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH,OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,web-token,app-token,Authorization,Accept,Origin,Keep-Alive,User-Agent,X-Mx-ReqToken,X-Data-Type,X-Auth-Token,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
            if ($request_method <span class="token punctuation">=</span> <span class="token value attr-value">OPTIONS ) {</span>
                return 204;
            }
            proxy_read_timeout 300;
            proxy_pass http://127.0.0.1:8000;
            proxy_http_version 1.1;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Port 80;
            proxy_set_header Host $host;
        }
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="插件开发中遇到的问题"><a href="#插件开发中遇到的问题" class="header-anchor">#</a> 插件开发中遇到的问题</h2> <ul><li>在编辑完schema.lua后，加载插件时出现以下问题</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>[error] 2546#0: init_by_lua error: /usr/local/share/lua/5.1/kong/init.lua:402: error loading plugin schemas: on plugin 'kong_jwt_url_auth': [postgres] schema violation (fields.3: {
    fields = {
        [2] = {
            description = &quot;unknown field&quot;
        }
    }
})
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>由报错信息可知，<code>descrption</code>字段不被支持。1.x版本的Kong在schema的配置中不支持descrption字段，新版本支持。插件源码中含有<code>descrption</code>字段。</p></div></div> <footer class="page_footer" data-v-1fbd125a><div class="footer_middle card_border" data-v-1fbd125a><span data-v-1fbd125a>Released under the MIT License. <br data-v-1fbd125a></span><span data-v-1fbd125a>Copyright © 2023-present Leopold <br data-v-1fbd125a></span></div></footer></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.61ba6b8b.js" defer></script><script src="/assets/js/3.3ec197e6.js" defer></script><script src="/assets/js/12.89673e4a.js" defer></script>
  </body>
</html>
