<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.68">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <meta property="og:url" content="https://saynop.github.io/detail/008.html"><meta property="og:title" content="Kong与SSO"><meta property="og:description" content="kong的部署与基本配置 本文将以redhat系统为例，实现jwt登陆认证请求通过kong网关进行过滤，服务端无需进行jwt登陆认证校验操作 服务器建立两个无需认证的服务 安装服务运行环境 yum install python3 sudo pip3 install Flask==1.1.4"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-10-18T06:41:25.000Z"><meta property="article:tag" content="Kong"><meta property="article:tag" content="SSO"><meta property="article:published_time" content="2023-06-23T00:00:00.000Z"><meta property="article:modified_time" content="2023-10-18T06:41:25.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Kong与SSO","image":[""],"datePublished":"2023-06-23T00:00:00.000Z","dateModified":"2023-10-18T06:41:25.000Z","author":[]}</script><link rel="icon" href="/favicon.ico"><title>Kong与SSO</title><meta name="description" content="kong的部署与基本配置 本文将以redhat系统为例，实现jwt登陆认证请求通过kong网关进行过滤，服务端无需进行jwt登陆认证校验操作 服务器建立两个无需认证的服务 安装服务运行环境 yum install python3 sudo pip3 install Flask==1.1.4">
    <link rel="preload" href="/assets/style-3253bf1b.css" as="style"><link rel="stylesheet" href="/assets/style-3253bf1b.css">
    <link rel="modulepreload" href="/assets/app-68631362.js"><link rel="modulepreload" href="/assets/008.html-a73c20da.js"><link rel="modulepreload" href="/assets/008.html-042c4a7a.js">
    <link rel="prefetch" href="/assets/index.html-f33fda43.js" as="script"><link rel="prefetch" href="/assets/001.html-12451cc3.js" as="script"><link rel="prefetch" href="/assets/002.html-a6d5828c.js" as="script"><link rel="prefetch" href="/assets/003.html-6c773146.js" as="script"><link rel="prefetch" href="/assets/004.html-689926d8.js" as="script"><link rel="prefetch" href="/assets/005.html-d6b96039.js" as="script"><link rel="prefetch" href="/assets/006.html-5b50a542.js" as="script"><link rel="prefetch" href="/assets/007.html-d3b6ddc8.js" as="script"><link rel="prefetch" href="/assets/009.html-7d1574d7.js" as="script"><link rel="prefetch" href="/assets/010.html-f1724340.js" as="script"><link rel="prefetch" href="/assets/011.html-10672fd1.js" as="script"><link rel="prefetch" href="/assets/012.html-5e7aa08e.js" as="script"><link rel="prefetch" href="/assets/013.html-8dd46ba3.js" as="script"><link rel="prefetch" href="/assets/014.html-d0db391f.js" as="script"><link rel="prefetch" href="/assets/015.html-7a04f43c.js" as="script"><link rel="prefetch" href="/assets/016.html-79bc20a6.js" as="script"><link rel="prefetch" href="/assets/017.html-225b58d3.js" as="script"><link rel="prefetch" href="/assets/018.html-185c4621.js" as="script"><link rel="prefetch" href="/assets/019.html-af3ace47.js" as="script"><link rel="prefetch" href="/assets/404.html-a0fec2a7.js" as="script"><link rel="prefetch" href="/assets/index.html-75381ff5.js" as="script"><link rel="prefetch" href="/assets/index.html-c95ce669.js" as="script"><link rel="prefetch" href="/assets/index.html-2c56dc8e.js" as="script"><link rel="prefetch" href="/assets/index.html-98874abd.js" as="script"><link rel="prefetch" href="/assets/index.html-b2308fb7.js" as="script"><link rel="prefetch" href="/assets/index.html-10e703b4.js" as="script"><link rel="prefetch" href="/assets/index.html-5f3af54d.js" as="script"><link rel="prefetch" href="/assets/index.html-56349a98.js" as="script"><link rel="prefetch" href="/assets/index.html-a7c2713a.js" as="script"><link rel="prefetch" href="/assets/index.html-2e96c3d2.js" as="script"><link rel="prefetch" href="/assets/index.html-9f1eff22.js" as="script"><link rel="prefetch" href="/assets/index.html-16b34053.js" as="script"><link rel="prefetch" href="/assets/index.html-4e233464.js" as="script"><link rel="prefetch" href="/assets/index.html-d90f0ec9.js" as="script"><link rel="prefetch" href="/assets/index.html-3202320f.js" as="script"><link rel="prefetch" href="/assets/index.html-c3fe2c85.js" as="script"><link rel="prefetch" href="/assets/index.html-f3052411.js" as="script"><link rel="prefetch" href="/assets/index.html-5485bfc3.js" as="script"><link rel="prefetch" href="/assets/index.html-a7568890.js" as="script"><link rel="prefetch" href="/assets/index.html-9d25f5f2.js" as="script"><link rel="prefetch" href="/assets/index.html-b9dd3162.js" as="script"><link rel="prefetch" href="/assets/index.html-ff33d682.js" as="script"><link rel="prefetch" href="/assets/index.html-3bce843e.js" as="script"><link rel="prefetch" href="/assets/index.html-09b9da96.js" as="script"><link rel="prefetch" href="/assets/index.html-750acad1.js" as="script"><link rel="prefetch" href="/assets/index.html-1c1e573d.js" as="script"><link rel="prefetch" href="/assets/index.html-8eb4570b.js" as="script"><link rel="prefetch" href="/assets/index.html-7dd1db94.js" as="script"><link rel="prefetch" href="/assets/index.html-32048506.js" as="script"><link rel="prefetch" href="/assets/index.html-a4e9e805.js" as="script"><link rel="prefetch" href="/assets/index.html-df3e534f.js" as="script"><link rel="prefetch" href="/assets/index.html-cb3cc9f5.js" as="script"><link rel="prefetch" href="/assets/index.html-0994fca8.js" as="script"><link rel="prefetch" href="/assets/index.html-a902e771.js" as="script"><link rel="prefetch" href="/assets/index.html-76fbbff6.js" as="script"><link rel="prefetch" href="/assets/index.html-7bc29919.js" as="script"><link rel="prefetch" href="/assets/index.html-2642a77f.js" as="script"><link rel="prefetch" href="/assets/index.html-8dfad283.js" as="script"><link rel="prefetch" href="/assets/index.html-0e75c0da.js" as="script"><link rel="prefetch" href="/assets/index.html-1d59d05d.js" as="script"><link rel="prefetch" href="/assets/index.html-5789a1c9.js" as="script"><link rel="prefetch" href="/assets/index.html-a74daf45.js" as="script"><link rel="prefetch" href="/assets/index.html-12b75b8f.js" as="script"><link rel="prefetch" href="/assets/index.html-f963c7d5.js" as="script"><link rel="prefetch" href="/assets/001.html-b5745368.js" as="script"><link rel="prefetch" href="/assets/002.html-d3714827.js" as="script"><link rel="prefetch" href="/assets/003.html-757fe23d.js" as="script"><link rel="prefetch" href="/assets/004.html-c16d97d6.js" as="script"><link rel="prefetch" href="/assets/005.html-7fe7d0cd.js" as="script"><link rel="prefetch" href="/assets/006.html-c5a4414d.js" as="script"><link rel="prefetch" href="/assets/007.html-22b4813e.js" as="script"><link rel="prefetch" href="/assets/009.html-eca15a54.js" as="script"><link rel="prefetch" href="/assets/010.html-e1754445.js" as="script"><link rel="prefetch" href="/assets/011.html-9bd1323d.js" as="script"><link rel="prefetch" href="/assets/012.html-d2535def.js" as="script"><link rel="prefetch" href="/assets/013.html-96d6f687.js" as="script"><link rel="prefetch" href="/assets/014.html-fae25bfb.js" as="script"><link rel="prefetch" href="/assets/015.html-7bdef9df.js" as="script"><link rel="prefetch" href="/assets/016.html-a4165080.js" as="script"><link rel="prefetch" href="/assets/017.html-5b188e9b.js" as="script"><link rel="prefetch" href="/assets/018.html-a6c03b44.js" as="script"><link rel="prefetch" href="/assets/019.html-92080fc0.js" as="script"><link rel="prefetch" href="/assets/404.html-23f432df.js" as="script"><link rel="prefetch" href="/assets/index.html-88431957.js" as="script"><link rel="prefetch" href="/assets/index.html-4f13dea2.js" as="script"><link rel="prefetch" href="/assets/index.html-b766092b.js" as="script"><link rel="prefetch" href="/assets/index.html-d8124246.js" as="script"><link rel="prefetch" href="/assets/index.html-47fae44d.js" as="script"><link rel="prefetch" href="/assets/index.html-f35b4603.js" as="script"><link rel="prefetch" href="/assets/index.html-919f63c5.js" as="script"><link rel="prefetch" href="/assets/index.html-45dc25b6.js" as="script"><link rel="prefetch" href="/assets/index.html-be0f03a6.js" as="script"><link rel="prefetch" href="/assets/index.html-88aeba8d.js" as="script"><link rel="prefetch" href="/assets/index.html-3d9bbf16.js" as="script"><link rel="prefetch" href="/assets/index.html-fb6630de.js" as="script"><link rel="prefetch" href="/assets/index.html-11014634.js" as="script"><link rel="prefetch" href="/assets/index.html-ce344205.js" as="script"><link rel="prefetch" href="/assets/index.html-d64e1753.js" as="script"><link rel="prefetch" href="/assets/index.html-f7a7a202.js" as="script"><link rel="prefetch" href="/assets/index.html-ab60a60d.js" as="script"><link rel="prefetch" href="/assets/index.html-52572146.js" as="script"><link rel="prefetch" href="/assets/index.html-59ff6a57.js" as="script"><link rel="prefetch" href="/assets/index.html-a90de242.js" as="script"><link rel="prefetch" href="/assets/index.html-a94cac94.js" as="script"><link rel="prefetch" href="/assets/index.html-a86c4c68.js" as="script"><link rel="prefetch" href="/assets/index.html-a1632bc0.js" as="script"><link rel="prefetch" href="/assets/index.html-e0ec2fbc.js" as="script"><link rel="prefetch" href="/assets/index.html-2744c0c9.js" as="script"><link rel="prefetch" href="/assets/index.html-5044ebca.js" as="script"><link rel="prefetch" href="/assets/index.html-466d90f3.js" as="script"><link rel="prefetch" href="/assets/index.html-efba1e87.js" as="script"><link rel="prefetch" href="/assets/index.html-b031c299.js" as="script"><link rel="prefetch" href="/assets/index.html-4147504a.js" as="script"><link rel="prefetch" href="/assets/index.html-df0f2d99.js" as="script"><link rel="prefetch" href="/assets/index.html-556c3153.js" as="script"><link rel="prefetch" href="/assets/index.html-524adf27.js" as="script"><link rel="prefetch" href="/assets/index.html-f4a793c3.js" as="script"><link rel="prefetch" href="/assets/index.html-be4cd567.js" as="script"><link rel="prefetch" href="/assets/index.html-73c7c1bc.js" as="script"><link rel="prefetch" href="/assets/index.html-e94012ec.js" as="script"><link rel="prefetch" href="/assets/index.html-c413145b.js" as="script"><link rel="prefetch" href="/assets/index.html-be0f07a0.js" as="script"><link rel="prefetch" href="/assets/index.html-e8092df9.js" as="script"><link rel="prefetch" href="/assets/index.html-c6ee499c.js" as="script"><link rel="prefetch" href="/assets/index.html-29e0e1ec.js" as="script"><link rel="prefetch" href="/assets/index.html-6d9b55ac.js" as="script"><link rel="prefetch" href="/assets/giscus-0b7adcf8.js" as="script"><link rel="prefetch" href="/assets/SearchResult-1317782b.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div data-v-77edf713><header class="header" style="opacity:0;" data-v-90176301><div class="header_container" data-v-90176301><div data-v-90176301><a class="header_title" href="/" data-v-90176301>Leopold&#39;s Blog</a></div><div class="appearance" data-v-90176301><!--[--><button type="button" class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><!----></button><!--]--><button class="switch" data-v-90176301><span class="icon" style="display:block;" data-v-90176301><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" style="" data-v-90176301><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" style="display:none;" data-v-90176301><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg></span></button><button class="switch mobile_list_btn" type="button" data-v-90176301><span class="btn_top" data-v-90176301></span><span class="btn_middle" data-v-90176301></span><span class="btn_bottom" data-v-90176301></span></button></div></div></header><div class="main"><div class="background" data-v-fee8de4c><svg class="pull_down" viewbox="0 0 1026 1024" xmlns="http://www.w3.org/2000/svg" data-v-fee8de4c data-v-3c8412b0><path d="M857.088 224.256q28.672-28.672 69.12-28.672t69.12 28.672q29.696 28.672 29.696 68.608t-29.696 68.608l-382.976 380.928q-12.288 14.336-30.72 19.968t-38.912 4.608-40.448-8.704-34.304-22.016l-376.832-374.784q-29.696-28.672-29.696-68.608t29.696-68.608q14.336-14.336 32.256-21.504t36.864-7.168 37.376 7.168 32.768 21.504l313.344 309.248z" data-v-3c8412b0></path></svg></div><div style="display:flex;"><div class="sider_keeper" data-v-e01a06ce><div class="folding" data-v-e01a06ce><!-- <div class="folding"> --><div class="sidebar_top card_border" style="min-height:1rem" data-v-e01a06ce><div class="tags_brand" data-v-e01a06ce>本文大纲</div><section class="article_sidebar" data-v-e01a06ce data-v-905b99e1><ul data-v-905b99e1><!--[--><li class="level2" data-v-905b99e1><a class="sidebar-link" href="#kong的部署与基本配置" data-v-905b99e1>kong的部署与基本配置</a><ul class="level3" data-v-905b99e1><!--[--><li data-v-905b99e1><a class="sidebar-link" href="#服务器建立两个无需认证的服务" data-v-905b99e1>服务器建立两个无需认证的服务</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><li data-v-905b99e1><a class="sidebar-link" href="#安装postgresql" data-v-905b99e1>安装Postgresql</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><li data-v-905b99e1><a class="sidebar-link" href="#安装kong" data-v-905b99e1>安装Kong</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><li data-v-905b99e1><a class="sidebar-link" href="#配置与启动" data-v-905b99e1>配置与启动</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><li data-v-905b99e1><a class="sidebar-link" href="#kong代理后端服务" data-v-905b99e1>kong代理后端服务</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><!--]--></ul></li><li class="level2" data-v-905b99e1><a class="sidebar-link" href="#kong日志切分" data-v-905b99e1>kong日志切分</a><ul class="level3" data-v-905b99e1><!--[--><!--]--></ul></li><li class="level2" data-v-905b99e1><a class="sidebar-link" href="#kong网关多服务的jwt认证分析" data-v-905b99e1>kong网关多服务的jwt认证分析</a><ul class="level3" data-v-905b99e1><!--[--><li data-v-905b99e1><a class="sidebar-link" href="#建立需要不同用户权限的服务" data-v-905b99e1>建立需要不同用户权限的服务</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><li data-v-905b99e1><a class="sidebar-link" href="#部署插件" data-v-905b99e1>部署插件</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><!--]--></ul></li><li class="level2" data-v-905b99e1><a class="sidebar-link" href="#插件开发" data-v-905b99e1>插件开发</a><ul class="level3" data-v-905b99e1><!--[--><li data-v-905b99e1><a class="sidebar-link" href="#框架搭建" data-v-905b99e1>框架搭建</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><li data-v-905b99e1><a class="sidebar-link" href="#权限认证" data-v-905b99e1>权限认证</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><li data-v-905b99e1><a class="sidebar-link" href="#数据库查询" data-v-905b99e1>数据库查询</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><li data-v-905b99e1><a class="sidebar-link" href="#账号多登录的判断" data-v-905b99e1>账号多登录的判断</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><!--]--></ul></li><li class="level2" data-v-905b99e1><a class="sidebar-link" href="#服务端适配" data-v-905b99e1>服务端适配</a><ul class="level3" data-v-905b99e1><!--[--><li data-v-905b99e1><a class="sidebar-link" href="#服务端生成token" data-v-905b99e1>服务端生成token</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><li data-v-905b99e1><a class="sidebar-link" href="#服务端对postgresql的支持" data-v-905b99e1>服务端对Postgresql的支持</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><li data-v-905b99e1><a class="sidebar-link" href="#sso服务端的完整代码" data-v-905b99e1>SSO服务端的完整代码</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><!--]--></ul></li><li class="level2" data-v-905b99e1><a class="sidebar-link" href="#部署至生产服务器" data-v-905b99e1>部署至生产服务器</a><ul class="level3" data-v-905b99e1><!--[--><li data-v-905b99e1><a class="sidebar-link" href="#多服务的多host域名部署" data-v-905b99e1>多服务的多HOST域名部署</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><li data-v-905b99e1><a class="sidebar-link" href="#多服务的单host域名部署" data-v-905b99e1>多服务的单HOST域名部署</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><!--]--></ul></li><li class="level2" data-v-905b99e1><a class="sidebar-link" href="#插件开发中遇到的问题" data-v-905b99e1>插件开发中遇到的问题</a><ul class="level3" data-v-905b99e1><!--[--><!--]--></ul></li><!--]--></ul></section></div><div class="sidebar_bottom card_border" data-v-e01a06ce><div class="avatar" style="background-image:url(/assets/imgs/avatar.jpg);" data-v-e01a06ce></div><div class="author" data-v-e01a06ce>Leopold</div><div class="summary" data-v-e01a06ce><div data-v-e01a06ce><p data-v-e01a06ce>文章</p></div><div data-v-e01a06ce><p data-v-e01a06ce>分类</p></div><div data-v-e01a06ce><p data-v-e01a06ce>标签</p></div><div data-v-e01a06ce><p data-v-e01a06ce>19</p></div><div data-v-e01a06ce><p data-v-e01a06ce>10</p></div><div data-v-e01a06ce><p data-v-e01a06ce>31</p></div></div><div class="connection" data-v-e01a06ce><div class="grid_icon" data-v-e01a06ce><svg viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon" data-v-e01a06ce><path d="M1023.560892 524.587752c0 114.331752-32.549236 217.148443-97.647709 308.450075-65.047295 91.301632-149.132822 154.455339-252.205404 189.512299-11.975662 2.303012-20.778286 0.716493-26.305515-4.759558a27.584966 27.584966 0 0 1-8.342021-20.471218V853.150798c0-44.166653-11.566238-76.511177-34.647536-96.982394a446.272549 446.272549 0 0 0 68.32269-12.282731c20.16415-5.476051 41.044792-14.329852 62.590748-26.612583a187.311643 187.311643 0 0 0 53.992837-45.446104c14.432209-18.014672 26.203159-41.914819 35.312851-71.751618 9.109692-29.8368 13.664538-64.074912 13.664538-102.765514 0-55.118754-17.554069-102.049021-52.61103-140.739623 16.376974-41.454216 14.636921-87.872703-5.373695-139.357815-12.436265-4.094244-30.399759-1.535341-53.941659 7.523172a355.17563 355.17563 0 0 0-61.311297 30.041513l-25.333132 16.376974a462.137743 462.137743 0 0 0-127.945112-17.707604 462.137743 462.137743 0 0 0-127.945111 17.758782 589.571074 589.571074 0 0 0-28.301459-18.424096c-11.77095-7.31846-30.34858-16.069906-55.681713-26.305515-25.281954-10.235609-44.422543-13.306292-57.31941-9.212048-19.498835 51.433935-21.085354 97.852421-4.606024 139.306637-35.108139 38.690602-52.713386 85.620869-52.713386 140.739623 0 38.690602 4.606024 72.826357 13.715716 102.458445 9.109692 29.58091 20.778286 53.481057 34.954605 71.700441a180.658498 180.658498 0 0 0 53.634591 45.753172c21.545957 12.282731 42.477777 21.18771 62.641926 26.612583 20.215328 5.527229 42.989557 9.621472 68.32269 12.333909-17.758781 16.376974-28.659705 39.867697-32.651593 70.369811a129.941055 129.941055 0 0 1-29.990334 10.235609 184.087426 184.087426 0 0 1-37.974109 3.428929c-14.688099 0-29.171485-4.913092-43.654872-14.688099-14.432209-9.826185-26.766117-24.053681-37.001726-42.682489a109.162769 109.162769 0 0 0-32.293346-35.517563c-13.101579-9.109692-24.104859-14.585743-33.009839-16.376974l-13.306292-2.047122c-9.314404 0-15.762838 1.023561-19.345301 3.070683-3.582463 2.047122-4.606024 4.606024-3.326572 7.83024a37.769397 37.769397 0 0 0 5.987831 9.570295 49.182101 49.182101 0 0 0 8.700267 8.188487l4.606024 3.377751c9.826185 4.606024 19.447657 13.255114 29.017952 25.998447 9.570294 12.743333 16.581686 24.360749 20.982998 34.80107l6.653146 15.71166c5.783119 17.298179 15.558126 31.320963 29.376197 42.017174 13.766894 10.747389 28.659705 17.554069 44.627255 20.471218 15.96755 2.968327 31.423319 4.606024 46.316131 4.810736 14.841633 0.204712 27.22672-0.562958 37.001726-2.405368l15.302235-2.712436c0 17.298179 0.102356 37.564685 0.358247 60.799517l0.307068 36.848192c0 8.188487-2.86597 15.046345-8.700268 20.471218-5.731941 5.527229-14.636921 7.113748-26.612583 4.810736-103.072582-35.056961-187.158109-98.261846-252.205404-189.512299C32.549236 741.736195 0 638.919504 0 524.587752c0-95.191163 22.876586-182.910331 68.629758-263.31104a516.028224 516.028224 0 0 1 186.288082-190.894106A491.309228 491.309228 0 0 1 511.780446 0.012795a491.309228 491.309228 0 0 1 256.913784 70.369811 516.028224 516.028224 0 0 1 186.236905 190.894106C1000.684306 341.626242 1023.560892 429.447767 1023.560892 524.587752z"></path></svg></div><div data-v-e01a06ce><span data-v-e01a06ce>github.com/SayNop</span></div><div class="grid_icon" data-v-e01a06ce><svg viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon" data-v-e01a06ce><path d="M512 1024C229.222 1024 0 794.778 0 512S229.222 0 512 0s512 229.222 512 512-229.222 512-512 512z m259.149-568.883h-290.74a25.293 25.293 0 0 0-25.292 25.293l-0.026 63.206c0 13.952 11.315 25.293 25.267 25.293h177.024c13.978 0 25.293 11.315 25.293 25.267v12.646a75.853 75.853 0 0 1-75.853 75.853h-240.23a25.293 25.293 0 0 1-25.267-25.293V417.203a75.853 75.853 0 0 1 75.827-75.853h353.946a25.293 25.293 0 0 0 25.267-25.292l0.077-63.207a25.293 25.293 0 0 0-25.268-25.293H417.152a189.62 189.62 0 0 0-189.62 189.645V771.15c0 13.977 11.316 25.293 25.294 25.293h372.94a170.65 170.65 0 0 0 170.65-170.65V480.384a25.293 25.293 0 0 0-25.293-25.267z"></path></svg></div><div data-v-e01a06ce><span data-v-e01a06ce>gitee.com/WhenTimeGoesBy</span></div><!-- <div class="grid_icon"><mail_icon class="icon" /></div><div><span @click="open_link(themeData.connection_link.mail)">{{ themeData.connection_link.mail }}</span></div> --><div class="grid_icon" data-v-e01a06ce><svg viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon" data-v-e01a06ce><path d="M874.666667 181.333333H149.333333c-40.533333 0-74.666667 34.133333-74.666666 74.666667v512c0 40.533333 34.133333 74.666667 74.666666 74.666667h725.333334c40.533333 0 74.666667-34.133333 74.666666-74.666667V256c0-40.533333-34.133333-74.666667-74.666666-74.666667z m-725.333334 64h725.333334c6.4 0 10.666667 4.266667 10.666666 10.666667v25.6L512 516.266667l-373.333333-234.666667V256c0-6.4 4.266667-10.666667 10.666666-10.666667z m725.333334 533.333334H149.333333c-6.4 0-10.666667-4.266667-10.666666-10.666667V356.266667l356.266666 224c4.266667 4.266667 10.666667 4.266667 17.066667 4.266666s12.8-2.133333 17.066667-4.266666l356.266666-224V768c0 6.4-4.266667 10.666667-10.666666 10.666667z"></path></svg></div><div data-v-e01a06ce><a href="mailto:fur999immer@gmail.com" data-v-e01a06ce>fur999immer@gmail.com</a></div></div></div></div></div><div class="content_container"><!--[--><div class="card_border article_container" data-v-77edf713><div class="frontmatter_info" data-v-77edf713><h1 data-v-77edf713>Kong与SSO</h1><div data-v-77edf713>2023-06-23</div><div class="card_tag frontmatter_tags" data-v-77edf713><span class="icon" data-v-77edf713><svg viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" data-v-77edf713><path d="M896 682.666667a42.666667 42.666667 0 0 0-42.666667-42.666667h-85.333333v-85.333333a85.333333 85.333333 0 0 0-85.333333-85.333334h-128V384h85.333333a42.666667 42.666667 0 0 0 42.666667-42.666667V170.666667a42.666667 42.666667 0 0 0-42.666667-42.666667H384a42.666667 42.666667 0 0 0-42.666667 42.666667v170.666666a42.666667 42.666667 0 0 0 42.666667 42.666667h85.333333v85.333333H341.333333a85.333333 85.333333 0 0 0-85.333333 85.333334v85.333333H170.666667a42.666667 42.666667 0 0 0-42.666667 42.666667v170.666666a42.666667 42.666667 0 0 0 42.666667 42.666667h256a42.666667 42.666667 0 0 0 42.666666-42.666667v-170.666666a42.666667 42.666667 0 0 0-42.666666-42.666667H341.333333v-85.333333h341.333334v85.333333h-85.333334a42.666667 42.666667 0 0 0-42.666666 42.666667v170.666666a42.666667 42.666667 0 0 0 42.666666 42.666667h256a42.666667 42.666667 0 0 0 42.666667-42.666667z"></path></svg></span><!--[--><!-- 使用冒泡stop，阻止父组件的跳转覆盖子组件 --><span class="article_category" data-v-77edf713 data-v-c2920afd>Kong</span><!--]--><span class="icon" style="margin-right:5px;" data-v-77edf713><svg viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" data-v-77edf713><path d="M985.6 473.6 985.6 473.6l-256 256-256 256 0 0C454.4 1011.2 422.4 1024 384 1024c-38.4 0-70.4-12.8-89.6-38.4l0 0-256-256 0 0C12.8 710.4 0 678.4 0 640c0-38.4 12.8-70.4 38.4-89.6l0 0 256-256 256-256 0 0C569.6 12.8 601.6 0 640 0l256 0c70.4 0 128 57.6 128 128l0 256C1024 422.4 1011.2 454.4 985.6 473.6zM768 128c-70.4 0-128 57.6-128 128 0 70.4 57.6 128 128 128 70.4 0 128-57.6 128-128C896 185.6 838.4 128 768 128z"></path></svg></span><!--[--><!--[--><!-- 使用冒泡stop，阻止父组件的跳转覆盖子组件 --><span class="article_tag" data-v-77edf713 data-v-15d5095d>Kong</span><!--]--><!--[--><!-- 使用冒泡stop，阻止父组件的跳转覆盖子组件 --><span class="article_tag" data-v-77edf713 data-v-15d5095d>SSO</span><!--]--><!--]--></div></div><div data-v-77edf713><h2 id="kong的部署与基本配置" tabindex="-1"><a class="header-anchor" href="#kong的部署与基本配置" aria-hidden="true">#</a> kong的部署与基本配置</h2><p>本文将以redhat系统为例，实现jwt登陆认证请求通过kong网关进行过滤，服务端无需进行jwt登陆认证校验操作</p><h3 id="服务器建立两个无需认证的服务" tabindex="-1"><a class="header-anchor" href="#服务器建立两个无需认证的服务" aria-hidden="true">#</a> 服务器建立两个无需认证的服务</h3><ul><li>安装服务运行环境</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> python3
<span class="token function">sudo</span> pip3 <span class="token function">install</span> <span class="token assign-left variable">Flask</span><span class="token operator">==</span><span class="token number">1.1</span>.4
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>编写服务：本文使用Python的Flask框架作为后端服务</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># 服务A</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> jsonify

app_a <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_a<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> <span class="token string">&quot;server A&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment"># # flask --app a run</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    app_a<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">&#39;0.0.0.0&#39;</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span>

    
<span class="token comment"># 服务B</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> jsonify

app_b <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_b<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> <span class="token string">&quot;server B&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment"># # flask --app b run</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    app_b<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">&#39;0.0.0.0&#39;</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5001</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>开启端口，此处使用centos虚拟机进行</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> firewall-cmd --add-port<span class="token operator">=</span><span class="token number">5000</span>/tcp <span class="token parameter variable">--permanent</span>
<span class="token function">sudo</span> firewall-cmd --add-port<span class="token operator">=</span><span class="token number">5001</span>/tcp <span class="token parameter variable">--permanent</span>
<span class="token function">sudo</span> firewall-cmd <span class="token parameter variable">--reload</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="安装postgresql" tabindex="-1"><a class="header-anchor" href="#安装postgresql" aria-hidden="true">#</a> 安装Postgresql</h3><p>kong需要数据版本大于9.5，yum直接安装的版本为9.2.24<a href="https://blog.csdn.net/feinifi/article/details/96474115" target="_blank" rel="noopener noreferrer">参考文章1<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><a href="https://ken.io/note/centos7-postgresql12-install-and-configuration" target="_blank" rel="noopener noreferrer">参考文章2<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><strong>补充：</strong></p><p>Below is an example to install PostgreSQL 9.6 on RHEL/CentOS 7:</p><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/yum.repos.d/pgdg-96.repo</span>
[pgdg90]
name=PostgreSQL 9.6 RPMs for RHEL/CentOS 7
baseurl=https://yum-archive.postgresql.org/9.6/redhat/rhel-7-x86_64
enabled=1
gpgcheck=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-PGDG
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now, you can install PostgreSQL 9.6 on RHEL/CentOS 7:<code>yum install postgresql96-server</code>. <br> 通过<code>yum install postgresql96-devel</code>方便后续python安装包的处理</p><ul><li>查看安装源</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>yum search postgresql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>通过yum安装</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># yum直装老版本 yum install postgresql-server (kong网关不可用)</span>

<span class="token comment"># 安装12</span>
<span class="token comment"># 添加安装包</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
<span class="token comment"># 上述步骤不成功时使用下面的步骤</span>
<span class="token function">curl</span> <span class="token parameter variable">-Lo</span> pgdg-redhat-repo-latest.noarch.rpm <span class="token variable"><span class="token variable">$(</span> https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm&quot;<span class="token variable">)</span></span> <span class="token operator">||</span> <span class="token function">rpm</span> <span class="token parameter variable">-i</span> pgdg-redhat-repo-latest.noarch.rpm

<span class="token comment"># 安装</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> postgresql12 postgresql12-server


<span class="token comment"># 安装17</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
<span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> postgresql17-server
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>检查安装版本 - 等初始化完成后在登录数据库</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>psql <span class="token parameter variable">--version</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>初始化数据库 - 完成后会生成目录 <em>/var/lib/pgsql/12/</em> （老版本*/var/lib/pgsql/data*），配置文件在其中</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># yum直装老版本 </span>
postgresql-setup initdb
<span class="token comment"># 12</span>
<span class="token function">sudo</span> /usr/pgsql-12/bin/postgresql-12-setup initdb
<span class="token comment"># 17</span>
<span class="token function">sudo</span> /usr/pgsql-17/bin/postgresql-17-setup initdb
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>启动服务</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#启动PostgreSQL12服务</span>
<span class="token function">sudo</span> systemctl start postgresql-12
<span class="token comment">#设置PostgreSQL12服务为开机启动</span>
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> postgresql-12

<span class="token comment"># 9.2版本 service postgresql start</span>
<span class="token comment"># 9.6版本 sudo systemctl start postgresql-9.6</span>
<span class="token comment"># 启动失败可尝试更新配置文件后再试</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>通过<code>netstat -nat</code>可看到运行端口 <em>5432</em></p></li><li><p><code>psql postgres</code>通过root用户登录，第一次会失败。使用<code>psql -U postgres</code>以切换到postgres用户登录，会提示认证失败</p></li><li><p>通过<code>su - postgres</code>切换到postgres用户后，执行<code>psql</code>进行登录</p><ul><li>执行 <code>su - postgres</code> 出现密码，输入后提示 <em>su: 鉴定故障</em> ，使用 <code>sudo su - postgres</code> 来切换用户</li></ul></li><li><p>通过<code>vim /var/lib/pgsql/data/pg_hba.conf</code>修改配置</p></li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 不切换用户登录 peer改为trust</span>
<span class="token builtin class-name">local</span>		all		all							peer
<span class="token comment"># kong的迁移</span>
<span class="token function">host</span>		all		all		<span class="token number">127.0</span>.0.1/32		trust
<span class="token comment"># 远程登录 - 增加如下行</span>
<span class="token function">host</span>		all		all		<span class="token number">0.0</span>.0.0/0			md5
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>修改监听地址 - 非宿主机访问 <code>vim /var/lib/pgsql/data/postgresql.conf</code></li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 修改为 &#39;*&#39;</span>
listen_addresses <span class="token operator">=</span> <span class="token string">&#39;localhost&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>更新完配置后重启服务。可使用<code>psql -U postgres</code>直接登录，<code>\q</code>退出</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> systemctl restart postgresql-12
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>在postgresql内修改登录密码.</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 方法一</span>
<span class="token punctuation">\</span>password
<span class="token comment"># 方法二</span>
alter user postgres with password <span class="token string">&#39;target_password&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>开启端口</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> firewall-cmd --add-port<span class="token operator">=</span><span class="token number">5432</span>/tcp <span class="token parameter variable">--permanent</span>
<span class="token function">sudo</span> firewall-cmd <span class="token parameter variable">--reload</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>补充：</strong></p><ul><li><code>\l</code> 查看数据库</li><li><code>\c</code>选择数据库</li><li><code>\d</code>查看所有表格</li><li><code>\d 表格名</code>查看指定表格</li><li>创建表格</li></ul><div class="macos language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> login_user<span class="token punctuation">(</span>
   phone <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
   username <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
   password <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
   <span class="token keyword">level</span> <span class="token keyword">smallint</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="安装kong" tabindex="-1"><a class="header-anchor" href="#安装kong" aria-hidden="true">#</a> 安装Kong</h3><p>参考<a href="https://docs.konghq.com/gateway/latest/install/linux/rhel/" target="_blank" rel="noopener noreferrer">官方文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><ul><li>安装nignx</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> epel-release
yum update
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>下载安装包 最新下载地址 https://cloudsmith.io/~kong/repos/gateway-legacy/packages/</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 该下载地址已不能使用</span>
<span class="token function">curl</span> <span class="token parameter variable">-Lo</span> kong-enterprise-edition-3.3.0.0.rpm <span class="token variable"><span class="token variable">$(</span> <span class="token function">rpm</span> <span class="token parameter variable">--eval</span> <span class="token string">&quot;https://download.konghq.com/gateway-3.x-rhel-%{rhel}/Packages/k/kong-enterprise-edition-3.3.0.0.rhel%{rhel}.amd64.rpm&quot;</span><span class="token variable">)</span></span> <span class="token operator">||</span> <span class="token function">rpm</span> <span class="token parameter variable">-i</span> 

<span class="token comment"># 老版本 - 该下载地址已不能使用</span>
<span class="token function">curl</span> <span class="token parameter variable">-Lo</span> kong-1.1.3.el7.noarch.rpm <span class="token variable"><span class="token variable">$(</span> <span class="token function">rpm</span> <span class="token parameter variable">--eval</span> <span class="token string">&quot;https://download.konghq.com/gateway-1.x-centos-7/Packages/k/kong-1.1.3.el7.noarch.rpm&quot;</span><span class="token variable">)</span></span> <span class="token operator">||</span> <span class="token function">rpm</span> <span class="token parameter variable">-i</span> kong-1.1.3.el7.noarch.rpm
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>使用yum安装</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> yum <span class="token function">install</span> kong-enterprise-edition-3.3.0.0.rpm
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>配置文件 <em>/etc/kong/kong.conf.default</em></p><h3 id="配置与启动" tabindex="-1"><a class="header-anchor" href="#配置与启动" aria-hidden="true">#</a> 配置与启动</h3><ul><li>复制并修改 <em>/etc/kong/kong.config.default</em> 。</li><li>建立kong在postgresql内的数据库</li></ul><div class="macos language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> kong <span class="token keyword">WITH</span> PASSWORD <span class="token string">&#39;super_secret&#39;</span><span class="token punctuation">;</span> 
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> kong OWNER kong<span class="token punctuation">;</span>
<span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">privileges</span> <span class="token keyword">on</span> <span class="token keyword">database</span> kong <span class="token keyword">to</span> kong<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>配置数据库的账号与密码</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>pg_user <span class="token operator">=</span> kong
pg_password <span class="token operator">=</span> password
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>迁移</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">KONG_PASSWORD</span><span class="token operator">=</span><span class="token string">&quot;pwd&quot;</span> kong migrations bootstrap <span class="token parameter variable">-c</span> <span class="token string">&quot;PATH_TO_KONG.CONF_FILE&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>启动</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>kong start <span class="token parameter variable">-c</span> <span class="token string">&quot;PATH_TO_KONG.CONF_FILE&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>开放端口 - 8000服务api转发端口，8001kong管理端口</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> firewall-cmd --add-port<span class="token operator">=</span><span class="token number">8000</span>/tcp <span class="token parameter variable">--permanent</span>
<span class="token function">sudo</span> firewall-cmd <span class="token parameter variable">--reload</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="kong代理后端服务" tabindex="-1"><a class="header-anchor" href="#kong代理后端服务" aria-hidden="true">#</a> kong代理后端服务</h3><ul><li>声明一个需要kong接管的后端服务（记录标识名，服务名使用0.0.0.0）</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> POST <span class="token punctuation">\</span>
<span class="token parameter variable">--url</span> http://localhost:8001/services/ <span class="token punctuation">\</span>
<span class="token parameter variable">--data</span> <span class="token string">&#39;name=服务标识符&#39;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--data</span> <span class="token string">&#39;url=http://服务地址&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>如果访问 localhost 出现 *curl: (7) Failed to connect to ::1: 没有到主机的路由* ，说明localhost默认解析为ipv6的地址，使用 `curl -4 localhost:8001` 或 `curl 127.0.0.1`
</code></pre><ul><li><p>转发路由：代理多个服务可使用两种方法进行</p><ul><li><p>以host区分服务（为声明的服务添加路由，注意字段需为客户端请求的host，详见补充）</p><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> POST <span class="token punctuation">\</span>
    <span class="token comment"># 管理地址/services/服务标识符/routers</span>
<span class="token parameter variable">--url</span> http://localhost:8001/services/服务标识符/routes <span class="token punctuation">\</span>
<span class="token comment"># 指明转发host规则：即后续请求头中携带指定host值字段将转发到对应的服务</span>
<span class="token parameter variable">--data</span> <span class="token string">&#39;hosts[]=example1.com&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>补充：</strong>：路由host字段的说明</p><ul><li>此方法使用多个host区分服务，如 <code>http://api.service_1.example.com/*</code> 与 <code>http://api.service_2.example.com/*</code> 来指向不同的服务</li><li>根据浏览器安全策略，浏览器发出的请求头中的Host字段根据为实际请求地址 <code>http://{host}:{port|80}</code> 中的 <code>host</code> 值，且不可自定义。</li><li>在生产环境中，在一台服务器上部署kong网关在8000端口。如需转发多个后端请求，需全部请求到该服务器的8000端口，才可进入kong网关。</li><li>由于host值不可指定，而kong网关需要host值进行路由区分，因此该方法需为每个服务准备不同的域名，所有域名皆指向kong网关所在ip</li></ul></li><li><p>以一级路由区分：如 <code>http://api.example.com/service_1/*</code> 与 <code>http://api.example.com/service_2/*</code> 来指向不同的服务</p></li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> POST <span class="token punctuation">\</span>
    <span class="token comment"># 管理地址/services/服务标识符/routers</span>
<span class="token parameter variable">--url</span> http://localhost:8001/services/服务标识符/routes <span class="token punctuation">\</span>    
<span class="token comment"># 指明统一的转发host</span>
<span class="token parameter variable">--data</span> <span class="token string">&#39;hosts[]=example.com&#39;</span>
<span class="token comment"># 指明待转发服务的一级路由</span>
<span class="token parameter variable">--data</span> <span class="token string">&#39;paths[]=/service1/&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>让kong转发到指定的服务</p><ul><li>host区分：配置测试服务A和B，以A为例</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 定义服务：服务标识符命名为service_a，本地服务的ip必须为0.0.0.0</span>
<span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">--url</span> http://localhost:8001/services/ <span class="token punctuation">\</span>
<span class="token parameter variable">--data</span> <span class="token string">&#39;name=service_a&#39;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--data</span> <span class="token string">&#39;url=http://0.0.0.0:5000&#39;</span>

<span class="token comment"># 配置路由：添加kong的转发路由</span>
<span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">--url</span> http://localhost:8001/services/service_a/routes <span class="token punctuation">\</span>
<span class="token parameter variable">--data</span> <span class="token string">&#39;hosts[]=service_a.com&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>一级路由区分：配置测试服务A和B，以A为例</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 服务标识符命名为service_a，本地服务的ip必须为0.0.0.0</span>
<span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">--url</span> http://localhost:8001/services/ <span class="token punctuation">\</span>
<span class="token parameter variable">--data</span> <span class="token string">&#39;name=service_a&#39;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--data</span> <span class="token string">&#39;url=http://0.0.0.0:5000&#39;</span>

<span class="token comment"># 添加kong的转发路由</span>
<span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">--url</span> http://localhost:8001/services/service_a/routes <span class="token punctuation">\</span>
<span class="token parameter variable">--data</span> <span class="token string">&#39;hosts[]=service.com&#39;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--data</span> <span class="token string">&#39;paths[]=/service_a/&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>路由的查看，修改，删除</p></li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 查看</span>
<span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> GET <span class="token parameter variable">--url</span>  http://localhost:8001/services/服务标识符

<span class="token comment"># 修改</span>
<span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> PATCH <span class="token parameter variable">--url</span>  http://localhost:8001/services/服务标识符 <span class="token punctuation">\</span> 
<span class="token parameter variable">--data</span> 	<span class="token string">&#39;name=服务的新标识符&#39;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--data</span> <span class="token string">&#39;retries=6&#39;</span> <span class="token comment"># 其他选项</span>

<span class="token comment"># 删除</span>
<span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> DELETE <span class="token parameter variable">--url</span>  http://localhost:8001/services/服务标识符 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>代理完成后移除原服务端口，只对外暴漏kong端口通过代理请求对应服务</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> firewall-cmd --remove-port<span class="token operator">=</span><span class="token number">5000</span>/tcp <span class="token parameter variable">--permanent</span>
<span class="token function">sudo</span> firewall-cmd --remove-port<span class="token operator">=</span><span class="token number">5001</span>/tcp <span class="token parameter variable">--permanent</span>
<span class="token function">sudo</span> firewall-cmd <span class="token parameter variable">--reload</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="kong日志切分" tabindex="-1"><a class="header-anchor" href="#kong日志切分" aria-hidden="true">#</a> kong日志切分</h2><p>kong日志不会主动切分，长时间运行日志往往很大，查看时加载时间较长。可考虑进行切分</p><ul><li>安装 logrotate：在大多数 Linux 系统上，logrotate 工具通常已经预安装。如果没有安装，可以使用以下命令安装：</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>复制代码
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token function">logrotate</span>  <span class="token comment"># Debian/Ubuntu</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token function">logrotate</span>      <span class="token comment"># CentOS/RHEL</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>配置 logrotate</p><ul><li><p>logrotate 的配置文件通常位于 /etc/logrotate.conf，而每个应用的单独配置文件通常放在 /etc/logrotate.d/ 目录下。我们可以为 Nginx 配置一个专门的日志切分规则</p></li><li><p>在 /etc/logrotate.d/ 目录下创建一个名为 kong 的配置文件，内容如下：</p></li></ul><div class="language-systemd line-numbers-mode" data-ext="systemd"><pre class="language-systemd"><code>/data/logs/kong/gateway/*.log {
    create 0640 red root  # 创建新日志文件时设置权限
    daily  # 每日切分
    rotate 10  # 保留10个历史日志文件
    missingok  # 如果日志文件丢失，不报错
    notifempty  # 如果日志文件为空，不切分
    compress  # 对旧日志文件进行压缩
    delaycompress  # 延迟压缩，直到下一次轮换
    sharedscripts  # 确保在所有日志切分之后运行 postrotate
    postrotate  # kong 日志切分后重载 kong
        /bin/kill -USR1 `cat /usr/local/kong/pids/nginx.pid 2&gt;/dev/null` 2&gt;/dev/null || true
    endscript
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>同理可切分nginx日志：在 /etc/logrotate.d/ 目录下创建一个名为 nginx 的配置文件</li></ul><div class="language-systemd line-numbers-mode" data-ext="systemd"><pre class="language-systemd"><code>/var/log/nginx/*.log {
    create 0640 nginx root
    daily
    rotate 10
    missingok
    notifempty
    compress
    delaycompress
    sharedscripts
    postrotate
        /bin/kill -USR1 `cat /run/nginx.pid 2&gt;/dev/null` 2&gt;/dev/null || true
    endscript
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>执行切分</p></li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> /usr/local/bin/kong stop  <span class="token comment"># 重启kong服务</span>
<span class="token function">sudo</span> /usr/local/bin/kong start <span class="token parameter variable">-c</span> <span class="token string">&quot;/etc/kong/kong.conf&quot;</span>
<span class="token function">sudo</span> <span class="token function">logrotate</span> <span class="token parameter variable">-d</span> /etc/logrotate.conf  <span class="token comment"># 查看配置的调试输出</span>
<span class="token function">sudo</span> <span class="token function">logrotate</span> <span class="token parameter variable">-f</span> /etc/logrotate.conf  <span class="token comment"># 强制执行日志切分</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>问题：</strong> 执行切分时出现 <code>error: skipping &quot;/data/logs/kong/gateway/access.log&quot; because parent directory has insecure permissions (It&#39;s world writable or writable by group which is not &quot;root&quot;) Set &quot;su&quot; directive in config file to tell logrotate which user/group should be used for rotation.</code></p><p>logrotate 为了防止潜在的安全风险，不允许操作所有用户可读写的文件。需要更新权限</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 调整目录权限与日志文件权限</span>
<span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">755</span> /<span class="token operator">&lt;</span>path to log <span class="token function">file</span> dir<span class="token operator">&gt;</span>
<span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">644</span> /<span class="token operator">&lt;</span>path to log file<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="kong网关多服务的jwt认证分析" tabindex="-1"><a class="header-anchor" href="#kong网关多服务的jwt认证分析" aria-hidden="true">#</a> kong网关多服务的jwt认证分析</h2><p>通过kong的jwt插件可实现对用户的认证。作者思考到了两个设计方向可供选择：</p><ul><li>利用jwt认证可以对服务或路由生效（该方法只能使用host区分服务）。由于服务中一些接口需要无权限也可访问，可将一个服务的接口设置两个kong服务。将需要认证的接口放置一个服务，并设置特殊路径，如<code>/auth/*</code>。将无需认证接口放置另一个服务，并设置特殊路径<code>/free/*</code>。这样对kong来说，配置不同的服务，即可避免配置两个路由指向同一服务，需认证接口通过免认证路由请求而引起的安全性问题。(不同权限等级需不同一级路由，较为复杂)</li><li>将全部数据接口与权限等级记入数据表中，根据路径与token中的用户权限查表鉴权，判断是否需要jwt认证，不需要直接放行后端，需要jwt认证的接口验证token得到用户权限，判断权限等级是否匹配。对token验证不通过的返回401，对权限不足的返回403。后续内容介绍的都是此方法的实现流程</li></ul><h3 id="建立需要不同用户权限的服务" tabindex="-1"><a class="header-anchor" href="#建立需要不同用户权限的服务" aria-hidden="true">#</a> 建立需要不同用户权限的服务</h3><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># 服务A</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> jsonify

app_a <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_a<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;server A - level 0&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_a<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&#39;/auth&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;server A - level 1&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_a<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&quot;/admin&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;server A - level 2&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment"># # flask --app a run</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    app_a<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">&#39;0.0.0.0&#39;</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span>


    
<span class="token comment"># 服务B</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> jsonify

app_b <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_b<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;server B - level 0&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_b<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&#39;/auth&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;server B - level 1&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_b<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&#39;/admin&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;server B - level 2&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment"># # flask --app b run</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    app_b<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">&#39;0.0.0.0&#39;</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5001</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="部署插件" tabindex="-1"><a class="header-anchor" href="#部署插件" aria-hidden="true">#</a> 部署插件</h3><p>插件部署流程参考 <a href="https://blog.csdn.net/zz18435842675/article/details/120648334" target="_blank" rel="noopener noreferrer">csdn zz18435842675<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>kong的插件默认路径为 <em>/usr/local/share/lua/5.1/kong/plugins</em></p><ul><li><em>/etc/kong/kong.conf</em> 中配置插件路径<code>lua_package_path = /&lt;path-to-plugin-location&gt;/kong/plugins/?.lua;;</code>。其中：<code>;;</code>代表默认路径；需确保最后两个路径为 <em>/kong/plugins/</em></li><li>将插件文件夹放入指定目录（不生效时放入默认目录）</li><li>修改 <em>/etc/kong/kong.conf</em> 中的<code>plugins = bundled</code>，用逗号分隔在后方补充自定义插件</li><li>修改 <em>/usr/local/share/lua/5.1/kong/constants.lua</em> ，添加自定义插件</li><li>通过<code>kong reload -c &quot;PATH_TO_KONG.CONF_FILE&quot;</code>重启kong</li><li>通过命令将插件绑定到服务</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST http://kong_ip:8001/services/<span class="token operator">&lt;</span>service-name-or-id<span class="token operator">&gt;</span>/plugins <span class="token parameter variable">-d</span> <span class="token string">&quot;name=my-custom-plugin&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="插件开发" tabindex="-1"><a class="header-anchor" href="#插件开发" aria-hidden="true">#</a> 插件开发</h2><p>kong插件的文件结构<a href="https://github.com/qianyugang/kong-docs-cn/blob/master/GUIDES%26REFERENCES/plugin-development/file-structure.md" target="_blank" rel="noopener noreferrer">文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><ul><li>handler.lua : 插件的主逻辑</li><li>schema.lua : 配置信息。</li><li>daos.lua : 数据库模型类。可自行建表后通过daos实例连接。如需迁移建表需要编写迁移文件。</li></ul><p>下面将用jwt token的认证为例，说明一个接口认证插件的开发流程，源码<a href="https://github.com/SayNop/kong_jwt_url_auth" target="_blank" rel="noopener noreferrer">在此<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</p><h3 id="框架搭建" tabindex="-1"><a class="header-anchor" href="#框架搭建" aria-hidden="true">#</a> 框架搭建</h3><p>一个最基本的kong插件需包含两个文件 <em>handler.lua</em> 与<em>schema.lua</em></p><ul><li>handler的开发需按照以下格式进行</li></ul><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token comment">-- 必要的导包</span>
<span class="token keyword">local</span> kong <span class="token operator">=</span> kong
<span class="token keyword">local</span> BasePlugin <span class="token operator">=</span> require <span class="token string">&quot;kong.plugins.base_plugin&quot;</span>

<span class="token comment">-- 声明自定义handler类</span>
<span class="token keyword">local</span> RequestAuthHandler <span class="token operator">=</span> BasePlugin<span class="token punctuation">:</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">-- 定义优先级与版本号</span>
RequestAuthHandler<span class="token punctuation">.</span>PRIORITY <span class="token operator">=</span> <span class="token number">800</span>
RequestAuthHandler<span class="token punctuation">.</span>VERSION <span class="token operator">=</span> <span class="token string">&quot;1.0.0&quot;</span>

<span class="token comment">-- 自定义handler的new方法</span>
<span class="token keyword">function</span> RequestAuthHandler<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">-- 传入插件名</span>
    RequestAuthHandler<span class="token punctuation">.</span>super<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">&quot;kong_jwt_url_auth&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>


<span class="token comment">-- 主逻辑，access方法处理请求到来时的逻辑</span>
<span class="token keyword">function</span> RequestAuthHandler<span class="token punctuation">:</span><span class="token function">access</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
    RequestAuthHandler<span class="token punctuation">.</span>super<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span>
  	<span class="token comment">-- 以下是主逻辑</span>
    <span class="token comment">-- 例如：pass options request</span>
    <span class="token keyword">if</span> kong<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">get_method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;OPTIONS&quot;</span> <span class="token keyword">then</span>
      <span class="token keyword">return</span>
    <span class="token keyword">end</span>
  
<span class="token keyword">end</span>

<span class="token comment">-- 返回自定义handler</span>
<span class="token keyword">return</span> RequestAuthHandler

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>schema中的配置信息作为handler实例的传入参数。可通过传入参数调用配置信息<code>fields</code>中的预定义变量。配置项在绑定服务时传入了数据库，如后续更新，需要 <strong>删除plugins表中对应的项后重新进行绑定</strong> (<code>delete from plugins where name = &#39;&lt;plugin_name&gt;&#39; ;</code>)。</li></ul><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token keyword">local</span> typedefs <span class="token operator">=</span> require <span class="token string">&quot;kong.db.schema.typedefs&quot;</span>

<span class="token keyword">return</span> <span class="token punctuation">{</span>
    name <span class="token operator">=</span> <span class="token string">&quot;xxx&quot;</span><span class="token punctuation">,</span>  <span class="token comment">-- 插件名</span>
    fields <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">{</span> consumer <span class="token operator">=</span> typedefs<span class="token punctuation">.</span>no_consumer <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">-- 插件的消费者</span>
        <span class="token punctuation">{</span> protocols <span class="token operator">=</span> typedefs<span class="token punctuation">.</span>protocols_http <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">-- 插件协议</span>
        <span class="token punctuation">{</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
            type <span class="token operator">=</span> <span class="token string">&quot;record&quot;</span><span class="token punctuation">,</span>
            <span class="token comment">-- handler的配置信息 或 所需要的预定义变量</span>
            fields <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">-- jwt secret key</span>
                    secret_key <span class="token operator">=</span> <span class="token punctuation">{</span> type <span class="token operator">=</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span> default <span class="token operator">=</span> <span class="token string">&quot;1234567891234567891234567891234567891234567&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span> 
                    <span class="token comment">-- sign deliver, iss, not check</span>
                    key_claim_name <span class="token operator">=</span> <span class="token punctuation">{</span> type <span class="token operator">=</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span> default <span class="token operator">=</span> <span class="token string">&quot;iss&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="权限认证" tabindex="-1"><a class="header-anchor" href="#权限认证" aria-hidden="true">#</a> 权限认证</h3><p>使用kong官方插件 <em>jwt</em> 中的jwt认证组件<a href="https://github.com/Kong/kong/blob/master/kong/plugins/jwt/jwt_parser.lua" target="_blank" rel="noopener noreferrer">jwt_parser.lua<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>进行验证</p><p>以下是在handler调用 <em>jwt</em> 插件内的认证组件并编写token认证逻辑</p><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token comment">-- 导入所需内容</span>
<span class="token keyword">local</span> get_header <span class="token operator">=</span> kong<span class="token punctuation">.</span>request<span class="token punctuation">.</span>get_header
<span class="token keyword">local</span> set_header <span class="token operator">=</span> kong<span class="token punctuation">.</span>service<span class="token punctuation">.</span>request<span class="token punctuation">.</span>set_header
<span class="token keyword">local</span> jwt_decoder <span class="token operator">=</span> require <span class="token string">&quot;kong.plugins.jwt.jwt_parser&quot;</span>

<span class="token comment">-- 省略</span>

<span class="token keyword">function</span> RequestAuthHandler<span class="token punctuation">:</span><span class="token function">access</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
    RequestAuthHandler<span class="token punctuation">.</span>super<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span>
    <span class="token comment">-- pass options request</span>
    <span class="token keyword">if</span> kong<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">get_method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;OPTIONS&quot;</span> <span class="token keyword">then</span>
      <span class="token keyword">return</span>
    <span class="token keyword">end</span>

    <span class="token comment">-- 0. 获取token</span>
    <span class="token keyword">local</span> bear_token <span class="token operator">=</span> <span class="token function">get_header</span><span class="token punctuation">(</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bear_token <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">or</span> string<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>bear_token<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">~=</span> <span class="token string">&quot;Bearer &quot;</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
        kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span><span class="token string">&quot;miss bearer&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> kong<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">,</span> success <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">&quot;UnAuthorized&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token keyword">local</span> token <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>bear_token<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment">-- 1. 解码token</span>
  	<span class="token comment">-- 1.1 base64解码token</span>
    <span class="token keyword">local</span> jwt<span class="token punctuation">,</span> err <span class="token operator">=</span> jwt_decoder<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token keyword">then</span>
      <span class="token comment">-- 解码失败，token有问题</span>
      kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span><span class="token string">&quot;decode error&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> kong<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">,</span> success <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">&quot;UnAuthorized&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>

  	<span class="token comment">-- 2. 验证</span>
    <span class="token comment">-- 2.1 获取payload</span>
    <span class="token keyword">local</span> claims <span class="token operator">=</span> jwt<span class="token punctuation">.</span>claims
    <span class="token comment">-- 2.2 获取token header</span>
    <span class="token keyword">local</span> header <span class="token operator">=</span> jwt<span class="token punctuation">.</span>header
    <span class="token comment">-- 2.3 获取私钥</span>
    <span class="token comment">-- local secret_key = &quot;1234567891234567891234567891234567891234567&quot;</span>
    kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span>secret_key<span class="token punctuation">)</span>
    <span class="token comment">-- 2.4 ***** 验签 *****</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> jwt<span class="token punctuation">:</span><span class="token function">verify_signature</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span>secret_key<span class="token punctuation">)</span> <span class="token keyword">then</span>
        kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span><span class="token string">&quot;check secret fail&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> kong<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">,</span> success <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">&quot;UnAuthorized&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token comment">-- 2.5 ***** 验证token有效期 *****</span>
    <span class="token keyword">local</span> ok_claims<span class="token punctuation">,</span> errors <span class="token operator">=</span> jwt<span class="token punctuation">:</span><span class="token function">verify_registered_claims</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span>claims_to_verify<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> ok_claims <span class="token keyword">then</span>
        kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span>
        <span class="token keyword">return</span> kong<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">,</span> success <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">&quot;Token Expired&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    <span class="token comment">-- 2.6 获取payload中的用户标识符</span>
    <span class="token keyword">local</span> phone <span class="token operator">=</span> claims<span class="token punctuation">[</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> phone <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">then</span>
        kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span><span class="token string">&quot;miss phone in payload&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> kong<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">,</span> success <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">&quot;UnAuthorized&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span>

  	<span class="token comment">-- 3. 将用户标识符塞入header，方便后端服务查询对应用户信息</span>
    <span class="token function">set_header</span><span class="token punctuation">(</span><span class="token string">&quot;x-auth-phone&quot;</span><span class="token punctuation">,</span> phone<span class="token punctuation">)</span>

<span class="token keyword">end</span>

<span class="token comment">-- 省略</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意：</strong></p><p>开发过程中可使用<code> kong.log.inspect()</code>进行关键信息打印，对复杂类型会进行格式化处理（性能开销），在生产环境中需要移除或使用<code>kong.log.notice()</code>。</p><h3 id="数据库查询" tabindex="-1"><a class="header-anchor" href="#数据库查询" aria-hidden="true">#</a> 数据库查询</h3><p>通过 <em>daos.lua</em> 中对目标表的 <em>daos实例（模型类）</em> 声明，以便在 <em>handler.lua</em> 中进行数据库查询。</p><ul><li><p>关于数据库表生成的两种方式（与后端开发类似）：</p><ul><li>可通过 <em>postgresql ctl</em> 在kong连接的数据库中创建目标table，再根据table的字段定义daos实例</li></ul><div class="macos language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> login_user<span class="token punctuation">(</span>
phone <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
username <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
password <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token keyword">level</span> <span class="token keyword">smallint</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> login_user <span class="token punctuation">(</span>phone<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> <span class="token keyword">level</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">&#39;13011111111&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;alice&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;88888888&#39;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> api_mgr<span class="token punctuation">(</span>
sign <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>  <span class="token comment">-- kong插件只可查询主键，主键需包含查询条件</span>
path <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
service <span class="token keyword">smallint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
auth_level <span class="token keyword">smallint</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> api_mgr <span class="token punctuation">(</span>sign<span class="token punctuation">,</span> path<span class="token punctuation">,</span> service<span class="token punctuation">,</span> auth_level<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">&#39;0/&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> api_mgr <span class="token punctuation">(</span>sign<span class="token punctuation">,</span> path<span class="token punctuation">,</span> service<span class="token punctuation">,</span> auth_level<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">&#39;0/auth&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/auth&#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> api_mgr <span class="token punctuation">(</span>sign<span class="token punctuation">,</span> path<span class="token punctuation">,</span> service<span class="token punctuation">,</span> auth_level<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">&#39;0/admin&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/admin&#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> api_mgr <span class="token punctuation">(</span>sign<span class="token punctuation">,</span> path<span class="token punctuation">,</span> service<span class="token punctuation">,</span> auth_level<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">&#39;1/&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> api_mgr <span class="token punctuation">(</span>sign<span class="token punctuation">,</span> path<span class="token punctuation">,</span> service<span class="token punctuation">,</span> auth_level<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">&#39;1/auth&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/auth&#39;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> api_mgr <span class="token punctuation">(</span>sign<span class="token punctuation">,</span> path<span class="token punctuation">,</span> service<span class="token punctuation">,</span> auth_level<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">&#39;1/admin&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/admin&#39;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>在 <em>daos.lua</em> 编写完成后，编写迁移文件 <em>migrations/init.lua</em> 与 <em>migrations/000_base_&lt;plugin_name&gt;.lua</em> 。通过kong的迁移命令在数据库中生成table。</li></ul></li><li><p>daos.lua 实例</p></li></ul><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span>
    primary_key <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;phone&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  
    name <span class="token operator">=</span> <span class="token string">&quot;login_user&quot;</span><span class="token punctuation">,</span>  <span class="token comment">-- 数据表名称</span>
    endpoint_key <span class="token operator">=</span> <span class="token string">&quot;phone&quot;</span><span class="token punctuation">,</span>  <span class="token comment">-- handler中的查询字段</span>
    cache_key <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;phone&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">-- 缓存字段</span>
    fields <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token comment">-- 实例中的type为lua基本类型</span>
            <span class="token punctuation">{</span> phone <span class="token operator">=</span> <span class="token punctuation">{</span> type <span class="token operator">=</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">,</span> unique <span class="token operator">=</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">-- 主键 手机号作为用户唯一标识符</span>
            <span class="token punctuation">{</span> username <span class="token operator">=</span> <span class="token punctuation">{</span> type <span class="token operator">=</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> password <span class="token operator">=</span> <span class="token punctuation">{</span> type <span class="token operator">=</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> level <span class="token operator">=</span> <span class="token punctuation">{</span> type <span class="token operator">=</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">,</span> default <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">-- 用户权限等级</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>handler中的数据库查询核心代码</li></ul><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token comment">-- payload中获取用户标识符</span>
<span class="token keyword">local</span> phone <span class="token operator">=</span> claims<span class="token punctuation">[</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">]</span>
<span class="token keyword">if</span> phone <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">then</span>
kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span><span class="token string">&quot;miss phone in payload&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> kong<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">,</span> success <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">&quot;UnAuthorized&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span>

<span class="token comment">-- 通过用户标识符查询用户对象 select用于查询主键</span>
<span class="token keyword">local</span> user<span class="token punctuation">,</span> err <span class="token operator">=</span> kong<span class="token punctuation">.</span>db<span class="token punctuation">.</span>login_user<span class="token punctuation">:</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">{</span> phone <span class="token operator">=</span> phone <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token keyword">then</span>
<span class="token keyword">return</span> <span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> user <span class="token keyword">then</span>
kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span><span class="token string">&quot;login user not found&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> kong<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">,</span> success <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">&quot;UnAuthorized&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- 通过用户对象获取用户权限等级</span>
<span class="token function">set_header</span><span class="token punctuation">(</span><span class="token string">&quot;x-auth-level&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>level<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="账号多登录的判断" tabindex="-1"><a class="header-anchor" href="#账号多登录的判断" aria-hidden="true">#</a> 账号多登录的判断</h3><p>通过redis缓存token，kong插件查询token后进行判断<br> redis连接代码参考<a href="https://juejin.cn/post/6844904197662441486" target="_blank" rel="noopener noreferrer">文章<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><ul><li>服务端</li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># 服务端redis支持</span>
<span class="token comment"># sudo pip3 install redis==3.5.3</span>

<span class="token comment"># ** 登录接口中的判断 **</span>
<span class="token comment"># 查询该用户之前是否存在有效期内的token</span>
old_token <span class="token operator">=</span> redis_conn<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;login:&#39;</span> <span class="token operator">+</span> phone<span class="token punctuation">)</span>
<span class="token comment"># 该用户存在已登录的token，将旧token标记为失效token</span>
<span class="token keyword">if</span> old_token<span class="token punctuation">:</span>
    <span class="token comment"># 在token的最大过期时间内，该token都将标记为失效token</span>
    redis_conn<span class="token punctuation">.</span>setex<span class="token punctuation">(</span><span class="token string">&#39;conflict:&#39;</span> <span class="token operator">+</span> old_token<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># 记录该用户的最新token，下一次出现重复登录时可获取到旧token</span>
redis_conn<span class="token punctuation">.</span>setex<span class="token punctuation">(</span><span class="token string">&#39;login:&#39;</span> <span class="token operator">+</span> phone<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>网关</li></ul><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token keyword">local</span> redis <span class="token operator">=</span> require <span class="token string">&quot;resty.redis&quot;</span>
<span class="token keyword">local</span> redis_conn <span class="token operator">=</span> redis<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
redis_conn<span class="token punctuation">:</span><span class="token function">set_timeouts</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment">-- 1 sec</span>

<span class="token keyword">local</span> ok<span class="token punctuation">,</span> err <span class="token operator">=</span> redis_conn<span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span>redisHost<span class="token punctuation">,</span> redisPort<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> ok <span class="token keyword">then</span>
    kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;failed to connect redis: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token keyword">else</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>redisPwd <span class="token operator">~=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">then</span>
        <span class="token keyword">local</span> auth<span class="token punctuation">,</span> err <span class="token operator">=</span> redis_conn<span class="token punctuation">:</span><span class="token function">auth</span><span class="token punctuation">(</span>redisPwd<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> auth <span class="token keyword">then</span>
            kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;failed to authenticate: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>

    <span class="token keyword">local</span> conflict_res<span class="token punctuation">,</span> err <span class="token operator">=</span> redis_conn<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;conflict&#39;</span><span class="token operator">..</span>token<span class="token punctuation">)</span>
    <span class="token keyword">if</span> conflict_res <span class="token operator">~=</span> ngx<span class="token punctuation">.</span>null <span class="token keyword">then</span>
        kong<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">&quot;user &quot;</span><span class="token operator">..</span>phone<span class="token operator">..</span> <span class="token string">&quot;  token conflict&quot;</span><span class="token punctuation">)</span>
        kong<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> code <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">,</span> success <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msg <span class="token operator">=</span> <span class="token string">&quot;Token Conflict&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token keyword">end</span>
    <span class="token comment">-- 使用连接池</span>
    <span class="token keyword">local</span> ok<span class="token punctuation">,</span> err <span class="token operator">=</span> redis_conn<span class="token punctuation">:</span><span class="token function">set_keepalive</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">-- (超时时间 ms, 连接池大小)</span>
<span class="token keyword">end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="服务端适配" tabindex="-1"><a class="header-anchor" href="#服务端适配" aria-hidden="true">#</a> 服务端适配</h2><h3 id="服务端生成token" tabindex="-1"><a class="header-anchor" href="#服务端生成token" aria-hidden="true">#</a> 服务端生成token</h3><p>通过PyJWT包进行token的生成，需要在payload中添加 <code>exp</code>（过期时间）与<code>nbf</code>（生成时间）</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> jwt

secret_key <span class="token operator">=</span> <span class="token string">&#39;1234567891234567891234567891234567891234567&#39;</span>
now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span>
expiry <span class="token operator">=</span> now <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment"># 传入payload，私钥，加密算法</span>
token <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;phone&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;13011111111&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;exp&#39;</span><span class="token punctuation">:</span> expiry<span class="token punctuation">,</span> <span class="token string">&#39;nbf&#39;</span><span class="token punctuation">:</span> now<span class="token punctuation">}</span><span class="token punctuation">,</span> secret_key<span class="token punctuation">,</span> algorithm<span class="token operator">=</span><span class="token string">&#39;HS256&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="服务端对postgresql的支持" tabindex="-1"><a class="header-anchor" href="#服务端对postgresql的支持" aria-hidden="true">#</a> 服务端对Postgresql的支持</h3><ul><li><p>通过<code>sudo pip3 install Flask-SQLAlchemy==2.5.1</code>安装Flask-SQLAlchemy。</p><ul><li>问题1： <em>src/greenlet/greenlet.cpp:16:20: 致命错误：Python.h：没有那个文件或目录</em> 。解决办法： <code>sudo yum install -y python3-devel</code>安装</li><li>问题2： <em>inline T borrow() const G_NOEXCEPT</em> 即gcc报错。 解决办法：升级pip <code>python3 -m pip install --upgrade pip</code></li><li>问题3： 服务端报错<em>ModuleNotFoundError: No module named &#39;psycopg2&#39;</em> 。 解决办法： 安装psycopg2</li></ul></li><li><p>通过<code>sudo pip3 install psycopg2-binary </code>安装psycopg2。</p><ul><li>问题： <em>Error: pg_config executable not found.</em> 。 解决办法： 确保安装 <em>postgresql96-devel</em> 后，在环境变量PATH中指明pg_config的位置 <em>/usr/pgsql-9.6/bin</em></li></ul></li><li><p>Flask连接Postgresql</p></li></ul><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> jwt
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> jsonify<span class="token punctuation">,</span> request
<span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy

<span class="token comment"># 连接数据库</span>
app_a <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app_a<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;postgresql://kong:1234@127.0.0.1/kong&#39;</span>
app_a<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">&#39;SQLALCHEMY_COMMIT_ON_TEARDOWN&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span>app_a<span class="token punctuation">)</span>

<span class="token comment"># 模型类</span>
<span class="token keyword">class</span> <span class="token class-name">LoginUser</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">&#39;login_user&#39;</span>
    phone <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">&#39;手机号&#39;</span><span class="token punctuation">)</span>
    username <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">&#39;昵称&#39;</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">&#39;密码&#39;</span><span class="token punctuation">)</span>
    level <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>SMALLINT<span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">&#39;用户权限&#39;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&#39;&lt;User %r&gt;&#39;</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>phone


<span class="token decorator annotation punctuation">@app_a<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&#39;/auth&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    phone <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;password&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>phone<span class="token punctuation">,</span> password<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">&#39;msg&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Missing required params!&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment"># 查库进行账号认证</span>
    user <span class="token operator">=</span> LoginUser<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>phone<span class="token operator">=</span>phone<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user<span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">&#39;msg&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;User not exist!&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> user<span class="token punctuation">.</span>password <span class="token operator">!=</span> password<span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">&#39;msg&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Password incorrect!&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">&#39;msg&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;server A - level 1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&#39;header&#39;</span><span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment"># # flask --app a run</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    app_a<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">&#39;0.0.0.0&#39;</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="sso服务端的完整代码" tabindex="-1"><a class="header-anchor" href="#sso服务端的完整代码" aria-hidden="true">#</a> SSO服务端的完整代码</h3><p>该服务端仅用于 token分发 及 接口权限管理</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> jwt
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta
<span class="token keyword">from</span> redis <span class="token keyword">import</span> StrictRedis
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> jsonify<span class="token punctuation">,</span> request<span class="token punctuation">,</span> current_app
<span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy

<span class="token comment"># 连接redis与postgresql</span>
app_a <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app_a<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;postgresql://kong:1234@127.0.0.1/kong&#39;</span>
app_a<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">&#39;SQLALCHEMY_COMMIT_ON_TEARDOWN&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span>app_a<span class="token punctuation">)</span>
app_a<span class="token punctuation">.</span>redis_master <span class="token operator">=</span> StrictRedis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">&#39;127.0.0.1&#39;</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span> decode_responses<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Role</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">&#39;api_mgr&#39;</span>
    sign <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">&#39;api签名&#39;</span><span class="token punctuation">)</span>
    path <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">&#39;路径&#39;</span><span class="token punctuation">)</span>
    service <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>SMALLINT<span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">&#39;服务ID&#39;</span><span class="token punctuation">)</span>
    auth_level <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>SMALLINT<span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">&#39;api权限&#39;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&#39;&lt;Api %r&gt;&#39;</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>sign


<span class="token keyword">class</span> <span class="token class-name">LoginUser</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">&#39;login_user&#39;</span>
    phone <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">&#39;手机号&#39;</span><span class="token punctuation">)</span>
    username <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">&#39;昵称&#39;</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">&#39;密码&#39;</span><span class="token punctuation">)</span>
    level <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>SMALLINT<span class="token punctuation">,</span> doc<span class="token operator">=</span><span class="token string">&#39;用户权限&#39;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&#39;&lt;User %r&gt;&#39;</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>phone


<span class="token decorator annotation punctuation">@app_a<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># token生成</span>
    secret_key <span class="token operator">=</span> <span class="token string">&#39;1234567891234567891234567891234567891234567&#39;</span>
    now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span>
    expiry <span class="token operator">=</span> now <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
    token <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;phone&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;13011111111&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;exp&#39;</span><span class="token punctuation">:</span> expiry<span class="token punctuation">,</span> <span class="token string">&#39;nbf&#39;</span><span class="token punctuation">:</span> now<span class="token punctuation">}</span><span class="token punctuation">,</span> secret_key<span class="token punctuation">,</span> algorithm<span class="token operator">=</span><span class="token string">&#39;HS256&#39;</span><span class="token punctuation">)</span>

    <span class="token comment"># 测试对postgresql的支持</span>
    users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&#39;phone&#39;</span><span class="token punctuation">:</span> user<span class="token punctuation">.</span>phone<span class="token punctuation">,</span> <span class="token string">&#39;username&#39;</span><span class="token punctuation">:</span> user<span class="token punctuation">.</span>username<span class="token punctuation">}</span> <span class="token keyword">for</span> user <span class="token keyword">in</span> LoginUser<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token comment"># 账号多登录的处理</span>
    old_token <span class="token operator">=</span> current_app<span class="token punctuation">.</span>redis_master<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;login:13011111111&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> old_token<span class="token punctuation">:</span>
        current_app<span class="token punctuation">.</span>redis_master<span class="token punctuation">.</span>setex<span class="token punctuation">(</span><span class="token string">&#39;conflict:&#39;</span> <span class="token operator">+</span> old_token<span class="token punctuation">,</span> <span class="token number">3600</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    current_app<span class="token punctuation">.</span>redis_master<span class="token punctuation">.</span>setex<span class="token punctuation">(</span><span class="token string">&#39;login:13011111111&#39;</span><span class="token punctuation">,</span> <span class="token number">3600</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">,</span> token1<span class="token punctuation">)</span>

    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token string">&#39;msg&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;server A - level 0&#39;</span><span class="token punctuation">,</span>
        <span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&#39;header&#39;</span><span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&#39;token&#39;</span><span class="token punctuation">:</span> token<span class="token punctuation">,</span>
            <span class="token string">&#39;users&#39;</span><span class="token punctuation">:</span> users
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_a<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&#39;/auth&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    phone <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;password&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>phone<span class="token punctuation">,</span> password<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">&#39;msg&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Missing required params!&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment"># 测试对postgresql的支持</span>
    user <span class="token operator">=</span> LoginUser<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>phone<span class="token operator">=</span>phone<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> user<span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">&#39;msg&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;User not exist!&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> user<span class="token punctuation">.</span>password <span class="token operator">!=</span> password<span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">&#39;msg&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;Password incorrect!&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">&#39;msg&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;server A - level 1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&#39;header&#39;</span><span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app_a<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&quot;/admin&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 接口权限与用户权限不匹配的测试</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;success&#39;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">&#39;msg&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;server A - level 2&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&#39;header&#39;</span><span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment"># # flask --app a run</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    app_a<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">&#39;0.0.0.0&#39;</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="部署至生产服务器" tabindex="-1"><a class="header-anchor" href="#部署至生产服务器" aria-hidden="true">#</a> 部署至生产服务器</h2><h3 id="多服务的多host域名部署" tabindex="-1"><a class="header-anchor" href="#多服务的多host域名部署" aria-hidden="true">#</a> 多服务的多HOST域名部署</h3><p>当设置多个不同的后端域名时（如协议不一致时）</p><ul><li><p>客户端请求服务通过 <code>api.*.*.com</code> ，nginx监听80端口后转发到服务端8000端口来传入网关</p></li><li><p>由于此时option请求无法到达后端，需在nginx统一配置跨域。此时后端无需再配置跨域信息</p></li></ul><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  api.&lt;service_sign&gt;.*.com</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$request_method</span> = OPTIONS )</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">add_header</span> <span class="token string">&#39;Access-Control-Allow-Origin&#39;</span> <span class="token string">&#39;*&#39;</span> always</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">add_header</span> <span class="token string">&#39;Access-Control-Allow-Methods&#39;</span> <span class="token string">&#39;GET, POST, PUT, DELETE, PATCH,OPTIONS&#39;</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">add_header</span> <span class="token string">&#39;Access-Control-Allow-Headers&#39;</span> <span class="token string">&#39;DNT,web-token,app-token,Authorization,Accept,Origin,Keep-Alive,User-Agent,X-Mx-ReqToken,X-Data-Type,X-Auth-Token,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range&#39;</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">add_header</span> <span class="token string">&#39;Access-Control-Expose-Headers&#39;</span> <span class="token string">&#39;Content-Length,Content-Range&#39;</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token number">204</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_read_timeout</span> <span class="token number">300</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:8000</span><span class="token punctuation">;</span>  <span class="token comment"># 转发给kong</span>
        <span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Proto <span class="token variable">$scheme</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Port <span class="token number">80</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="多服务的单host域名部署" tabindex="-1"><a class="header-anchor" href="#多服务的单host域名部署" aria-hidden="true">#</a> 多服务的单HOST域名部署</h3><p>当设置一个统一域名，通过地址区分不同服务（协议必须统一）。如 <code>api.*.com/a/*</code> 用于请求A服务， <code>api.*.com/b/*</code> 用于请求B服务</p><ul><li>配置主域名的nginx</li></ul><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  api.*.com</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$request_method</span> = OPTIONS )</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">add_header</span> <span class="token string">&#39;Access-Control-Allow-Origin&#39;</span> <span class="token string">&#39;*&#39;</span> always</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">add_header</span> <span class="token string">&#39;Access-Control-Allow-Methods&#39;</span> <span class="token string">&#39;GET, POST, PUT, DELETE, PATCH,OPTIONS&#39;</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">add_header</span> <span class="token string">&#39;Access-Control-Allow-Headers&#39;</span> <span class="token string">&#39;DNT,web-token,app-token,Authorization,Accept,Origin,Keep-Alive,User-Agent,X-Mx-ReqToken,X-Data-Type,X-Auth-Token,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range&#39;</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">add_header</span> <span class="token string">&#39;Access-Control-Expose-Headers&#39;</span> <span class="token string">&#39;Content-Length,Content-Range&#39;</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token number">204</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># 服务a</span>
    <span class="token directive"><span class="token keyword">location</span> ~ ^/a/</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_read_timeout</span> <span class="token number">300</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:8000</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Proto <span class="token variable">$scheme</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Port <span class="token number">80</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment"># 服务b</span>
    <span class="token directive"><span class="token keyword">location</span> ~ ^/b/</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_read_timeout</span> <span class="token number">300</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:8000</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Proto <span class="token variable">$scheme</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Port <span class="token number">80</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>配置kong通过路径进行路由转发</li></ul><div class="macos language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">--url</span> http://localhost:8001/services/<span class="token operator">&lt;</span>service_name<span class="token operator">&gt;</span>/routes <span class="token parameter variable">--data</span> <span class="token string">&#39;name=&lt;router_name&gt;&#39;</span> <span class="token parameter variable">--data</span> <span class="token string">&#39;hosts[]=api.*.com&#39;</span> <span class="token parameter variable">--data</span> <span class="token string">&#39;paths[]=/&lt;service_sign&gt;/&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>插件内通过 <code>kong.router.get_route()</code> 可直接判断需要转发的目标服务。以下为日志打印route信息</li></ul><div class="macos language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token punctuation">{</span>
    created_at <span class="token operator">=</span> <span class="token operator">&lt;</span>route_create_timestamp<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    hosts <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;api.*.com&quot;</span><span class="token punctuation">,</span>
        <span class="token operator">&lt;</span>metatable<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
            __class <span class="token operator">=</span> <span class="token punctuation">{</span>
                __base <span class="token operator">=</span> <span class="token operator">&lt;</span>table <span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
                __init <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token keyword">function</span> <span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
                __name <span class="token operator">=</span> <span class="token string">&quot;PostgresArray&quot;</span><span class="token punctuation">,</span>
                <span class="token operator">&lt;</span>metatable<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                    __call <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token keyword">function</span> <span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
                    __index <span class="token operator">=</span> <span class="token operator">&lt;</span>table <span class="token number">1</span><span class="token operator">&gt;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            __index <span class="token operator">=</span> <span class="token operator">&lt;</span>table <span class="token number">1</span><span class="token operator">&gt;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    id <span class="token operator">=</span> <span class="token string">&quot;&lt;route_id&gt;&quot;</span><span class="token punctuation">,</span>
    name <span class="token operator">=</span> <span class="token string">&quot;&lt;route_name&gt;&quot;</span><span class="token punctuation">,</span>
    paths <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;/&lt;service_sign&gt;/&quot;</span><span class="token punctuation">,</span>
        <span class="token operator">&lt;</span>metatable<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token operator">&lt;</span>table <span class="token number">1</span><span class="token operator">&gt;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    preserve_host <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
    protocols <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https&quot;</span><span class="token punctuation">,</span>
        <span class="token operator">&lt;</span>metatable<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            __index <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token keyword">function</span> <span class="token number">3</span><span class="token operator">&gt;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    regex_priority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    service <span class="token operator">=</span> <span class="token punctuation">{</span>
        id <span class="token operator">=</span> <span class="token string">&quot;&lt;service_id&gt;&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    strip_path <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
    updated_at <span class="token operator">=</span> <span class="token operator">&lt;</span>route_update_timestamp<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>通过<code>kong.request.get_path()</code>获取路径，与路由的路径相剪以获取真实请求路径。根据接口管理判断请求路径是否存在。</li></ul><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token comment">-- 举例</span>
prefix_path <span class="token operator">=</span> kong<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">get_route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>paths<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment">-- /service_a/ lua的数组从1开始</span>
path <span class="token operator">=</span> kong<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">get_path</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">-- /service_a/test</span>

<span class="token comment">-- 服务端得到的真实请求地址为 /test</span>
r_path <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">gsub</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">&quot;^&quot;</span><span class="token operator">..</span><span class="token string">&quot;/service_a/&quot;</span><span class="token punctuation">,</span> <span class="token function">tostring</span><span class="token punctuation">(</span>service_id<span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="插件开发中遇到的问题" tabindex="-1"><a class="header-anchor" href="#插件开发中遇到的问题" aria-hidden="true">#</a> 插件开发中遇到的问题</h2><ul><li><p>在编辑完schema.lua后，加载插件时出现以下问题</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[error] 2546#0: init_by_lua error: /usr/local/share/lua/5.1/kong/init.lua:402: error loading plugin schemas: on plugin &#39;kong_jwt_url_auth&#39;: [postgres] schema violation (fields.3: {
    fields = {
        [2] = {
            description = &quot;unknown field&quot;
        }
    }
})
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由报错信息可知，<code>descrption</code>字段不被支持。1.x版本的Kong在schema的配置中不支持descrption字段，新版本支持。插件源码中含有<code>descrption</code>字段。</p></li></ul></div><div id="comment" class="giscus-wrapper input-top" style="display:block;" data-v-77edf713><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div></div><!--]--><footer class="page_footer" data-v-2c01bf66><div class="footer_middle card_border" data-v-2c01bf66><!--[--><span data-v-2c01bf66>Released under the MIT License. <br data-v-2c01bf66></span><span data-v-2c01bf66>Copyright © 2023-present Leopold <br data-v-2c01bf66></span><!--]--></div></footer></div></div></div></div><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-68631362.js" defer></script>
  </body>
</html>
