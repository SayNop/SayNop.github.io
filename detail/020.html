<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.68">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <meta property="og:url" content="https://saynop.github.io/detail/020.html"><meta property="og:title" content="JS原型链与补环境"><meta property="og:description" content="原型 __proto__：在js中，每个实例对象都拥有 __proto__（隐式原型），实例的 __proto__.constructor 指明该实例创建时使用的构造方法 。如下所示 prototype: 函数除了拥有__proto__，还额外拥有prototype（显示原型）"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="article:tag" content="Spider"><meta property="article:tag" content="Reverse"><meta property="article:published_time" content="2024-12-21T00:00:00.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"JS原型链与补环境","image":[""],"datePublished":"2024-12-21T00:00:00.000Z","dateModified":null,"author":[]}</script><link rel="icon" href="/favicon.ico"><title>JS原型链与补环境</title><meta name="description" content="原型 __proto__：在js中，每个实例对象都拥有 __proto__（隐式原型），实例的 __proto__.constructor 指明该实例创建时使用的构造方法 。如下所示 prototype: 函数除了拥有__proto__，还额外拥有prototype（显示原型）">
    <link rel="preload" href="/assets/style-89225919.css" as="style"><link rel="stylesheet" href="/assets/style-89225919.css">
    <link rel="modulepreload" href="/assets/app-101bb220.js"><link rel="modulepreload" href="/assets/020.html-b8cf5b75.js"><link rel="modulepreload" href="/assets/020.html-4dd3991a.js">
    <link rel="prefetch" href="/assets/index.html-f33fda43.js" as="script"><link rel="prefetch" href="/assets/001.html-12451cc3.js" as="script"><link rel="prefetch" href="/assets/002.html-a6d5828c.js" as="script"><link rel="prefetch" href="/assets/003.html-6c773146.js" as="script"><link rel="prefetch" href="/assets/004.html-689926d8.js" as="script"><link rel="prefetch" href="/assets/005.html-d6b96039.js" as="script"><link rel="prefetch" href="/assets/006.html-5b50a542.js" as="script"><link rel="prefetch" href="/assets/007.html-d3b6ddc8.js" as="script"><link rel="prefetch" href="/assets/008.html-042c4a7a.js" as="script"><link rel="prefetch" href="/assets/009.html-7d1574d7.js" as="script"><link rel="prefetch" href="/assets/010.html-f1724340.js" as="script"><link rel="prefetch" href="/assets/011.html-10672fd1.js" as="script"><link rel="prefetch" href="/assets/012.html-5e7aa08e.js" as="script"><link rel="prefetch" href="/assets/013.html-8dd46ba3.js" as="script"><link rel="prefetch" href="/assets/014.html-d0db391f.js" as="script"><link rel="prefetch" href="/assets/015.html-7a04f43c.js" as="script"><link rel="prefetch" href="/assets/016.html-79bc20a6.js" as="script"><link rel="prefetch" href="/assets/017.html-225b58d3.js" as="script"><link rel="prefetch" href="/assets/018.html-185c4621.js" as="script"><link rel="prefetch" href="/assets/019.html-78c7a739.js" as="script"><link rel="prefetch" href="/assets/021.html-58600ead.js" as="script"><link rel="prefetch" href="/assets/404.html-a0fec2a7.js" as="script"><link rel="prefetch" href="/assets/index.html-75381ff5.js" as="script"><link rel="prefetch" href="/assets/index.html-c95ce669.js" as="script"><link rel="prefetch" href="/assets/index.html-2c56dc8e.js" as="script"><link rel="prefetch" href="/assets/index.html-98874abd.js" as="script"><link rel="prefetch" href="/assets/index.html-b2308fb7.js" as="script"><link rel="prefetch" href="/assets/index.html-10e703b4.js" as="script"><link rel="prefetch" href="/assets/index.html-5f3af54d.js" as="script"><link rel="prefetch" href="/assets/index.html-56349a98.js" as="script"><link rel="prefetch" href="/assets/index.html-a7c2713a.js" as="script"><link rel="prefetch" href="/assets/index.html-2e96c3d2.js" as="script"><link rel="prefetch" href="/assets/index.html-9f1eff22.js" as="script"><link rel="prefetch" href="/assets/index.html-16b34053.js" as="script"><link rel="prefetch" href="/assets/index.html-4e233464.js" as="script"><link rel="prefetch" href="/assets/index.html-d90f0ec9.js" as="script"><link rel="prefetch" href="/assets/index.html-3202320f.js" as="script"><link rel="prefetch" href="/assets/index.html-c3fe2c85.js" as="script"><link rel="prefetch" href="/assets/index.html-f3052411.js" as="script"><link rel="prefetch" href="/assets/index.html-5485bfc3.js" as="script"><link rel="prefetch" href="/assets/index.html-a7568890.js" as="script"><link rel="prefetch" href="/assets/index.html-9d25f5f2.js" as="script"><link rel="prefetch" href="/assets/index.html-b9dd3162.js" as="script"><link rel="prefetch" href="/assets/index.html-ff33d682.js" as="script"><link rel="prefetch" href="/assets/index.html-3bce843e.js" as="script"><link rel="prefetch" href="/assets/index.html-09b9da96.js" as="script"><link rel="prefetch" href="/assets/index.html-750acad1.js" as="script"><link rel="prefetch" href="/assets/index.html-1c1e573d.js" as="script"><link rel="prefetch" href="/assets/index.html-8eb4570b.js" as="script"><link rel="prefetch" href="/assets/index.html-7dd1db94.js" as="script"><link rel="prefetch" href="/assets/index.html-32048506.js" as="script"><link rel="prefetch" href="/assets/index.html-a4e9e805.js" as="script"><link rel="prefetch" href="/assets/index.html-df3e534f.js" as="script"><link rel="prefetch" href="/assets/index.html-cb3cc9f5.js" as="script"><link rel="prefetch" href="/assets/index.html-0994fca8.js" as="script"><link rel="prefetch" href="/assets/index.html-a902e771.js" as="script"><link rel="prefetch" href="/assets/index.html-76fbbff6.js" as="script"><link rel="prefetch" href="/assets/index.html-7bc29919.js" as="script"><link rel="prefetch" href="/assets/index.html-2642a77f.js" as="script"><link rel="prefetch" href="/assets/index.html-8dfad283.js" as="script"><link rel="prefetch" href="/assets/index.html-0e75c0da.js" as="script"><link rel="prefetch" href="/assets/index.html-1d59d05d.js" as="script"><link rel="prefetch" href="/assets/index.html-5789a1c9.js" as="script"><link rel="prefetch" href="/assets/index.html-a74daf45.js" as="script"><link rel="prefetch" href="/assets/index.html-12b75b8f.js" as="script"><link rel="prefetch" href="/assets/index.html-b2ab7a90.js" as="script"><link rel="prefetch" href="/assets/001.html-951aa1d5.js" as="script"><link rel="prefetch" href="/assets/002.html-29cee426.js" as="script"><link rel="prefetch" href="/assets/003.html-af79d517.js" as="script"><link rel="prefetch" href="/assets/004.html-df4034f9.js" as="script"><link rel="prefetch" href="/assets/005.html-1ad41c6e.js" as="script"><link rel="prefetch" href="/assets/006.html-acb815b5.js" as="script"><link rel="prefetch" href="/assets/007.html-70f3582e.js" as="script"><link rel="prefetch" href="/assets/008.html-358922d0.js" as="script"><link rel="prefetch" href="/assets/009.html-7faf24be.js" as="script"><link rel="prefetch" href="/assets/010.html-86f09aeb.js" as="script"><link rel="prefetch" href="/assets/011.html-ef9199e5.js" as="script"><link rel="prefetch" href="/assets/012.html-1ba2b184.js" as="script"><link rel="prefetch" href="/assets/013.html-c4d7cd84.js" as="script"><link rel="prefetch" href="/assets/014.html-79d16834.js" as="script"><link rel="prefetch" href="/assets/015.html-14b1dc76.js" as="script"><link rel="prefetch" href="/assets/016.html-7c5a4d20.js" as="script"><link rel="prefetch" href="/assets/017.html-cb5df78e.js" as="script"><link rel="prefetch" href="/assets/018.html-a5cc1730.js" as="script"><link rel="prefetch" href="/assets/019.html-c29facde.js" as="script"><link rel="prefetch" href="/assets/021.html-77ffeb7e.js" as="script"><link rel="prefetch" href="/assets/404.html-106e0ea6.js" as="script"><link rel="prefetch" href="/assets/index.html-ffa0d197.js" as="script"><link rel="prefetch" href="/assets/index.html-0a590154.js" as="script"><link rel="prefetch" href="/assets/index.html-bdbffe49.js" as="script"><link rel="prefetch" href="/assets/index.html-2a32793d.js" as="script"><link rel="prefetch" href="/assets/index.html-122a2d96.js" as="script"><link rel="prefetch" href="/assets/index.html-27c4c7b8.js" as="script"><link rel="prefetch" href="/assets/index.html-374807a3.js" as="script"><link rel="prefetch" href="/assets/index.html-040a12ac.js" as="script"><link rel="prefetch" href="/assets/index.html-00a549f5.js" as="script"><link rel="prefetch" href="/assets/index.html-770d9f6e.js" as="script"><link rel="prefetch" href="/assets/index.html-704e065c.js" as="script"><link rel="prefetch" href="/assets/index.html-50a41a7b.js" as="script"><link rel="prefetch" href="/assets/index.html-8a221954.js" as="script"><link rel="prefetch" href="/assets/index.html-b264b1c4.js" as="script"><link rel="prefetch" href="/assets/index.html-e780e857.js" as="script"><link rel="prefetch" href="/assets/index.html-b50d5845.js" as="script"><link rel="prefetch" href="/assets/index.html-567982f2.js" as="script"><link rel="prefetch" href="/assets/index.html-56c7e37f.js" as="script"><link rel="prefetch" href="/assets/index.html-885e6622.js" as="script"><link rel="prefetch" href="/assets/index.html-0d1a8961.js" as="script"><link rel="prefetch" href="/assets/index.html-b18fa44c.js" as="script"><link rel="prefetch" href="/assets/index.html-b91c839f.js" as="script"><link rel="prefetch" href="/assets/index.html-b7ac3d4e.js" as="script"><link rel="prefetch" href="/assets/index.html-682304be.js" as="script"><link rel="prefetch" href="/assets/index.html-8560dbcb.js" as="script"><link rel="prefetch" href="/assets/index.html-d91485b9.js" as="script"><link rel="prefetch" href="/assets/index.html-82451a06.js" as="script"><link rel="prefetch" href="/assets/index.html-df4b0413.js" as="script"><link rel="prefetch" href="/assets/index.html-39ddd48f.js" as="script"><link rel="prefetch" href="/assets/index.html-efb50a21.js" as="script"><link rel="prefetch" href="/assets/index.html-5a128c0b.js" as="script"><link rel="prefetch" href="/assets/index.html-ee99b72a.js" as="script"><link rel="prefetch" href="/assets/index.html-8291c8ac.js" as="script"><link rel="prefetch" href="/assets/index.html-8505e1ce.js" as="script"><link rel="prefetch" href="/assets/index.html-9fd54cc3.js" as="script"><link rel="prefetch" href="/assets/index.html-0607c7ec.js" as="script"><link rel="prefetch" href="/assets/index.html-51ac1d9b.js" as="script"><link rel="prefetch" href="/assets/index.html-3ccb9e58.js" as="script"><link rel="prefetch" href="/assets/index.html-3ecf194f.js" as="script"><link rel="prefetch" href="/assets/index.html-050b2b9a.js" as="script"><link rel="prefetch" href="/assets/index.html-37748b1e.js" as="script"><link rel="prefetch" href="/assets/index.html-e0c8825d.js" as="script"><link rel="prefetch" href="/assets/index.html-45fd2a32.js" as="script"><link rel="prefetch" href="/assets/giscus-0b7adcf8.js" as="script"><link rel="prefetch" href="/assets/SearchResult-f0d10221.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div data-v-77edf713><header class="header" style="opacity:0;" data-v-90176301><div class="header_container" data-v-90176301><div data-v-90176301><a class="header_title" href="/" data-v-90176301>Leopold&#39;s Blog</a></div><div class="appearance" data-v-90176301><!--[--><button type="button" class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><!----></button><!--]--><button class="switch" data-v-90176301><span class="icon" style="display:block;" data-v-90176301><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" style="" data-v-90176301><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" style="display:none;" data-v-90176301><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg></span></button><button class="switch mobile_list_btn" type="button" data-v-90176301><span class="btn_top" data-v-90176301></span><span class="btn_middle" data-v-90176301></span><span class="btn_bottom" data-v-90176301></span></button></div></div></header><div class="main"><div class="background" data-v-fee8de4c><svg class="pull_down" viewbox="0 0 1026 1024" xmlns="http://www.w3.org/2000/svg" data-v-fee8de4c data-v-3c8412b0><path d="M857.088 224.256q28.672-28.672 69.12-28.672t69.12 28.672q29.696 28.672 29.696 68.608t-29.696 68.608l-382.976 380.928q-12.288 14.336-30.72 19.968t-38.912 4.608-40.448-8.704-34.304-22.016l-376.832-374.784q-29.696-28.672-29.696-68.608t29.696-68.608q14.336-14.336 32.256-21.504t36.864-7.168 37.376 7.168 32.768 21.504l313.344 309.248z" data-v-3c8412b0></path></svg></div><div style="display:flex;"><div class="sider_keeper" data-v-e01a06ce><div class="folding" data-v-e01a06ce><!-- <div class="folding"> --><div class="sidebar_top card_border" style="min-height:1rem" data-v-e01a06ce><div class="tags_brand" data-v-e01a06ce>本文大纲</div><section class="article_sidebar" data-v-e01a06ce data-v-905b99e1><ul data-v-905b99e1><!--[--><li class="level2" data-v-905b99e1><a class="sidebar-link" href="#原型" data-v-905b99e1>原型</a><ul class="level3" data-v-905b99e1><!--[--><!--]--></ul></li><li class="level2" data-v-905b99e1><a class="sidebar-link" href="#构造方法" data-v-905b99e1>构造方法</a><ul class="level3" data-v-905b99e1><!--[--><!--]--></ul></li><li class="level2" data-v-905b99e1><a class="sidebar-link" href="#考虑继承关系时声明类" data-v-905b99e1>考虑继承关系时声明类</a><ul class="level3" data-v-905b99e1><!--[--><!--]--></ul></li><li class="level2" data-v-905b99e1><a class="sidebar-link" href="#原型链检测" data-v-905b99e1>原型链检测</a><ul class="level3" data-v-905b99e1><!--[--><!--]--></ul></li><li class="level2" data-v-905b99e1><a class="sidebar-link" href="#补环境" data-v-905b99e1>补环境</a><ul class="level3" data-v-905b99e1><!--[--><li data-v-905b99e1><a class="sidebar-link" href="#使用代理明确检测内容" data-v-905b99e1>使用代理明确检测内容</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><li data-v-905b99e1><a class="sidebar-link" href="#常规处理流程" data-v-905b99e1>常规处理流程</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><li data-v-905b99e1><a class="sidebar-link" href="#结果检测" data-v-905b99e1>结果检测</a><ul class="level4" data-v-905b99e1><!--[--><!--]--></ul></li><!--]--></ul></li><li class="level2" data-v-905b99e1><a class="sidebar-link" href="#tostring检测" data-v-905b99e1>toString检测</a><ul class="level3" data-v-905b99e1><!--[--><!--]--></ul></li><!--]--></ul></section></div><div class="sidebar_bottom card_border" data-v-e01a06ce><div class="avatar" style="background-image:url(/assets/imgs/avatar.jpg);" data-v-e01a06ce></div><div class="author" data-v-e01a06ce>Leopold</div><div class="summary" data-v-e01a06ce><div data-v-e01a06ce><p data-v-e01a06ce>文章</p></div><div data-v-e01a06ce><p data-v-e01a06ce>分类</p></div><div data-v-e01a06ce><p data-v-e01a06ce>标签</p></div><div data-v-e01a06ce><p data-v-e01a06ce>21</p></div><div data-v-e01a06ce><p data-v-e01a06ce>10</p></div><div data-v-e01a06ce><p data-v-e01a06ce>31</p></div></div><div class="connection" data-v-e01a06ce><div class="grid_icon" data-v-e01a06ce><svg viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon" data-v-e01a06ce><path d="M1023.560892 524.587752c0 114.331752-32.549236 217.148443-97.647709 308.450075-65.047295 91.301632-149.132822 154.455339-252.205404 189.512299-11.975662 2.303012-20.778286 0.716493-26.305515-4.759558a27.584966 27.584966 0 0 1-8.342021-20.471218V853.150798c0-44.166653-11.566238-76.511177-34.647536-96.982394a446.272549 446.272549 0 0 0 68.32269-12.282731c20.16415-5.476051 41.044792-14.329852 62.590748-26.612583a187.311643 187.311643 0 0 0 53.992837-45.446104c14.432209-18.014672 26.203159-41.914819 35.312851-71.751618 9.109692-29.8368 13.664538-64.074912 13.664538-102.765514 0-55.118754-17.554069-102.049021-52.61103-140.739623 16.376974-41.454216 14.636921-87.872703-5.373695-139.357815-12.436265-4.094244-30.399759-1.535341-53.941659 7.523172a355.17563 355.17563 0 0 0-61.311297 30.041513l-25.333132 16.376974a462.137743 462.137743 0 0 0-127.945112-17.707604 462.137743 462.137743 0 0 0-127.945111 17.758782 589.571074 589.571074 0 0 0-28.301459-18.424096c-11.77095-7.31846-30.34858-16.069906-55.681713-26.305515-25.281954-10.235609-44.422543-13.306292-57.31941-9.212048-19.498835 51.433935-21.085354 97.852421-4.606024 139.306637-35.108139 38.690602-52.713386 85.620869-52.713386 140.739623 0 38.690602 4.606024 72.826357 13.715716 102.458445 9.109692 29.58091 20.778286 53.481057 34.954605 71.700441a180.658498 180.658498 0 0 0 53.634591 45.753172c21.545957 12.282731 42.477777 21.18771 62.641926 26.612583 20.215328 5.527229 42.989557 9.621472 68.32269 12.333909-17.758781 16.376974-28.659705 39.867697-32.651593 70.369811a129.941055 129.941055 0 0 1-29.990334 10.235609 184.087426 184.087426 0 0 1-37.974109 3.428929c-14.688099 0-29.171485-4.913092-43.654872-14.688099-14.432209-9.826185-26.766117-24.053681-37.001726-42.682489a109.162769 109.162769 0 0 0-32.293346-35.517563c-13.101579-9.109692-24.104859-14.585743-33.009839-16.376974l-13.306292-2.047122c-9.314404 0-15.762838 1.023561-19.345301 3.070683-3.582463 2.047122-4.606024 4.606024-3.326572 7.83024a37.769397 37.769397 0 0 0 5.987831 9.570295 49.182101 49.182101 0 0 0 8.700267 8.188487l4.606024 3.377751c9.826185 4.606024 19.447657 13.255114 29.017952 25.998447 9.570294 12.743333 16.581686 24.360749 20.982998 34.80107l6.653146 15.71166c5.783119 17.298179 15.558126 31.320963 29.376197 42.017174 13.766894 10.747389 28.659705 17.554069 44.627255 20.471218 15.96755 2.968327 31.423319 4.606024 46.316131 4.810736 14.841633 0.204712 27.22672-0.562958 37.001726-2.405368l15.302235-2.712436c0 17.298179 0.102356 37.564685 0.358247 60.799517l0.307068 36.848192c0 8.188487-2.86597 15.046345-8.700268 20.471218-5.731941 5.527229-14.636921 7.113748-26.612583 4.810736-103.072582-35.056961-187.158109-98.261846-252.205404-189.512299C32.549236 741.736195 0 638.919504 0 524.587752c0-95.191163 22.876586-182.910331 68.629758-263.31104a516.028224 516.028224 0 0 1 186.288082-190.894106A491.309228 491.309228 0 0 1 511.780446 0.012795a491.309228 491.309228 0 0 1 256.913784 70.369811 516.028224 516.028224 0 0 1 186.236905 190.894106C1000.684306 341.626242 1023.560892 429.447767 1023.560892 524.587752z"></path></svg></div><div data-v-e01a06ce><span data-v-e01a06ce>github.com/SayNop</span></div><div class="grid_icon" data-v-e01a06ce><svg viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon" data-v-e01a06ce><path d="M512 1024C229.222 1024 0 794.778 0 512S229.222 0 512 0s512 229.222 512 512-229.222 512-512 512z m259.149-568.883h-290.74a25.293 25.293 0 0 0-25.292 25.293l-0.026 63.206c0 13.952 11.315 25.293 25.267 25.293h177.024c13.978 0 25.293 11.315 25.293 25.267v12.646a75.853 75.853 0 0 1-75.853 75.853h-240.23a25.293 25.293 0 0 1-25.267-25.293V417.203a75.853 75.853 0 0 1 75.827-75.853h353.946a25.293 25.293 0 0 0 25.267-25.292l0.077-63.207a25.293 25.293 0 0 0-25.268-25.293H417.152a189.62 189.62 0 0 0-189.62 189.645V771.15c0 13.977 11.316 25.293 25.294 25.293h372.94a170.65 170.65 0 0 0 170.65-170.65V480.384a25.293 25.293 0 0 0-25.293-25.267z"></path></svg></div><div data-v-e01a06ce><span data-v-e01a06ce>gitee.com/WhenTimeGoesBy</span></div><!-- <div class="grid_icon"><mail_icon class="icon" /></div><div><span @click="open_link(themeData.connection_link.mail)">{{ themeData.connection_link.mail }}</span></div> --><div class="grid_icon" data-v-e01a06ce><svg viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon" data-v-e01a06ce><path d="M874.666667 181.333333H149.333333c-40.533333 0-74.666667 34.133333-74.666666 74.666667v512c0 40.533333 34.133333 74.666667 74.666666 74.666667h725.333334c40.533333 0 74.666667-34.133333 74.666666-74.666667V256c0-40.533333-34.133333-74.666667-74.666666-74.666667z m-725.333334 64h725.333334c6.4 0 10.666667 4.266667 10.666666 10.666667v25.6L512 516.266667l-373.333333-234.666667V256c0-6.4 4.266667-10.666667 10.666666-10.666667z m725.333334 533.333334H149.333333c-6.4 0-10.666667-4.266667-10.666666-10.666667V356.266667l356.266666 224c4.266667 4.266667 10.666667 4.266667 17.066667 4.266666s12.8-2.133333 17.066667-4.266666l356.266666-224V768c0 6.4-4.266667 10.666667-10.666666 10.666667z"></path></svg></div><div data-v-e01a06ce><a href="mailto:fur999immer@gmail.com" data-v-e01a06ce>fur999immer@gmail.com</a></div></div></div></div></div><div class="content_container"><!--[--><div class="card_border article_container" data-v-77edf713><div class="frontmatter_info" data-v-77edf713><h1 data-v-77edf713>JS原型链与补环境</h1><div data-v-77edf713>2024-12-21</div><div class="card_tag frontmatter_tags" data-v-77edf713><span class="icon" data-v-77edf713><svg viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" data-v-77edf713><path d="M896 682.666667a42.666667 42.666667 0 0 0-42.666667-42.666667h-85.333333v-85.333333a85.333333 85.333333 0 0 0-85.333333-85.333334h-128V384h85.333333a42.666667 42.666667 0 0 0 42.666667-42.666667V170.666667a42.666667 42.666667 0 0 0-42.666667-42.666667H384a42.666667 42.666667 0 0 0-42.666667 42.666667v170.666666a42.666667 42.666667 0 0 0 42.666667 42.666667h85.333333v85.333333H341.333333a85.333333 85.333333 0 0 0-85.333333 85.333334v85.333333H170.666667a42.666667 42.666667 0 0 0-42.666667 42.666667v170.666666a42.666667 42.666667 0 0 0 42.666667 42.666667h256a42.666667 42.666667 0 0 0 42.666666-42.666667v-170.666666a42.666667 42.666667 0 0 0-42.666666-42.666667H341.333333v-85.333333h341.333334v85.333333h-85.333334a42.666667 42.666667 0 0 0-42.666666 42.666667v170.666666a42.666667 42.666667 0 0 0 42.666666 42.666667h256a42.666667 42.666667 0 0 0 42.666667-42.666667z"></path></svg></span><!--[--><!-- 使用冒泡stop，阻止父组件的跳转覆盖子组件 --><span class="article_category" data-v-77edf713 data-v-c2920afd>Spider</span><!--]--><span class="icon" style="margin-right:5px;" data-v-77edf713><svg viewbox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" data-v-77edf713><path d="M985.6 473.6 985.6 473.6l-256 256-256 256 0 0C454.4 1011.2 422.4 1024 384 1024c-38.4 0-70.4-12.8-89.6-38.4l0 0-256-256 0 0C12.8 710.4 0 678.4 0 640c0-38.4 12.8-70.4 38.4-89.6l0 0 256-256 256-256 0 0C569.6 12.8 601.6 0 640 0l256 0c70.4 0 128 57.6 128 128l0 256C1024 422.4 1011.2 454.4 985.6 473.6zM768 128c-70.4 0-128 57.6-128 128 0 70.4 57.6 128 128 128 70.4 0 128-57.6 128-128C896 185.6 838.4 128 768 128z"></path></svg></span><!--[--><!--[--><!-- 使用冒泡stop，阻止父组件的跳转覆盖子组件 --><span class="article_tag" data-v-77edf713 data-v-15d5095d>Spider</span><!--]--><!--[--><!-- 使用冒泡stop，阻止父组件的跳转覆盖子组件 --><span class="article_tag" data-v-77edf713 data-v-15d5095d>Reverse</span><!--]--><!--]--></div></div><div data-v-77edf713><h2 id="原型" tabindex="-1"><a class="header-anchor" href="#原型" aria-hidden="true">#</a> 原型</h2><ul><li><p><code>__proto__</code>：在js中，每个实例对象都拥有 <code>__proto__</code>（隐式原型），<strong>实例的 <code>__proto__.constructor</code> 指明该实例创建时使用的构造方法</strong> 。如下所示</p><p><img src="/assets/imgs/020/01.png" alt="proto"></p></li><li><p><code>prototype</code>: 函数除了拥有<code>__proto__</code>，还额外拥有<code>prototype</code>（显示原型）</p><p><img src="/assets/imgs/020/02.png" alt="proto"></p></li></ul><h2 id="构造方法" tabindex="-1"><a class="header-anchor" href="#构造方法" aria-hidden="true">#</a> 构造方法</h2><p>在了解原型链前，先了解js中的构造方法。构造方法也是函数，因此也拥有 <code>prototype</code>。构造函数首字母通常大写，表示可以用 <code>new</code> 创建实例</p><p>下面介绍两种构造函数编写方式</p><ul><li><p>传统方式</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">introduce</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hi, I&#39;m </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>效果如下。使用该方法 <code>new</code> 出来的对象，其 <code>__proto__.constructor</code> 指向构造函数</p><p><img src="/assets/imgs/020/03.png" alt="构造方法"></p><p>通过以上例子，可以得到如下结论（Tips：实例通常用到<code>__proto__</code>，构造方法通常用到<code>prototype</code>）</p><ul><li><p><strong>重点1：实例的<code>__proto__.constructor</code> 与 构造函数的 <code>prototype.constructor</code> 指向构造函数自己</strong>，即 <code>otto.__proto__.constructor === Person</code></p></li><li><p><strong>重点2：实例的 <code>__proto__</code> 指向构造函数的 <code>prototype</code></strong></p></li><li><p><strong>重点3：</strong> 构造函数的<code>prototype.__proto__</code>指向父类的 <code>prototype</code>，即 <strong><code>Person.prototype.__proto__ === Object.prototype</code></strong></p></li><li><p><code>this</code>方式绑定的方法为实例私有，实例自己修改后不会影响其他实例，可理解为实例方法</p><p><img src="/assets/imgs/020/04.png" alt="实例方法"></p></li><li><p><strong>重点4：绑定在构造方法的 <code>prototype</code> 内的方法是其所有实例共享的，实例可调用该方法。且在该方法修改时，实例调用也会对应变动</strong>。可理解为随动的类方法</p><p><img src="/assets/imgs/020/05.png" alt="类方法"></p></li></ul></li><li><p>class方式（ES6引入）。代码来自<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Classes/constructor" target="_blank" rel="noopener noreferrer">MDN<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">introduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">你好，我的名字是 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> otto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">&quot;Otto&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

otto<span class="token punctuation">.</span><span class="token function">introduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 你好，我的名字是 Otto</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>效果如下。此时 <code>class</code> 中声明的方法，都会绑定到构造方法的 <code>prototype</code> 中，即所有实例共享</p><p><img src="/assets/imgs/020/06.png" alt="ES6构造方法"></p></li></ul><h2 id="考虑继承关系时声明类" tabindex="-1"><a class="header-anchor" href="#考虑继承关系时声明类" aria-hidden="true">#</a> 考虑继承关系时声明类</h2><p>需要<strong>声明某个类</strong>时，需按照以下流程</p><ul><li>明确其父类并声明</li><li>声明子类（自身）并设置继承关系</li><li>保证子类原型指向与构造函数指向</li></ul><p>注意以下两点</p><ul><li>在新建一个构造方法时，其 <code>prototype.constructor</code> 默认指向自己，即之前提到的重点2默认是成立的</li><li>若需要多个构造方法，其中存在继承关系，则需要保证 <code>&lt;子类&gt;.prototype.__proto__ === &lt;父类&gt;.prototype</code>。采用传统方式需要手动处理，而在处理原型指向后，会影响到重点2构造函数的指向，也需对构造方法指向手动处理</li></ul><p>下面以浏览器中 <em>Element -&gt; HTMLElement -&gt; HTMLHtmlElement / HTMLDivElement / ... (html标签)</em> 的继承关系为例（ Tips：通过重点2查看父类， <code>getParent = (cls) =&gt; {return cls.prototype.__proto__.constructor}</code> ）</p><ul><li><p>传统方式</p><ul><li><p>创建父类<code>Element</code></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function-variable function">Element</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Element</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">// `Element = ` 是利用全局变量自动绑定到全局的特性</span>
<span class="token comment">// 在补环境时，`window = global; delete global;`</span>
<span class="token comment">// 这样声明 Element，会实现 window.Element</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>创建子类<code>HTMLElement</code>继承自父类<code>Element</code></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function-variable function">HTMLElement</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">HTMLElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">Element</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>  <span class="token comment">// 继承逻辑，调用父类构造函数。</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>设置原型链中的指向关系。如果不进行此步骤。<code>HTMLElement</code>的原型链将指向<code>Object</code>，构造方法依然指向自己</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 方法一</span>
<span class="token comment">// 设置子类原型指向，以实现 HTMLElement.prototype.__proto__ === Element.prototype</span>
<span class="token class-name">HTMLHtmlElement</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">HTMLElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>
<span class="token comment">// 保证构造函数指向自己。由于子类原型通过父类原型创建，此时子类原型中的构造方法与父类一致，即指向父类自己，需要修改</span>
<span class="token class-name">HTMLHtmlElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> HTMLHtmlElement

<span class="token comment">// 方法二 同时保证子类原型指向与构造函数指向的设置方法</span>
<span class="token class-name">HTMLElement</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Element</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">constructor</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> HTMLElement<span class="token punctuation">,</span>
        <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p>class方式，自动实现了原型指向问题，无需额外设置</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
window<span class="token punctuation">.</span>Element <span class="token operator">=</span> Element  <span class="token comment">// 需要手动绑定到 window 上，不然 window.Element 会 undefined</span>
<span class="token keyword">class</span> <span class="token class-name">HTMLElement</span> <span class="token keyword">extends</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span>  <span class="token comment">// 声明父类</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 使用父类构造方法</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
window<span class="token punctuation">.</span>HTMLElement <span class="token operator">=</span> Element

<span class="token comment">// 检测</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">HTMLElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>  <span class="token comment">// 应该为false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">HTMLElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__proto__ <span class="token operator">===</span> <span class="token class-name">Element</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>  <span class="token comment">// 应该为true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">HTMLElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">===</span> HTMLElement<span class="token punctuation">)</span>  <span class="token comment">// 应该为true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>Element<span class="token punctuation">)</span>  <span class="token comment">// 不应该为undefined</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Element<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 当前输出 es6 class 模式。需要输出 function native code，可使用toString检测函数处理 safeFunction(Element)来过检测</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>常见浏览器内置的继承关系</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Object
├── EventTarget
│     ├── Node
│     │    ├── Document
│     │    │     └── HTMLDocument
│     │    ├── DocumentFragment
│     │    ├── Element
│     │    │     ├── HTMLElement
│     │    │     │     ├── HTMLHtmlElement
│     │    │     │     ├── HTMLCanvasElement
│     │    │     │     └── ...(html标签)
│     │    │     └── SVGElement
│     │    ├── CharacterData
│     │    │     ├── Text
│     │    │     └── Comment
│     │    └── ...
│     ├── XMLHttpRequestEventTarget
│     │    └── XMLHttpRequest
│     ├── Window
│     ├── Screen (window.screen)
│     ├── Performance
│     ├── Clipboard
│     ├── MediaDevices
│     └── ...
│
├── Navigator (window.navigator)
├── History (window.history)
├── Location (window.location) 
├── Storage (localStorage / sessionStorage)
├── Crypto
├── AbortController
└── ...
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h2 id="原型链检测" tabindex="-1"><a class="header-anchor" href="#原型链检测" aria-hidden="true">#</a> 原型链检测</h2><ul><li><p>常规补环境。常常使用以下代码进行，其中 <code>userAgent</code> 是 <code>navigator</code> 的属性，相当于构造方法中通过 <code>this</code> 绑定到实例上的实例私有属性</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>navigator <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
navigator<span class="token punctuation">.</span>userAgent <span class="token operator">=</span> <span class="token string">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>检测代码。浏览器环境中，<code>navigator</code> 是通过 <code>Navigator</code> 构造方法 <code>new</code> 出来的实例，而 <code>userAgent</code> 是 <code>Navigator.prototype</code> 内的属性，对于 <code>navigator</code> 实例来说是共享属性。以下检测代码会无法通过</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 浏览器环境应该为false，userAgent 不是 navigator 实例的私有属性。而是原型链上的属性（构造方法上的属性）</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">&#39;userAgent&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;invalid&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;pass&#39;</span><span class="token punctuation">)</span>  <span class="token comment">// undefined 才通过检测</span>
<span class="token punctuation">}</span>

<span class="token comment">// 检测是否有属性描述符。原型链上的属性没有描述符</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>navigator<span class="token punctuation">,</span> <span class="token string">&#39;userAgent&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;invalid&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;pass&#39;</span><span class="token punctuation">)</span>  <span class="token comment">// undefined 才通过检测</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>原型链检测的补环境方法</p><ul><li><p>使用构造方法</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 1. 编写构造函数</span>
<span class="token function-variable function">Navigator</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span class="token comment">// 2. 原型链属性补充</span>
<span class="token class-name">Navigator</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">userAgent</span><span class="token operator">:</span> <span class="token string">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36&#39;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 3. 实例化</span>
navigator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Navigator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 4. 绑定window。Tips: 在浏览器中，所有定义的全局内容，都是window的属性</span>
window<span class="token punctuation">.</span>Navigator <span class="token operator">=</span> Navigator

<span class="token comment">// eg: 在浏览器中查看原型 如 document.documentElement.__proto__，指向了HTMLHtmlElement</span>
<span class="token comment">// 而 HTMLHtmlElement 继承自 HTMLElement ，HTMLElement 继承自 Element</span>
window<span class="token punctuation">.</span><span class="token function-variable function">Element</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Element</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
window<span class="token punctuation">.</span><span class="token function-variable function">HTMLElement</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">HTMLElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">Element</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token class-name">HTMLElement</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Element</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>  <span class="token comment">// 设置子类原型指向，以实现 HTMLElement.prototype.__proto__ === Element.prototype。</span>
<span class="token class-name">HTMLElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> HTMLElement  <span class="token comment">// 保证构造函数指向自己。由于原型通过父类创</span>
window<span class="token punctuation">.</span><span class="token function-variable function">HTMLHtmlElement</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">HTMLHtmlElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">HTMLElement</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token class-name">HTMLHtmlElement</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">HTMLElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>
<span class="token class-name">HTMLHtmlElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> HTMLHtmlElement
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>利用 <strong>实例的 <code>__proto__</code> 指向构造函数的 <code>prototype</code></strong> 的特性</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> window <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> navigator <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

navigator<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">userAgent</span><span class="token operator">:</span> <span class="token string">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36&#39;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li></ul><h2 id="补环境" tabindex="-1"><a class="header-anchor" href="#补环境" aria-hidden="true">#</a> 补环境</h2><h3 id="使用代理明确检测内容" tabindex="-1"><a class="header-anchor" href="#使用代理明确检测内容" aria-hidden="true">#</a> 使用代理明确检测内容</h3><p>通过代理的方式，在控制台打印出代码读取了目标对象的哪些属性。以下代理<a href="https://www.cnblogs.com/xiaohai123/p/19068874" target="_blank" rel="noopener noreferrer">代码来源<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><ul><li>环境代理：将浏览器内置对象进行代理，查看内置对象的调用情况<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">let</span> <span class="token function-variable function">setProxyArr</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">proxyObjArr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 环境代理</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> proxyObjArr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{
            get: function(target, property, receiver) {
                console.log(&quot;方法:&quot;, &quot;get&quot;, &quot;对象:&quot;, &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>proxyObjArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;, &quot;属性:&quot;,
                property, &quot;属性类型:&quot;, typeof property, &quot;属性值:&quot;, target[property], &quot;属性值类型:&quot;, typeof target[property]);
                return target[property];
            },
            set: function(target, property, value, receiver) {
                console.log(&quot;方法:&quot;, &quot;set&quot;, &quot;对象:&quot;, &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>proxyObjArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;, &quot;属性:&quot;,
                property, &quot;属性类型:&quot;, typeof property, &quot;属性值:&quot;, value, &quot;属性值类型:&quot;, typeof target[property]);
                return Reflect.set(...arguments);
            }
        }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">try{
            </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>proxyObjArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;
            </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>proxyObjArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = new Proxy(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>proxyObjArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>handler<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);
        } catch (e) {
            </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>proxyObjArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = {};
            </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>proxyObjArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = new Proxy(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>proxyObjArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>handler<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);
        }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
proxyArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;window&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;document&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;location&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;navigator&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;history&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;screen&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// [&#39;window&#39;,&#39;document&#39;,&#39;location&#39;, &#39;navigator&#39;, &#39;history&#39;, &#39;screen&#39;,&#39;span&#39;, &#39;div&#39;,&#39;chrome&#39;,&#39;SCRIPT&#39;, &#39;canvas&#39;,&#39;HEAD&#39;,&#39;body&#39;,&#39;EventTarget&#39;,&#39;navigator.mimeTypes&#39;,&#39;catvm.memory.PluginArray._&#39;,&#39;localStorage&#39;,&#39;sessionStorage&#39;];</span>

window <span class="token operator">=</span> global<span class="token punctuation">;</span>
<span class="token keyword">delete</span> global<span class="token punctuation">;</span>
<span class="token keyword">delete</span> Buffer<span class="token punctuation">;</span>

<span class="token comment">// 需要先补这些对象，再对这些对象挂代理</span>
<span class="token function">setProxyArr</span><span class="token punctuation">(</span>proxyArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>通用代理。若发现检测我们补充内容的属性时，可以代理我们补充内容，打印调用该对象的内容，并执行原本的内容<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 通用代理，当检测补充内容的属性值，用于对补充内容进行代理</span>
    <span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>property <span class="token operator">!==</span> <span class="token string">&#39;isNaN&#39;</span> <span class="token operator">&amp;&amp;</span> property <span class="token operator">!==</span> <span class="token string">&#39;encodeURI&#39;</span> <span class="token operator">&amp;&amp;</span> property <span class="token operator">!==</span> <span class="token string">&#39;Uint8Array&#39;</span> <span class="token operator">&amp;&amp;</span> property <span class="token operator">!==</span> <span class="token string">&#39;undefined&#39;</span> <span class="token operator">&amp;&amp;</span> property <span class="token operator">!==</span> <span class="token string">&#39;JSON&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;方法:&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;get&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;对象:&#39;</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token string">&#39;属性:&#39;</span><span class="token punctuation">,</span> property<span class="token punctuation">,</span>
                <span class="token string">&#39;属性类型:&#39;</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span> property<span class="token punctuation">,</span> <span class="token string">&#39;属性值:&#39;</span><span class="token punctuation">,</span> target<span class="token punctuation">[</span>property<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&#39;属性值类型:&#39;</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span> target<span class="token punctuation">[</span>property<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> target<span class="token punctuation">[</span>property<span class="token punctuation">]</span>
            <span class="token comment">// return Reflect.get(...arguments)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> property<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;方法:&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;set&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;对象&#39;</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token string">&#39;属性:&#39;</span><span class="token punctuation">,</span> property<span class="token punctuation">,</span>
            <span class="token string">&#39;属性类型:&#39;</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span> property<span class="token punctuation">,</span> <span class="token string">&#39;属性值:&#39;</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token string">&#39;属性值类型:&#39;</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span> target<span class="token punctuation">[</span>property<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="常规处理流程" tabindex="-1"><a class="header-anchor" href="#常规处理流程" aria-hidden="true">#</a> 常规处理流程</h3><ul><li><p>补充基本环境。如 <code>window</code>，<code>document</code>，<code>navigator</code> 等浏览器内置对象</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>window <span class="token operator">=</span> global<span class="token punctuation">;</span>
<span class="token keyword">delete</span> Buffer<span class="token punctuation">;</span>  <span class="token comment">// nodejs自带关键字，删除防止检测</span>
<span class="token keyword">delete</span> global<span class="token punctuation">;</span>  <span class="token comment">// 防止检测</span>
window<span class="token punctuation">.</span>parent <span class="token operator">=</span> window<span class="token punctuation">.</span>self <span class="token operator">=</span> window<span class="token punctuation">.</span>top <span class="token operator">=</span> window<span class="token punctuation">.</span>window <span class="token operator">=</span> window<span class="token punctuation">;</span>  <span class="token comment">// 窗口检测，是否存在 iframe 等窗口嵌套</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>挂代理。将基本环境与环境代理放在目标代码前，或放入 <em>env.js</em> 一个js文件中，使用 <code>require(&quot;./env.js&quot;)</code></p></li><li><p>加载目标代码。在补环境后放，可通过 <code>require(&quot;./vmp.js&quot;)</code> 的方式，将vmp自执行函数运行，方便过格式化检测。在<code>require</code> 后，调用vmp中的加密函数</p></li><li><p>运行代码，查看控制台是否log出检测内容。如果没有，打断点后，在控制台输入<code>window</code>，查看window对象是否有代理。如果window已有代理，可能通过 <code>&lt;alias&gt; = winodow;</code> 的别名方式对window调用与检测，搜索 <code>global</code> 、<code>self</code>、<code>this</code>、<code>env</code> 等可能的别名，查看是否有类似别名。将其全局替换为 <code>window</code> 后查看控制台是否正常log</p></li><li><p>运行代码，查看是否异常中断。通常需要补环境使代码可以顺利执行完成</p><p><img src="/assets/imgs/020/07.png" alt="调试运行"></p><ul><li><p><strong>注意：不是所有的异常都需要处理。</strong> 通过勾选以下内容明确原本代码中是否抛出该异常。如出现读取<code>buffer</code>内的属性产生的异常，实际上是检测<code>buffer</code>，在浏览器中也存在该异常，则无需处理，保持与浏览器一致即可</p><p><img src="/assets/imgs/020/08.png" alt="明确异常是否需要处理"></p></li></ul></li><li><p>补充环境。查看调用的 undefined 内容，配合浏览器查看调用内容类型（方法还是属性，是什么类型的属性）。不是每个调用都需要补充，如检测自动化、爬虫框架的特征，配合浏览器环境，此时理应需要结果是<code>undefined</code></p><ul><li><p>常见的待补充内容如下</p><ul><li>方法 <code>document.createElement</code></li><li>属性 <code>document.documentElement</code></li><li>方法 <code>window/document.addEventListener</code></li><li>方法 <code>window.MouseEvent</code></li><li>属性 <code>navigator.webdriver = false</code></li></ul></li><li><p>普通补环境方法。此处以 <code>document.documentElement</code> 为例</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>document <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;createElement&quot;</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;document createElement &quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span>  <span class="token comment">// 通过打印确定调用内容</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>原型链补环境。补充到原型（构造函数prototype）中，详见原型链部分</p><ul><li><p>补属性。绑定到构造函数的原型上使其成为属性。需要先检查属性是否为实例，则声明该实例的构造函数后，使用构造函数实例化，再。此处以 <code>document.documentElement</code> 为例</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">HTMLDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
document <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTMLDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 待绑定对象</span>

<span class="token keyword">function</span> <span class="token function">HTMLHtmlDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment">// 目标属性的构造函数</span>
<span class="token class-name">HTMLDocument</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>documentElement <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTMLHtmlDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 绑定到待绑定类的原型上</span>

<span class="token comment">// Tips:</span>
<span class="token comment">// 严格情况下，需要考虑继承关系，HTMLDocument -&gt; HTMLHtmlDocument</span>
<span class="token comment">// 常用继承关系与构造函数继承方法，可查看原型链部分</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>补方法。在对象的构造函数原型上创建该方法。此处以 <code>document.addEventListener</code> 为例</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">HTMLDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
document <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTMLDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 待绑定对象</span>

<span class="token comment">// 绑定到待绑定类的原型上</span>
<span class="token class-name">HTMLDocument</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">addEventListener</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li></ul></li><li><p>对被调用对象进行代理后返回。查看后续可能检测该对象的内容</p><ul><li><p>普通方式</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>document <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;createElement&quot;</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;document createElement &quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 通过打印确定调用内容</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token operator">==</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// canvas是对象，先返回空对象，挂上代理，查看可能检测canvas的内容</span>
        <span class="token keyword">return</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span>  
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>原型链</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">HTMLDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
document <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTMLDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">HTMLHtmlDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span> 
<span class="token class-name">HTMLDocument</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>documentElement <span class="token operator">=</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HTMLHtmlDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;document.documentElement&#39;</span><span class="token punctuation">)</span>  <span class="token comment">// 补对象后挂上代理</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p>勾选通过代理发现调用canvas中的getContext，进行补充（对于创建和获取，日志打印较为关键）</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>document <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;createElement&quot;</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;document createElement &quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 通过打印确定调用内容</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token operator">==</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment">// 补充的内容</span>
            <span class="token function-variable function">getContext</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;canvas getContext &quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span>  <span class="token comment">// 通过打印确定调用内容</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span>  
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>代码没有异常中断后，勾选 <em>断点（变量下面）-&gt; Caught Exception &amp; Uncaught Exception</em> 。对代码自行 <code>catch</code> 的异常进行分析，查看是否存在明显的错误需要调整。一些环境逻辑可能在通过catch处理而不异常中断</p><p>如 <code>catch</code> 到了一个属性是undefined，控制台log了 getAttribute，说明 getAttribute 为找到，需要补充。可以考虑补充到构造函数原型上。如果获取对象本身是构造函数，则补充到父类的原型上。此处给出几个典型案例</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// E.G. </span>
<span class="token comment">// HTMLElement.getAttribute</span>
<span class="token keyword">class</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token class-name">Element</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>custom <span class="token operator">=</span> <span class="token string">&#39;custom&#39;</span>  <span class="token comment">// 在父类的原型上绑定</span>
<span class="token comment">// tips：方法可以直接写在class中，属性需单独 prototype 赋值</span>

<span class="token keyword">class</span> <span class="token class-name">HTMLElement</span> <span class="token keyword">extends</span> <span class="token class-name">Element</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Element</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getAttribute<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">HTMLElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getAttribute<span class="token punctuation">)</span>


<span class="token comment">// E.G. </span>
<span class="token comment">// 检测 document.getElementByTagName(&#39;*&#39;) 输出HTMLCollection数组</span>
<span class="token comment">// 及数组内元素的 方法 get 属性 Symbol(Symbol.iterator) 类型 symbol（补充后发现调用了_elements）</span>
<span class="token comment">// 补 _elements = [] 后</span>
<span class="token comment">// 控制台输出 HTMLCollection{_elements:Array(0)} 中元素的属性 `(0)[]`，说明取了HTMLCollection._elements[0]。具体属性需要补对象后通过代理确定</span>
<span class="token keyword">function</span> <span class="token function">HTMLCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_elements<span class="token operator">=</span><span class="token punctuation">[</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token comment">// 通过代理查看 检测了 _elements[0] 的属性 TagName</span>
    
    <span class="token comment">// 浏览器 document.getElementByTagName(&#39;*&#39;) 的第一个元素是html标签，查看其 TagName 为 HTML</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_elements<span class="token operator">=</span><span class="token punctuation">[</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HTMLHtmlElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> 
    <span class="token comment">// 然后HTMLHtmlElement中添加tagName this.tagName = &#39;HTML&#39;</span>

<span class="token punctuation">}</span>
<span class="token class-name">HTMLDocument</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getElementByTagName</span> <span class="token operator">=</span> <span class="token keyword">function</span>  <span class="token function">getElementByTagName</span><span class="token punctuation">(</span><span class="token parameter">tagName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName <span class="token operator">==</span> <span class="token string">&#39;*&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 触发 getElementByTagName(&#39;*&#39;) 检测时，返回一个HTMLCollection</span>
        <span class="token keyword">return</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HTMLCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;HTMLCollection_obj&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token class-name">HTMLCollection</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// prompt: 不引入库，在 function HTMLCollection() {} 基础上实现属性 Symbol(Symbol.iterator)</span>
    <span class="token comment">// 异常时把代码copy并让其修改</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> elements <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_elements<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token literal-property property">value</span><span class="token operator">:</span> elements<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">done</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>


<span class="token comment">// E.G. then属性报错 -&gt; 调用 then 的 Promise 对象。补 Promise ()。此处示例 navigator.permissions.query</span>
<span class="token comment">// 0. 先发现navigator.permissions undefined</span>
<span class="token function-variable function">Permissions</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Permissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token class-name">Navigator</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>permissions <span class="token operator">=</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Permissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function-variable function">PermissionStatus</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">PermissionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 1.3</span>
<span class="token comment">// 1. 补完后发现寻找 navigator.permissions 中的 query ，浏览器查看 navigator.permissions.query  是函数</span>
<span class="token comment">// 补完 query 发现 query 中没有 then，通过浏览器控制台发现 query 函数返回了 Promise 对象，then 关键字也可以印证 query 返回了 Promise 对象</span>
<span class="token class-name">Permission</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">query</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 1.2 Promise 不正常打印，可能是需要入参，增加参数输出</span>
console<span class="token punctuation">.</span>log（<span class="token string">&#39;Permissions.prototype.query 参数：&#39;</span><span class="token punctuation">,</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>）
<span class="token comment">// 1.1 resolve 内容需要通过浏览器控制台注入确定。代码断点时状态为pending，需要跳过断点，使请求正常响应，触发回调</span>
<span class="token comment">// navigator.permissions.query().then(res=&gt;console.log(res) </span>
<span class="token comment">// 1.3 得到参数后修改注入代码。这里假设入参为字符串&#39;in_params&#39; ，navigator.permissions.query(&#39;in_params&#39;).then(res=&gt;console.log(res) </span>
<span class="token comment">// 得到响应为 PermissionStatus 对象</span>
<span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>watch <span class="token keyword">new</span> <span class="token class-name">PermissionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
<span class="token punctuation">}</span>
<span class="token comment">// 浏览器控制台使用此代码测试 then ，需要释放断点，使 Promise 从 pending 状态变为结束状态，从而触发注入代码打印结果</span>
<span class="token comment">// navigator.permissions.query({name: camera}).then(res=&gt;console.log(res))</span>


<span class="token comment">// E.G. 补XMLHttpRequest</span>
<span class="token function-variable function">XMLHttpRequest</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">open</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">send</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setRequestHeader</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">addEventListener</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>一边补充，一边查看结果的长度。长度与加密函数长度一致时，可考虑进行下一步，函数调用</p></li></ul><h3 id="结果检测" tabindex="-1"><a class="header-anchor" href="#结果检测" aria-hidden="true">#</a> 结果检测</h3><ul><li><p>进行加密函数调用，验证结果。结果不正确需对代理打印的undefined进行补充（看情况补充，不是所有undefined都补充，此处通常是cookie或localStorage内读取某个内容）</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>navigator <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
navigator<span class="token punctuation">.</span>webdriver <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
navigator<span class="token punctuation">.</span>userAgent <span class="token operator">=</span> <span class="token string">&#39;...&#39;</span><span class="token punctuation">;</span>
navigator<span class="token punctuation">.</span>plateform <span class="token operator">=</span> <span class="token string">&#39;Win32&#39;</span><span class="token punctuation">;</span>

<span class="token comment">// window.location 浏览器console直接location</span>
location <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// window.localStorage</span>
localStorage <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
localStorage <span class="token operator">=</span> <span class="token function">getProxy</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">,</span> <span class="token string">&quot;localStorage&quot;</span><span class="token punctuation">)</span> 
localStorage<span class="token punctuation">.</span><span class="token function-variable function">getItem</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;localStorage getItem&#39;</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment">// getItem获取对应值时undefined，根据if返回对应值</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>自执行。加密通常为自执行，仍不成功，考虑自执行，查看是否有特殊的undefined内容进行补充 - 此处通过代理得到的代码逻辑是<code>document.createElement(&#39;canvas&#39;)</code>, 然后调用了<code>canvas.getContext(&quot;webgl&quot;)</code>，此时的执行结果为undefined，需要补充</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>document <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;createElement&quot;</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;document createElement &quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token operator">==</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token function-variable function">getContext</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>arg <span class="token operator">==</span> <span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;webgl&quot;</span><span class="token punctuation">)</span>  <span class="token comment">// 在浏览器得到webgl是第一个对象，需要补充</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span>  
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h2 id="tostring检测" tabindex="-1"><a class="header-anchor" href="#tostring检测" aria-hidden="true">#</a> toString检测</h2><p>一些环境会对内置函数进行检测。以 <code>createElement</code> 为例，console打印的内容</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>document<span class="token punctuation">.</span>createElement<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 浏览器环境输出： &#39;function createElement() { [native code] }&#39;</span>
<span class="token comment">// 手动补环境输出： &#39;function createElement() {}&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过函数使补充内容的toString返回与浏览器一样拥有 <code>native code</code> 标志。一般将所有自定义函数（包括构造函数）都使用此函数进行保护 <a href="https://www.cnblogs.com/xiaohai123/p/19068874" target="_blank" rel="noopener noreferrer">代码来源<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">safeFunction</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">safeFunction</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//处理安全函数</span>
    <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$call <span class="token operator">=</span> <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>call<span class="token punctuation">;</span>
    <span class="token keyword">const</span> $toString <span class="token operator">=</span> Function<span class="token punctuation">.</span>toString<span class="token punctuation">;</span>
    <span class="token keyword">const</span> myFunction_toString_symbol <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&#39;(&#39;</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;)&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">const</span> <span class="token function-variable function">myToString</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">myToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">typeof</span> <span class="token keyword">this</span> <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">[</span>myFunction_toString_symbol<span class="token punctuation">]</span> <span class="token operator">||</span> $toString<span class="token punctuation">.</span><span class="token function">$call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">const</span> <span class="token function-variable function">set_native</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">set_native</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token string-property property">&quot;enumerable&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string-property property">&quot;configurable&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token string-property property">&quot;writable&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token string-property property">&quot;value&quot;</span><span class="token operator">:</span> value
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">delete</span> <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span><span class="token string">&#39;toString&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">set_native</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">&quot;toString&quot;</span><span class="token punctuation">,</span> myToString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_native</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">,</span> myFunction_toString_symbol<span class="token punctuation">,</span> <span class="token string">&quot;function toString() { [native code] }&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">const</span> <span class="token function-variable function">safe_Function</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">safe_Function</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">set_native</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> myFunction_toString_symbol<span class="token punctuation">,</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>func<span class="token punctuation">.</span>name <span class="token operator">?</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> func<span class="token punctuation">.</span>name <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;() { [native code] }&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token function">safe_Function</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用示例</span>
window<span class="token punctuation">.</span><span class="token function-variable function">addEventListener</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token function">safeFunction</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>addEventListener<span class="token punctuation">)</span>
<span class="token comment">// 本地node环境执行时，在后续代码处断点，控制台输入 window.addEventListener.toString() 查看是否成功加入[native code]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div id="comment" class="giscus-wrapper input-top" style="display:block;" data-v-77edf713><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div></div><!--]--><footer class="page_footer" data-v-2c01bf66><div class="footer_middle card_border" data-v-2c01bf66><!--[--><span data-v-2c01bf66>Released under the MIT License. <br data-v-2c01bf66></span><span data-v-2c01bf66>Copyright © 2023-present Leopold <br data-v-2c01bf66></span><!--]--></div></footer></div></div></div></div><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-101bb220.js" defer></script>
  </body>
</html>
